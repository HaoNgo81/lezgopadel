<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LezGo — Training (v2)</title>
  <meta name="theme-color" content="#0f1720" id="meta-theme-color" />
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="ICON-192x192.png" sizes="192x192">
  <style>
    /* minimal, performant styles (kept theme vars) */
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%;margin:0;padding:0;font-family:Inter,system-ui,Arial,sans-serif;-webkit-font-smoothing:antialiased}
    :root{
      --bg-top:#0f1720;--bg-bottom:#071226;--panel:#0b1a25;--muted:#9aa7b3;--text:#e6eef6;--accent:#22c55e;--border-soft:rgba(255,255,255,.04)
    }
    body.light{--bg-top:#caced5;--bg-bottom:#bfc3cb;--panel:#d8dce3;--muted:#3c4652;--text:#0b1220}
    .app-bg{min-height:100vh;background:linear-gradient(180deg,var(--bg-top),var(--bg-bottom));color:var(--text);padding:12px}
    .container{max-width:1100px;margin:0 auto}
    header{display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:12px}
    #logo{max-width:420px;height:auto;display:block}
    .controls{margin-left:auto;display:flex;gap:8px;align-items:center}
    .btn{border:0;padding:8px 12px;border-radius:10px;cursor:pointer;background:transparent;color:var(--text)}
    .btn-primary{background:var(--accent);color:#05261a;font-weight:700}
    .card{background:var(--panel);padding:12px;border-radius:10px;box-shadow:0 8px 20px rgba(2,6,23,.5)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:700px){.grid{grid-template-columns:1fr}}
    input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid var(--border-soft);background:transparent;color:var(--text)}
    .two-column{display:grid;grid-template-columns:1fr 360px;gap:12px}
    @media(max-width:980px){.two-column{grid-template-columns:1fr}}
    .exercise{display:flex;gap:10px;padding:8px;border-radius:8px;border:1px solid var(--border-soft);align-items:flex-start}
    .tag{background:rgba(255,255,255,.03);padding:4px 6px;border-radius:6px;margin-right:6px;font-size:12px}
    .badge{background:rgba(255,255,255,.04);padding:6px 8px;border-radius:8px;font-weight:700;color:var(--muted);margin-right:6px}
    #list{max-height:420px;overflow:auto}
  </style>
</head>
<body class="app-bg">
  <div class="container">
    <header>
      <img id="logo" src="lezgo-logo.svg" alt="LezGo logo">
      <div class="controls">
        <select id="lang-select"><option value="da">Dansk</option><option value="en">English</option></select>
        <button id="btn-buy" class="btn btn-primary">Buy</button>
        <button id="btn-admin" class="btn">Admin</button>
        <button id="theme-toggle" class="btn">Theme</button>
      </div>
    </header>

    <section class="card" aria-labelledby="form-title">
      <h3 id="form-title" style="margin:0 0 8px 0;color:var(--muted)">Add / Edit exercise</h3>
      <form id="exercise-form" class="grid" onsubmit="return false;">
        <div style="grid-column:1/-1"><input id="title" placeholder="Title" /></div>
        <div><select id="category"></select></div>
        <div><select id="players"></select></div>
        <div><input id="duration" type="number" min="0" placeholder="Duration (min)"></div>
        <div><select id="level"></select></div>
        <div><select id="intensity"></select></div>
        <div style="grid-column:1/-1"><input id="link" placeholder="Video link"></div>
        <div style="grid-column:1/-1"><textarea id="description" placeholder="Description"></textarea></div>
        <div style="grid-column:1/-1"><input id="tags" placeholder="Tags (comma)"></div>
        <div style="grid-column:1/-1;display:flex;gap:8px;justify-content:space-between">
          <div style="display:flex;gap:8px">
            <button id="save-btn" class="btn btn-primary">Save</button>
            <button id="clear-btn" class="btn">Clear</button>
          </div>
          <button id="delete-all-btn" class="btn" style="background:transparent;color:tomato">Delete all</button>
        </div>
      </form>
    </section>

    <section class="card" style="margin-top:12px">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
        <input id="search" placeholder="Search..." style="flex:1">
        <select id="filter-category"><option>ALL</option></select>
        <select id="filter-level"><option>ALL</option></select>
        <button id="show-favorites" class="btn">Favs</button>
      </div>

      <div class="two-column">
        <div>
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
            <button id="select-all" class="btn">Select all</button>
            <button id="add-selected" class="btn btn-primary">Add</button>
            <div id="selected-count" style="margin-left:auto">0 selected</div>
          </div>

          <div id="list" aria-live="polite"></div>
          <div id="load-more-wrap" style="text-align:center;padding:10px 0;display:none"><button id="load-more" class="btn">Load more</button></div>
        </div>

        <aside class="card">
          <h4 style="margin:0">Session Builder</h4>
          <label>Session name</label><input id="session-name">
          <label style="margin-top:8px">Exercises</label><div id="session-items" style="max-height:220px;overflow:auto"></div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
            <div>Total: <span id="session-total" style="font-weight:700">0 m</span></div>
            <div style="margin-left:auto" id="session-count">0</div>
          </div>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button id="save-session" class="btn btn-primary">Save</button>
            <button id="clear-session" class="btn">Clear</button>
          </div>
          <div id="session-lock-info" style="margin-top:12px;color:var(--muted);display:none">Free users cannot save sessions</div>
          <hr style="border:none;border-top:1px solid var(--border-soft);margin:12px 0">
          <h4>Saved sessions</h4><div id="sessions-list" style="max-height:200px;overflow:auto"></div>
        </aside>
      </div>
    </section>
  </div>

  <!-- admin modal omitted for brevity in this snippet -->

  <script>
    /* ============ CONFIG (short keys for speed) ============ */
    const ADMIN_PASSWORD = "admin123";
    const K = { EX:"lz_ex_v2", CAT:"lz_cat_v2", LVL:"lz_lvl_v2", INT:"lz_int_v2", PLR:"lz_plr_v2", SES:"lz_ses_v2", THEME:"lz_theme_v2" };

    const DEFAULTS = {
      CATS:["Back wall","Bandeja","Chiquita","Defense","Double wall","Groundstroke","Lob","Serve","Smash","Vibora","Volley"].sort(),
      LVLS:["Beginner","Intermediate","Advanced"],
      INT:["Low","Medium","High"],
      PLRS:["1","2","3","4","1-2","1-3","1-4","2-4","Any","Add new..."]
    };

    /* ============ STATE (cached DOM refs for perf) ============ */
    let exercises = [], categories = [], levels = [], intensities = [], players = [], sessions = [];
    let editingId = null, selectedIds = new Set(), renderedCount = 0;
    const EL = id => document.getElementById(id);
    const refs = {
      list: EL('list'), search: EL('search'), filterCategory: EL('filter-category'),
      filterLevel: EL('filter-level'), loadMoreWrap: EL('load-more-wrap'), loadMoreBtn: null,
      selectedCount: EL('selected-count'), sessionItems: EL('session-items'), sessionTotal: EL('session-total'),
      sessionCount: EL('session-count')
    };

    /* small util */
    const uid = ()=> "id_"+Math.random().toString(36).slice(2,9);
    const save = (k,v)=> localStorage.setItem(k, JSON.stringify(v));
    const load = (k, fallback)=> JSON.parse(localStorage.getItem(k) || JSON.stringify(fallback));

    /* ============ INIT ============ */
    function init(){
      applyTheme(localStorage.getItem(K.THEME) || 'dark');
      exercises = load(K.EX, []);
      categories = load(K.CAT, DEFAULTS.CATS);
      levels = load(K.LVL, DEFAULTS.LVLS);
      intensities = load(K.INT, DEFAULTS.INT);
      players = load(K.PLR, DEFAULTS.PLRS);
      sessions = load(K.SES, []);
      populateControls();
      bindEvents();
      renderList(true); // initial render
      updateBadges();
      updateSessionLock();
    }

    /* ============ UI POPULATE ============ */
    function populateSelect(selEl, arr, includeAdd=false){
      selEl.innerHTML = '';
      arr.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; selEl.appendChild(o); });
      if(includeAdd){ const a=document.createElement('option'); a.value='__ADD__'; a.textContent='Add new...'; selEl.appendChild(a);}
    }
    function populateControls(){
      populateSelect(EL('category'), categories, true);
      populateSelect(EL('level'), levels, true);
      populateSelect(EL('intensity'), intensities, true);
      populateSelect(EL('players'), players, true);
      // filters
      EL('filter-category').innerHTML = '<option>ALL</option>' + categories.map(c=>`<option>${c}</option>`).join('');
      EL('filter-level').innerHTML = '<option>ALL</option>' + levels.map(l=>`<option>${l}</option>`).join('');
      refs.loadMoreBtn = createLoadMoreButton();
    }

    function createLoadMoreButton(){
      const btn = document.createElement('button');
      btn.id = 'load-more';
      btn.className = 'btn';
      btn.textContent = 'Load more';
      btn.addEventListener('click', ()=> { renderList(false, true); });
      EL('load-more-wrap').appendChild(btn);
      return btn;
    }

    /* ============ EVENTS (delegation + debounced search) ============ */
    function bindEvents(){
      EL('theme-toggle').addEventListener('click', toggleTheme, {passive:true});
      EL('btn-admin').addEventListener('click', ()=> {
        const p = prompt('Admin password:');
        if(p===ADMIN_PASSWORD){ localStorage.setItem('is_admin','1'); updateBadges(); updateSessionLock(); alert('Admin on'); }
        else alert('Wrong');
      });

      EL('btn-buy').addEventListener('click', ()=> {
        if(localStorage.getItem('is_paid')){ if(confirm('Disable paid?')){ localStorage.removeItem('is_paid'); updateBadges(); updateSessionLock(); } }
        else { if(confirm('Simulate purchase?')){ localStorage.setItem('is_paid','1'); updateBadges(); updateSessionLock(); } }
      });

      // form actions
      EL('save-btn').addEventListener('click', onSave);
      EL('clear-btn').addEventListener('click', clearForm);
      EL('delete-all-btn').addEventListener('click', ()=>{ if(confirm('Delete ALL exercises?')){ exercises=[]; save(K.EX,exercises); clearList(); }});

      // filters and search (debounced)
      refs.search.addEventListener('input', debounce(()=>{ renderedCount=0; renderList(true); }, 220));
      refs.filterCategory.addEventListener('change', ()=>{ renderedCount=0; renderList(true); });
      refs.filterLevel.addEventListener('change', ()=>{ renderedCount=0; renderList(true); });

      EL('show-favorites').addEventListener('click', e=>{ e.target.textContent = e.target.textContent === 'Favs' ? 'All' : 'Favs'; renderedCount=0; renderList(true); });

      // list delegation for edit/delete/select
      refs.list.addEventListener('click', e=>{
        const row = e.target.closest('.exercise');
        if(!row) return;
        const id = row.dataset.id;
        if(e.target.dataset.action === 'edit'){ editItem(id); return; }
        if(e.target.dataset.action === 'delete'){ if(confirm('Delete?')){ exercises = exercises.filter(x=>x.id!==id); save(K.EX,exercises); renderList(true);} return; }
        if(e.target.type === 'checkbox'){ updateSelectedSet(); return; }
      });

      EL('select-all').addEventListener('click', ()=>{ refs.list.querySelectorAll('.sel').forEach(cb=>cb.checked=true); updateSelectedSet(); });
      EL('add-selected').addEventListener('click', addSelectedToSession);
      EL('save-session').addEventListener('click', saveSession);
      EL('clear-session').addEventListener('click', clearSessionBuilder);
    }

    /* ============ SAVE / FORM ============ */
    function onSave(){
      const title = EL('title').value.trim(); if(!title){ alert('Enter title'); return; }
      const ex = {
        id: editingId || uid(),
        title,
        category: EL('category').value,
        players: EL('players').value,
        duration: Number(EL('duration').value||0),
        level: EL('level').value,
        intensity: EL('intensity').value,
        link: EL('link').value.trim(),
        description: EL('description').value.trim(),
        tags: normalizeTags(EL('tags').value),
        favorite:false
      };
      if(editingId){ const i = exercises.findIndex(x=>x.id===editingId); if(i>-1) exercises[i]=ex; }
      else exercises.unshift(ex);
      save(K.EX,exercises);
      clearForm();
      renderedCount = 0;
      renderList(true);
    }
    function normalizeTags(s){ return (s||'').split(',').map(t=>t.replace(/^#+/,'').trim()).filter(Boolean).join(', '); }
    function clearForm(){ editingId=null; ['title','link','description','tags','duration'].forEach(id=>EL(id).value=''); EL('category').selectedIndex=0; EL('players').selectedIndex=0; EL('level').selectedIndex=0; EL('intensity').selectedIndex=0; EL('save-btn').textContent='Save'; }

    /* ============ RENDER LIST (incremental / fragment) ============ */
    function clearList(){ refs.list.innerHTML=''; refs.loadMoreWrap.style.display='none'; refs.selectedCount.textContent='0 selected'; }
    function renderList(reset=true, append=false){
      // prepare filtered items
      const q = refs.search.value.trim().toLowerCase();
      const fc = refs.filterCategory.value, fl = refs.filterLevel.value;
      let items = exercises.slice();
      if(fc && fc!=='ALL') items = items.filter(x=>x.category===fc);
      if(fl && fl!=='ALL') items = items.filter(x=>x.level===fl);
      if(q) items = items.filter(x => x.title.toLowerCase().includes(q) || (x.description||'').toLowerCase().includes(q) || (x.tags||'').toLowerCase().includes(q));
      if(EL('show-favorites').textContent==='All') items = items.filter(x=>x.favorite);

      // incremental rendering: show in chunks
      const CHUNK = 40;
      if(reset){ refs.list.innerHTML=''; renderedCount = 0; }
      const frag = document.createDocumentFragment();
      const slice = items.slice(renderedCount, renderedCount + CHUNK);
      slice.forEach(ex=>{
        const row = document.createElement('div'); row.className='exercise'; row.dataset.id=ex.id;
        row.innerHTML = `
          <input class="sel" type="checkbox" aria-label="select">
          <div style="flex:1">
            <div style="font-weight:700">${escapeHtml(ex.title)}</div>
            <div style="color:var(--muted)">${ex.duration}m • ${escapeHtml(ex.category)} • ${escapeHtml(ex.level)}</div>
            ${ex.tags? '<div style="margin-top:6px">'+ ex.tags.split(',').map(t=>'<span class="tag">'+escapeHtml(t.trim())+'</span>').join('') +'</div>':''}
          </div>
          <div style="display:flex;flex-direction:column;gap:6px">
            <button class="btn" data-action="edit">Edit</button>
            <button class="btn" data-action="delete" style="color:tomato">Delete</button>
          </div>`;
        frag.appendChild(row);
      });
      refs.list.appendChild(frag);
      renderedCount += slice.length;

      // show load more if exists
      if(renderedCount < items.length){ refs.loadMoreWrap.style.display='block'; } else refs.loadMoreWrap.style.display='none';

      if(renderedCount===0){ refs.list.innerHTML = '<div style="color:var(--muted)">No matches</div>'; refs.loadMoreWrap.style.display='none'; }
      updateSelectedSet();
    }

    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    /* ============ SELECTION / SESSION ============ */
    function updateSelectedSet(){
      selectedIds.clear();
      refs.list.querySelectorAll('.sel').forEach(cb=>{ if(cb.checked) selectedIds.add(cb.closest('.exercise').dataset.id); });
      refs.selectedCount.textContent = selectedIds.size + ' selected';
    }

    function addSelectedToSession(){
      if(!isPaid() && !isAdmin()){ alert('Paid required'); return; }
      selectedIds.forEach(id=>{
        if(refs.sessionItems.querySelector(`[data-id="${id}"]`)) return;
        const ex = exercises.find(x=>x.id===id); if(!ex) return;
        const row = document.createElement('div'); row.className='exercise'; row.dataset.id=id;
        row.innerHTML = `<div style="flex:1"><div style="font-weight:700">${escapeHtml(ex.title)}</div><div style="color:var(--muted)">${ex.duration}m • ${escapeHtml(ex.category)}</div></div><button class="btn" data-action="remove" style="color:tomato">Remove</button>`;
        row.querySelector('[data-action="remove"]').addEventListener('click', ()=>{ row.remove(); recalcSession(); });
        refs.sessionItems.appendChild(row);
      });
      recalcSession();
    }

    function recalcSession(){ let total=0,count=0; refs.sessionItems.querySelectorAll('.exercise').forEach(r=>{ const ex = exercises.find(x=>x.id===r.dataset.id); if(ex){ total += ex.duration; count++; }}); refs.sessionTotal.textContent = total + ' m'; refs.sessionCount.textContent = count; }

    function clearSessionBuilder(){ refs.sessionItems.innerHTML=''; EL('session-name').value=''; recalcSession(); }
    function saveSession(){
      if(!isPaid() && !isAdmin()){ alert('Paid required'); return; }
      const name = EL('session-name').value.trim(); if(!name){ alert('Add name'); return; }
      const ids = Array.from(refs.sessionItems.querySelectorAll('.exercise')).map(r=>r.dataset.id);
      const total = ids.reduce((a,id)=>{ const e = exercises.find(x=>x.id===id); return a + (e?e.duration:0); },0);
      sessions.unshift({id:uid(), name, items:ids, total});
      save(K.SES, sessions);
      renderSessions();
      clearSessionBuilder();
    }
    function renderSessions(){
      const box = EL('sessions-list'); box.innerHTML = '';
      if(!sessions.length){ box.innerHTML = '<div style="color:var(--muted)">No sessions</div>'; return; }
      sessions.forEach(s=>{
        const div = document.createElement('div'); div.className='exercise';
        div.innerHTML = `<div style="flex:1"><div style="font-weight:800">${escapeHtml(s.name)}</div><div style="color:var(--muted)">${s.items.length} • ${s.total}m</div></div>
          <div style="display:flex;gap:6px"><button class="btn" data-open>Open</button><button class="btn" data-del style="color:tomato">Delete</button></div>`;
        div.querySelector('[data-del]').addEventListener('click', ()=>{ if(confirm('Delete session?')){ sessions = sessions.filter(x=>x.id!==s.id); save(K.SES,sessions); renderSessions(); }});
        box.appendChild(div);
      });
    }

    /* ============ EDIT ITEM ============ */
    function editItem(id){
      const ex = exercises.find(x=>x.id===id); if(!ex) return;
      editingId = id;
      EL('title').value = ex.title; EL('category').value = ex.category; EL('players').value = ex.players; EL('duration').value = ex.duration;
      EL('level').value = ex.level; EL('intensity').value = ex.intensity; EL('link').value = ex.link; EL('description').value = ex.description; EL('tags').value = ex.tags;
      EL('save-btn').textContent = 'Save changes';
      window.scrollTo({top:0,behavior:'smooth'});
    }

    /* ============ BADGES / LOCKS / UTIL ============ */
    function updateBadges(){
      // lightweight: show in console (UI badge omitted to keep DOM light)
      console.log('isAdmin:', isAdmin(), 'isPaid:', isPaid());
    }
    function updateSessionLock(){ const locked = (!isPaid() && !isAdmin()); EL('save-session').disabled = locked; EL('add-selected').disabled = locked; EL('session-lock-info').style.display = locked ? 'block' : 'none'; }
    function isAdmin(){ return localStorage.getItem('is_admin') === '1'; }
    function isPaid(){ return localStorage.getItem('is_paid') === '1'; }

    /* ============ THEME ============ */
    function applyTheme(t){ if(t==='light'){ document.body.classList.add('light'); EL('meta-theme-color').setAttribute('content','#eceff1'); } else { document.body.classList.remove('light'); EL('meta-theme-color').setAttribute('content','#0f1720'); } localStorage.setItem(K.THEME,t); }
    function toggleTheme(){ applyTheme(document.body.classList.contains('light') ? 'dark' : 'light'); }

    /* ============ HELPERS ============ */
    function debounce(fn, t=200){ let to; return (...a)=>{ clearTimeout(to); to = setTimeout(()=>fn(...a), t); }; }
    function isAdmin(){ return localStorage.getItem('is_admin') === '1'; }

    /* ============ BOOTSTRAP ============ */
    init();
  </script>
</body>
</html>
