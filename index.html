<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LezGo App v3 — Backup & Restore (demo)</title>
  <style>
    :root{
      --accent:#0561d2;
      --accent2:#0b8f5a;
      --card-bg:#fff;
      --muted:#666;
      --max-w:980px;
    }
    body{
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin:0;
      padding:24px 16px 120px; /* plads til bottom bar */
      background:#f4f6f9;
      color:#111;
    }
    header{ max-width:var(--max-w); margin:0 auto 18px; }
    h1{ margin:0 0 6px; font-size:20px }
    p.lead{ margin:0 0 14px; color:var(--muted) }

    .container{ max-width:var(--max-w); margin:0 auto; display:grid; gap:12px; }

    .card{ background:var(--card-bg); padding:14px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    .small{ font-size:13px; color:var(--muted); }
    .btn{ padding:.6rem .9rem; border-radius:8px; border:0; cursor:pointer; font-weight:600; background:var(--accent); color:#fff; box-shadow:0 6px 14px rgba(5,97,210,0.12); }
    .btn.alt{ background:var(--accent2); box-shadow:0 6px 14px rgba(11,143,90,0.12); }
    .btn.ghost{ background:transparent; border:1px solid #ddd; color:#222; box-shadow:none; font-weight:600; padding:.45rem .75rem; }

    ul.list{ list-style:none; padding:0; margin:0; display:grid; gap:8px; }
    li.item{ display:flex; justify-content:space-between; gap:12px; padding:10px; border-radius:8px; background:#fafafa; border:1px solid #eee; align-items:center; }
    .meta{ color:var(--muted); font-size:13px; }
    .actions{ display:flex; gap:8px; }

    /* BUND BAR (fast) */
    #lezgo-bottom-bar{
      position: fixed;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      width: calc(100% - 32px);
      max-width: var(--max-w);
      display:flex;
      gap:12px;
      justify-content: center;
      align-items: center;
      padding: 10px;
      background: rgba(255,255,255,0.98);
      box-shadow: 0 12px 34px rgba(0,0,0,0.12);
      border-radius: 12px;
      z-index: 9999;
    }
    #lezgo-bottom-bar .lezgo-btn {
      padding: .6rem 1rem;
      border-radius: 10px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.08);
      background: var(--accent);
      color: white;
    }
    #lezgo-bottom-bar .lezgo-btn.file { background: var(--accent2); }
    #lezgo-bottom-bar input[type=file]{ display:none; }

    /* Dark theme */
    @media (prefers-color-scheme: dark){
      body{ background:#0f1113; color:#e6eefb; }
      .card{ background:#0b0c0d; box-shadow:none; border:1px solid rgba(255,255,255,0.03); }
      #lezgo-bottom-bar{ background: rgba(8,8,8,0.92); }
    }

    footer.smallnote{ max-width:var(--max-w); margin:18px auto 100px; color:var(--muted); font-size:13px; }
  </style>
</head>
<body>
  <header>
    <h1>LezGo App v3 — Backup & Restore</h1>
    <p class="lead">Demo: gemte sessions & video-links. App starter i <strong>guest mode</strong>. Admin kan logge ind og få <em>Log ud</em>-knap i bundbaren.</p>
  </header>

  <main class="container">
    <!-- STATUS CARD -->
    <section class="card" id="statusCard">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="small">Mode:</div>
          <strong id="modeLabel">Guest</strong>
          <div class="small" style="margin-top:6px;">Gemte sessions: <span id="countSessions">0</span> · Gemte videoer: <span id="countVideos">0</span></div>
        </div>
        <div class="row">
          <button class="btn ghost" id="btn-sim-admin">Simuler admin login</button>
          <button class="btn" id="btn-sample-data">Indsæt sample data</button>
          <button class="btn alt" id="btn-clear-storage">Slet lokal data</button>
        </div>
      </div>
    </section>

    <!-- SESSIONS -->
    <section class="card">
      <h3 style="margin:0 0 8px;">Gemt sessions</h3>
      <ul id="sessionsList" class="list"></ul>
    </section>

    <!-- VIDEOS -->
    <section class="card">
      <h3 style="margin:0 0 8px;">Gemte video-links</h3>
      <ul id="videosList" class="list"></ul>
    </section>

    <footer class="smallnote">
      Tip: Brug <strong>Backup</strong> i bundbaren for at downloade .json. Brug <strong>Restore</strong> for at uploade en tidligere backup. Restore vil merge uden duplikater (sessions efter id, videoer efter url).
    </footer>
  </main>

  <!-- BUNDT BAR -->
  <div id="lezgo-bottom-bar" aria-hidden="false">
    <button id="btn-backup" class="lezgo-btn">Backup</button>
    <label for="file-restore" class="lezgo-btn file" id="btn-restore-label" style="cursor:pointer">Restore</label>
    <input id="file-restore" type="file" accept="application/json" />
    <button id="btn-open-session-log" class="lezgo-btn">Ses. log</button>
    <button id="btn-logout" class="lezgo-btn" style="display:none">Log ud</button>
  </div>

  <script>
    /************************************************************************
     * LezGo App v3 - Complete in-file demo
     * - Backup / Restore
     * - Admin login simulation & logout
     * - Robust openSavedSession with fallback
     *
     * Tilpas STORAGE_* nøgler til din app hvis nødvendigt.
     **************************************************************************/

    // KONSTANTER / STORAGE NØGLER
    const STORAGE_SESSIONS_KEY = 'lezgo_savedSessions';
    const STORAGE_VIDEOS_KEY = 'lezgo_savedVideoLinks';
    const STORAGE_ADMIN_TOKEN = 'lezgo_admin_token'; // simpel sim
    let isAdmin = false; // app starter i guest mode

    // ---------- sample CRUD for localStorage ----------
    function loadLocalData() {
      try {
        const sessions = JSON.parse(localStorage.getItem(STORAGE_SESSIONS_KEY) || '[]');
        const videos = JSON.parse(localStorage.getItem(STORAGE_VIDEOS_KEY) || '[]');
        return { sessions, videos };
      } catch (err) {
        console.error('Fejl ved læsning af localStorage:', err);
        return { sessions: [], videos: [] };
      }
    }

    function saveLocalData({ sessions, videos }) {
      localStorage.setItem(STORAGE_SESSIONS_KEY, JSON.stringify(sessions));
      localStorage.setItem(STORAGE_VIDEOS_KEY, JSON.stringify(videos));
      renderUi();
    }

    // ---------- UI rendering ----------
    const sessionsList = document.getElementById('sessionsList');
    const videosList = document.getElementById('videosList');
    const countSessionsEl = document.getElementById('countSessions');
    const countVideosEl = document.getElementById('countVideos');
    const modeLabel = document.getElementById('modeLabel');
    const logoutBtn = document.getElementById('btn-logout');

    function renderUi() {
      const { sessions, videos } = loadLocalData();
      sessionsList.innerHTML = '';
      videosList.innerHTML = '';
      countSessionsEl.textContent = sessions.length;
      countVideosEl.textContent = videos.length;
      modeLabel.textContent = isAdmin ? 'Admin' : 'Guest';
      logoutBtn.style.display = isAdmin ? 'inline-block' : 'none';

      // sessions
      if (sessions.length === 0) {
        sessionsList.innerHTML = '<li class="item"><div class="meta">Ingen gemte sessions</div></li>';
      } else {
        sessions.forEach(s => {
          const li = document.createElement('li'); li.className = 'item';
          const left = document.createElement('div'); left.innerHTML = `<div><strong>${escapeHtml(s.title || 'Uden titel')}</strong></div><div class="meta">id: ${escapeHtml(s.id || '(ingen id)')}</div>`;
          const actions = document.createElement('div'); actions.className = 'actions';
          const openBtn = document.createElement('button'); openBtn.className='btn ghost'; openBtn.textContent='Åbn';
          openBtn.onclick = () => openSavedSession(s.id);
          const delBtn = document.createElement('button'); delBtn.className='btn'; delBtn.textContent='Slet';
          delBtn.onclick = () => {
            if (!confirm('Slet session?')) return;
            const cur = loadLocalData();
            saveLocalData({ sessions: cur.sessions.filter(x => x.id !== s.id), videos: cur.videos });
          };
          actions.appendChild(openBtn); actions.appendChild(delBtn);
          li.appendChild(left); li.appendChild(actions);
          sessionsList.appendChild(li);
        });
      }

      // videos
      if (videos.length === 0) {
        videosList.innerHTML = '<li class="item"><div class="meta">Ingen gemte videoer</div></li>';
      } else {
        videos.forEach(v => {
          const li = document.createElement('li'); li.className = 'item';
          const left = document.createElement('div'); left.innerHTML = `<div><strong>${escapeHtml(v.title || v.url)}</strong></div><div class="meta">${escapeHtml(v.url)}</div>`;
          const actions = document.createElement('div'); actions.className = 'actions';
          const openBtn = document.createElement('button'); openBtn.className='btn ghost'; openBtn.textContent='Åbn link';
          openBtn.onclick = () => { window.open(v.url, '_blank'); };
          const delBtn = document.createElement('button'); delBtn.className='btn'; delBtn.textContent='Slet';
          delBtn.onclick = () => {
            if (!confirm('Slet video-link?')) return;
            const cur = loadLocalData();
            saveLocalData({ sessions: cur.sessions, videos: cur.videos.filter(x => x.url !== v.url) });
          };
          actions.appendChild(openBtn); actions.appendChild(delBtn);
          li.appendChild(left); li.appendChild(actions);
          videosList.appendChild(li);
        });
      }
    }

    function escapeHtml(text) {
      if (!text && text !== 0) return '';
      return String(text).replace(/[&<>"']/g, function(m){ return ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]; });
    }

    // ---------- Toolbar: Backup ----------
    document.getElementById('btn-backup').addEventListener('click', () => {
      const data = loadLocalData();
      const meta = {
        createdAt: new Date().toISOString(),
        lezgoVersion: 'v3',
      };
      const payload = { meta, data };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `lezgo-backup-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    // ---------- Toolbar: Restore ----------
    document.getElementById('file-restore').addEventListener('change', async (ev) => {
      const file = ev.target.files && ev.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const parsed = JSON.parse(text);
        if (!parsed || !parsed.data) throw new Error('Ugyldigt backup-format (mangler data).');

        const incomingSessions = Array.isArray(parsed.data.sessions) ? parsed.data.sessions : [];
        const incomingVideos = Array.isArray(parsed.data.videos) ? parsed.data.videos : [];

        const current = loadLocalData();

        // merge sessions by id
        const sessionsById = new Map(current.sessions.map(s => [s.id, s]));
        incomingSessions.forEach(s => {
          if (!s || !s.id) {
            s = Object.assign({}, s, { id: s.id || `restored-${Date.now()}-${Math.random().toString(36).slice(2,8)}` });
          }
          sessionsById.set(s.id, s);
        });
        const mergedSessions = Array.from(sessionsById.values());

        // merge videos by url
        const videoSet = new Map(current.videos.map(v => [v.url, v]));
        incomingVideos.forEach(v => {
          if (v && v.url) videoSet.set(v.url, v);
        });
        const mergedVideos = Array.from(videoSet.values());

        saveLocalData({ sessions: mergedSessions, videos: mergedVideos });
        alert('Restore gennemført. Gemte sessions og videoer er opdateret.');
      } catch (err) {
        console.error('Restore-fejl:', err);
        alert('Fejl ved restore: ' + (err.message || err));
      } finally {
        ev.target.value = ''; // reset input
      }
    });

    // ---------- Toolbar: Session log (viser hele localData i console) ----------
    document.getElementById('btn-open-session-log').addEventListener('click', () => {
      const data = loadLocalData();
      console.log('LezGo localData:', data);
      alert('Session log skrevet til konsollen (F12).');
    });

    // ---------- Logout ----------
    document.getElementById('btn-logout').addEventListener('click', () => {
      try { localStorage.removeItem(STORAGE_ADMIN_TOKEN); } catch(e) {}
      isAdmin = false; renderUi();
      document.dispatchEvent(new CustomEvent('lezgo:mode-change', { detail: { isAdmin } }));
      alert('Du er logget ud. Appen kører nu i guest mode.');
    });

    // ---------- Simuler admin login (kun demo) ----------
    document.getElementById('btn-sim-admin').addEventListener('click', () => {
      // Simuler en login: sæt token i localStorage
      localStorage.setItem(STORAGE_ADMIN_TOKEN, 'demo-token-' + Date.now());
      isAdmin = true;
      renderUi();
      alert('Admin login simuleret. Log ud-knappen er synlig i bundbaren.');
    });

    // ---------- Clear storage / Sample data ----------
    document.getElementById('btn-clear-storage').addEventListener('click', () => {
      if (!confirm('Slet AL lokal data? Dette kan ikke fortrydes.')) return;
      localStorage.removeItem(STORAGE_SESSIONS_KEY);
      localStorage.removeItem(STORAGE_VIDEOS_KEY);
      renderUi();
      alert('Lokal data slettet.');
    });

    document.getElementById('btn-sample-data').addEventListener('click', () => {
      const samples = {
        sessions: [
          { id: 'sess-1', title: 'Træning - fokus på serve', payload: { links: ['https://youtu.be/example1'] }, createdAt: new Date().toISOString() },
          { id: 'sess-2', title: 'Kampoptagelse - dbl', payload: { links: ['https://youtu.be/example2', 'https://youtu.be/example3'] }, createdAt: new Date().toISOString() },
          // ældre format (ingen payload) for migrations-test
          { id: 'sess-old', title: 'Ældre session (legacy)', links: ['https://youtu.be/legacy1'], createdAt: new Date().toISOString() }
        ],
        videos: [
          { url: 'https://youtu.be/example1', title: 'Opvarmning - Drills' },
          { url: 'https://youtu.be/example2', title: 'Match highlights' }
        ]
      };
      saveLocalData(samples);
      alert('Sample data indsat.');
    });

    // ---------- Åbne gemt session (robust) ----------
    function openSavedSession(sessionId) {
      try {
        const { sessions } = loadLocalData();
        const session = sessions.find(s => s.id === sessionId);
        if (!session) {
          console.warn('Session ikke fundet:', sessionId);
          alert('Session ikke fundet eller er slettet.');
          return;
        }

        // Konverter ældre format hvis nødvendigt
        if (!session.payload && session.links && Array.isArray(session.links)) {
          session.payload = { links: session.links };
        }

        if (!session.payload || !Array.isArray(session.payload.links)) {
          console.error('Uventet session-format', session);
          alert('Session-formatet er ugyldigt. Prøv at restore fra backup eller kontakt support.');
          return;
        }

        // Active session flow: prøv at vise detaljeret view, ellers fallback
        setActiveSession(session);
      } catch (err) {
        console.error('Fejl ved åbning af session:', err);
        alert('Kunne ikke åbne sessionen. Se konsol for detaljer.');
      }
    }

    // Dummy setActiveSession — i din app skal du erstatte denne med faktisk navigation/state update
    function setActiveSession(session) {
      console.log('Aktiverer session:', session);
      if (!window.showDetailedSessionView) {
        // fallback modal / alert i stedet for "Coming soon"
        showFallbackDetail(session);
      } else {
        window.showDetailedSessionView(session);
      }
    }

    function showFallbackDetail(session) {
      const title = session.title || 'Gemt session';
      const links = (session.payload && session.payload.links) || [];
      const summary = `Session: ${title}\nLinks: ${links.length}\n\nLink-eksempel:\n${links[0] || 'Ingen links'}`;
      // Vis et mere detaljeret fallback (kan bygges ud til modal)
      alert(summary + '\n\n(Detaljeret visning er ikke tilgængelig i denne demo.)');
    }

    // ---------- INIT: hvis admin token i localStorage -> sæt admin ----------
    (function init(){
      try {
        const tok = localStorage.getItem(STORAGE_ADMIN_TOKEN);
        if (tok) isAdmin = true;
      } catch(e){}
      renderUi();
    })();

    // ---------- Ekstra: lyt på mode-change hvis andre dele af appen vil reagere ----------
    document.addEventListener('lezgo:mode-change', (ev) => {
      console.log('Mode changed:', ev.detail);
      // her kan du opdatere UI, router, tilladelser etc.
    });

    // ---------- sikkerhed: undgå læk af tokens i backup ----------
    // Hvis du har tokens i sessions eller videos, fjerner vi dem ved backup
    // (Eksempel: anonymiser fields 'token' eller 'auth')
    // Denne demo laver det ikke automatisk, men du bør fjerne følsomme data inden eksport i produktion.

  </script>
</body>
</html>
