<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>LezGo Padel ‚Äî Training Bank</title>
  <meta name="theme-color" content="#0f1720" id="meta-theme-color" />
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" href="ICON-192x192.png" sizes="192x192">

  <style>
    /* ---------- RESET & THEME ---------- */
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%;margin:0;padding:0;overflow-x:hidden}
    body{font-family:Inter,system-ui,Arial,sans-serif;-webkit-font-smoothing:antialiased;transition:background .2s,color .2s;background:linear-gradient(180deg,#0f1720 0%,#071226 100%);color:#e6eef6;padding-bottom:220px}
    :root{--panel:#0b1a25;--muted:#9aa7b3;--accent:#22c55e;--danger:#ef4444;--border-soft:rgba(255,255,255,.04);--max-w:1100px}
    body.light{background:linear-gradient(180deg,#caced5 0%,#bfc3cb 100%);color:#0b1220}

    .container{max-width:var(--max-w);margin:14px auto;padding:12px;width:94%}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    #logo{height:36px}

    .badges{display:flex;gap:8px;align-items:center}
    .badge{background:rgba(255,255,255,.04);padding:6px 10px;border-radius:8px;font-weight:700;color:var(--muted)}

    .btn{border:0;padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer;background:transparent;color:inherit;display:inline-flex;align-items:center;gap:8px}
    .btn-primary{background:var(--accent);color:#05261a}
    .btn-ghost{background:transparent;border:1px solid var(--border-soft);color:var(--muted);padding:10px 12px;border-radius:10px}
    .btn-danger{background:var(--danger);color:#fff;border-radius:10px}
    .btn-small{padding:6px 8px;border-radius:8px;font-weight:700}

    .card{background:var(--panel);border-radius:12px;padding:14px;margin-bottom:14px;box-shadow:0 10px 28px rgba(2,6,23,.6)}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=text],input[type=url],input[type=number],select,textarea{width:100%;padding:12px;border-radius:10px;border:1px solid var(--border-soft);background:transparent;color:inherit}
    textarea{min-height:84px;resize:vertical}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:680px){.grid{grid-template-columns:1fr}}

    .exercise{display:flex;gap:10px;padding:12px;border-radius:10px;border:1px solid var(--border-soft);align-items:flex-start;overflow:hidden}
    .exercise .left{flex:1;min-width:0}
    .exercise .meta{color:var(--muted);margin-top:8px}
    .tag{background:rgba(255,255,255,.03);padding:6px 8px;border-radius:8px;margin-right:8px;font-size:13px;display:inline-block;margin-top:8px}

    /* wrap long words/urls */
    .exercise, .exercise a, .exercise div { overflow-wrap:anywhere; word-break:break-word; hyphens:auto; }
    a { color:#2fa1ff; }

    .actions-small{display:flex;flex-direction:column;gap:8px;align-items:flex-end}
    .duplicate{border:2px solid var(--danger)!important;background:rgba(239,68,68,0.06)!important}

    /* bottom bar (admin/paid) - keeps above content */
    #lezgo-bottom-bar{position:fixed;bottom:12px;left:12px;right:12px;max-width:calc(var(--max-w)-24px);margin:0 auto;display:none;gap:12px;justify-content:center;align-items:center;padding:10px;border-radius:12px;z-index:99999;box-shadow:0 10px 28px rgba(0,0,0,0.16);background:linear-gradient(180deg,rgba(0,0,0,0.06),rgba(0,0,0,0.02))}
    #lezgo-bottom-bar .lezgo-btn{padding:.6rem .9rem;border-radius:10px;background:var(--accent);color:#05261a;font-weight:800;min-width:110px}
    #lezgo-bottom-bar .lezgo-btn.restore{background:transparent;border:1px solid var(--border-soft);color:inherit}

    .load-more{display:block;margin:8px auto;padding:8px 12px;border-radius:8px;border:1px solid var(--border-soft);background:transparent;color:var(--muted)}

    @media(max-width:520px){ .container{padding:10px 10px 260px} #lezgo-bottom-bar{left:10px;right:10px} .actions-small{align-items:flex-end} }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div style="display:flex;gap:12px;align-items:center">
        <img id="logo" src="lezgo-logo.svg" alt="LezGo logo">
        <div class="badges" id="badges"></div>
      </div>

      <div style="display:flex;gap:10px;align-items:center">
        <select id="lang-select" style="padding:8px;border-radius:8px;border:1px solid var(--border-soft);background:transparent;color:inherit" aria-label="Language select">
          <option value="da">Dansk</option>
          <option value="en">English</option>
        </select>

        <button id="btn-buy" class="btn btn-primary">K√∏b adgang</button>
        <button id="btn-admin" class="btn btn-ghost">Admin login</button>
        <button id="btn-logout-header" class="btn btn-ghost" style="display:none;color:var(--danger)">Log ud</button>
      </div>
    </header>

    <!-- Add / Edit -->
    <section class="card">
      <h3 style="margin:0 0 10px 0;color:var(--muted)">Tilf√∏j / Rediger √∏velse (Padel)</h3>

      <form id="exercise-form" class="grid" onsubmit="return false;">
        <div style="grid-column:1/-1;">
          <label>Titel</label>
          <input id="title" type="text" placeholder="f.eks. Forehand topspin drill" autocomplete="off">
        </div>

        <div>
          <label>Kategori</label>
          <select id="category"></select>
        </div>

        <div>
          <label>Spillere</label>
          <select id="players"></select>
        </div>

        <div>
          <label>Varighed (min)</label>
          <input id="duration" type="number" min="0" placeholder="20">
        </div>

        <div>
          <label>Niveau</label>
          <select id="level"></select>
        </div>

        <div>
          <label>Intensitet</label>
          <select id="intensity"></select>
        </div>

        <div style="grid-column:1/-1;">
          <label>Videolink (YouTube / Instagram / Facebook)</label>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="link" type="url" placeholder="https://..." style="flex:1" autocomplete="off">
            <button id="analyze-btn" class="btn btn-ghost">üîç Analyser</button>
          </div>
        </div>

        <div style="grid-column:1/-1;">
          <label>Beskrivelse</label>
          <textarea id="description" placeholder="Kort beskrivelse"></textarea>
        </div>

        <div style="grid-column:1/-1;">
          <label>Tags (kommasepareret)</label>
          <input id="tags" type="text" placeholder="fx Cross, Chiquita, Vibora">
        </div>

        <div style="grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;margin-top:8px">
          <div style="display:flex;gap:10px">
            <button id="save-btn" class="btn btn-primary">‚ûï Gem √∏velse</button>
            <button id="clear-btn" class="btn btn-ghost">Ryd</button>
          </div>
          <button id="delete-all-btn" class="btn btn-danger" style="display:none">üóëÔ∏è Slet alle</button>
        </div>
      </form>
    </section>

    <!-- List + Session Builder -->
    <section class="card">
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;align-items:center">
        <input id="search" type="text" placeholder="S√∏g..." style="flex:1;padding:10px;border-radius:10px;border:1px solid var(--border-soft);background:transparent;color:inherit">
        <div>
          <button id="pf-y" class="btn btn-ghost btn-small">YouTube</button>
          <button id="pf-i" class="btn btn-ghost btn-small">Instagram</button>
          <button id="pf-f" class="btn btn-ghost btn-small">Facebook</button>
        </div>
        <select id="filter-category" style="padding:10px;border-radius:10px;border:1px solid var(--border-soft);background:transparent;color:inherit"><option>ALL</option></select>
        <select id="filter-level" style="padding:10px;border-radius:10px;border:1px solid var(--border-soft);background:transparent;color:inherit"><option>ALL</option></select>
        <button id="show-favorites" class="btn btn-ghost">Vis favoritter</button>
      </div>

      <div class="two-column" style="display:grid;grid-template-columns:1fr 380px;gap:12px">
        <div>
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
            <!-- Removed bulk add/select -->
            <div style="margin-left:auto" id="selected-count">0 valgt</div>
          </div>

          <div id="list" style="min-height:120px"></div>
          <button id="load-more" class="load-more" style="display:none">Vis flere</button>
        </div>

        <aside class="card">
          <h4 style="margin:0">Training Session Builder</h4>

          <label>Sessionsnavn</label>
          <input id="session-name" type="text">

          <label style="margin-top:8px">Sessionsbeskrivelse</label>
          <input id="session-desc" type="text">

          <label style="margin-top:8px">√òvelser</label>
          <div id="session-items" style="max-height:240px;overflow:auto"></div>

          <div style="display:flex;gap:10px;align-items:center;margin-top:10px;">
            <div>Total:</div>
            <div id="session-total" style="font-weight:700">0 m</div>
            <div style="margin-left:auto" id="session-count">0 √∏velser</div>
          </div>

          <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
            <button id="save-session" class="btn btn-primary" style="display:none">Gem session</button>
            <button id="clear-session" class="btn btn-ghost" style="display:none">Ryd</button>
          </div>

          <div id="session-lock-info" style="margin-top:14px;color:var(--muted);display:none;">
            Gratis brugere kan ikke gemme eller bygge sessioner. K√∏b adgang for at l√•se op.
          </div>

          <hr style="border:none;border-top:1px solid var(--border-soft);margin:14px 0">
          <h4 style="margin:0 0 6px 0;">Gemte sessioner</h4>
          <div id="sessions-list" style="max-height:160px;overflow:auto"></div>
        </aside>
      </div>
    </section>
  </div><!-- container end -->

  <!-- Admin modal -->
  <div id="admin-modal" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:999">
    <div style="background:var(--panel);padding:14px;border-radius:10px;max-width:420px;width:92%">
      <h3 style="margin-top:0">Admin login</h3>
      <input id="admin-password" type="password" placeholder="Password" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border-soft);margin-bottom:12px">
      <div style="display:flex;gap:12px;justify-content:flex-end">
        <button id="admin-cancel" class="btn btn-ghost">Annuller</button>
        <button id="admin-submit" class="btn btn-primary">Login</button>
      </div>
    </div>
  </div>

  <!-- Confirm modal -->
  <div id="confirm-modal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:100000">
    <div style="background:var(--panel);padding:18px;border-radius:12px;max-width:420px;width:92%;box-shadow:0 20px 60px rgba(0,0,0,0.6)">
      <h3 id="confirm-title">Bekr√¶ft</h3>
      <p id="confirm-message" style="color:var(--muted)">Er du sikker?</p>
      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button id="confirm-no" class="btn btn-ghost">Nej</button>
        <button id="confirm-yes" class="btn btn-danger">Ja</button>
      </div>
    </div>
  </div>

  <!-- Bottom bar (Backup / Restore) -->
  <div id="lezgo-bottom-bar" style="display:none">
    <button id="btn-backup" class="lezgo-btn">Backup</button>
    <label for="file-restore" class="lezgo-btn restore" style="cursor:pointer">Restore</label>
    <input id="file-restore" type="file" accept="application/json" style="display:none" />
  </div>

<script>
/* ---------------- CONFIG ---------------- */
const ADMIN_PASSWORD = "admin123";
const EX_KEY = "lezgo_exercises_v1";
const SES_KEY = "lezgo_sessions_v1";
const CAT_KEY = "lezgo_categories_v1";
const LVL_KEY = "lezgo_levels_v1";
const INT_KEY = "lezgo_intensities_v1";
const PLR_KEY = "lezgo_players_v1";

const DEFAULT_CATEGORIES = ["Back wall","Bandeja","Chiquita","Defense","Double wall","Groundstroke","Lob","Serve","Smash","Vibora","Volley"].sort();
const DEFAULT_LEVELS = ["Beginner","Intermediate","Advanced"];
const DEFAULT_INT = ["Low","Medium","High"];
const DEFAULT_PLAYERS = ["1","2","3","4","1-2","1-3","1-4","2-4","Any","Add new..."];

let exercises = [], sessions = [], categories = [], levels = [], intensities = [], players = [];
let editingId = null;
const $ = id => document.getElementById(id);
const uid = () => "id_" + Math.random().toString(36).slice(2,10);
const isAdmin = () => localStorage.getItem("is_admin") === "1";
const isPaid  = () => localStorage.getItem("is_paid") === "1";

/* Performance: batch render */
const RENDER_BATCH = 100;
let renderIndex = 0;

/* ------------- STORAGE ------------- */
function loadAll(){
  exercises = JSON.parse(localStorage.getItem(EX_KEY) || "[]");
  sessions = JSON.parse(localStorage.getItem(SES_KEY) || "[]");
  categories = JSON.parse(localStorage.getItem(CAT_KEY) || "null") || DEFAULT_CATEGORIES;
  levels = JSON.parse(localStorage.getItem(LVL_KEY) || "null") || DEFAULT_LEVELS;
  intensities = JSON.parse(localStorage.getItem(INT_KEY) || "null") || DEFAULT_INT;
  players = JSON.parse(localStorage.getItem(PLR_KEY) || "null") || DEFAULT_PLAYERS;
}
function persistExercises(){ localStorage.setItem(EX_KEY, JSON.stringify(exercises)); }
function persistSessions(){ localStorage.setItem(SES_KEY, JSON.stringify(sessions)); }
function persistBase(){ localStorage.setItem(CAT_KEY, JSON.stringify(categories)); localStorage.setItem(LVL_KEY, JSON.stringify(levels)); localStorage.setItem(INT_KEY, JSON.stringify(intensities)); localStorage.setItem(PLR_KEY, JSON.stringify(players)); }

/* ------------- INIT ------------- */
function init(){
  loadAll();
  populateSelects();
  bindEvents();
  renderSessions();
  renderList(true);
  enforcePermissions();
  registerSW();
}
function populateSelects(){
  const sel = $("category"), filc = $("filter-category"), lvl = $("level"), fill = $("filter-level"), pl = $("players");
  if(sel){ sel.innerHTML=''; categories.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); }); const add=document.createElement('option'); add.value='__ADD__'; add.textContent='Add new category...'; sel.appendChild(add); }
  if(filc){ filc.innerHTML=''; let a=document.createElement('option'); a.text='ALL'; a.value=''; filc.appendChild(a); categories.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.text=c; filc.appendChild(o); }); }
  if(lvl){ lvl.innerHTML=''; levels.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.text=c; lvl.appendChild(o); }); const addL=document.createElement('option'); addL.value='__ADD__'; addL.text='Add new level...'; lvl.appendChild(addL); }
  if(fill){ fill.innerHTML=''; let a=document.createElement('option'); a.text='ALL'; a.value=''; fill.appendChild(a); levels.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.text=c; fill.appendChild(o); }); }
  if(pl){ pl.innerHTML=''; players.forEach(p=>{ const o=document.createElement('option'); o.value=p; o.text=p; pl.appendChild(o); }); }
}

/* ------------- BIND ------------- */
function bindEvents(){
  $("save-btn").addEventListener("click", onSave);
  $("clear-btn").addEventListener("click", clearForm);
  $("delete-all-btn").addEventListener("click", ()=> {
    if(!isAdmin()){ alert('Admin adgang kr√¶ves'); return; }
    const pass = prompt('Admin kode for at bekr√¶fte slet alle'); if(pass !== ADMIN_PASSWORD){ alert('Forkert kode'); return; }
    if(confirm('Slet ALLE √∏velser?')){ exercises=[]; persistExercises(); renderList(true); renderSessions(); }
  });

  $("search").addEventListener("input", ()=> { renderIndex=0; debounce(()=>renderList(true), 180); });
  $("filter-category").addEventListener("change", ()=> { renderIndex=0; renderList(true); });
  $("filter-level").addEventListener("change", ()=> { renderIndex=0; renderList(true); });

  $("pf-y").addEventListener("click", ()=> togglePf('youtube',$('pf-y')));
  $("pf-i").addEventListener("click", ()=> togglePf('instagram',$('pf-i')));
  $("pf-f").addEventListener("click", ()=> togglePf('facebook',$('pf-f')));

  $("btn-admin").addEventListener("click", ()=> $("admin-modal").style.display="flex");
  $("admin-cancel").addEventListener("click", ()=> $("admin-modal").style.display="none");
  $("admin-submit").addEventListener("click", ()=> {
    if($("admin-password").value===ADMIN_PASSWORD){ localStorage.setItem("is_admin","1"); $("admin-modal").style.display="none"; enforcePermissions(); alert('Admin enabled'); } else alert('Forkert kode');
  });
  $("btn-logout-header").addEventListener("click", ()=> { localStorage.removeItem('is_admin'); enforcePermissions(); });

  $("btn-buy").addEventListener("click", ()=> {
    if(isPaid()){ if(confirm('Deaktiver betalt adgang?')){ localStorage.removeItem('is_paid'); enforcePermissions(); } }
    else { if(confirm('Simuler k√∏b?')){ localStorage.setItem('is_paid','1'); enforcePermissions(); } }
  });

  $("load-more").addEventListener("click", ()=> renderList(false));

  // confirm modal buttons
  $("confirm-no").addEventListener("click", ()=> closeConfirm(false));
  $("confirm-yes").addEventListener("click", ()=> closeConfirm(true));

  // backup/restore
  $("btn-backup").addEventListener("click", onBackup);
  $("file-restore").addEventListener("change", onRestoreFile);
}

/* debounce */
let debounceTimer = null;
function debounce(fn, wait){ clearTimeout(debounceTimer); debounceTimer = setTimeout(fn, wait); }

/* platform state */
const platformState = new Set();
function togglePf(name, el){ if(platformState.has(name)){ platformState.delete(name); el.classList.remove('active'); } else { platformState.add(name); el.classList.add('active'); } renderIndex=0; renderList(true); }

/* ------------- SAVE / DUP CHECK ------------- */
function onSave(){
  const title = ($("title").value||"").trim();
  const link = ($("link").value||"").trim();
  if(!title){ alert('Indtast titel'); return; }

  // duplicates
  const dupTitle = exercises.some(e => e.title && e.title.toLowerCase() === title.toLowerCase() && e.id !== editingId);
  const dupLink = link ? exercises.some(e => e.link === link && e.id !== editingId) : false;
  if(dupTitle || dupLink){
    alert('Duplikat fundet: titel eller link findes allerede. Ret eller brug en anden titel/link.');
    return;
  }

  const obj = { id: editingId || uid(), title, link, category: $("category").value, players: $("players").value, duration: Number($("duration").value||0), level: $("level").value, intensity: $("intensity").value, description: $("description").value||"", tags: ($("tags").value||"").trim(), createdAt: new Date().toISOString() };

  if(editingId){
    const idx = exercises.findIndex(x=>x.id===editingId);
    if(idx>-1) exercises[idx] = obj;
  } else {
    exercises.unshift(obj);
  }
  persistExercises();
  editingId = null;
  clearForm();
  renderIndex=0;
  renderList(true);
  renderSessions();
}
function clearForm(){
  editingId=null;
  $("title").value=""; $("link").value=""; if($("category")) $("category").selectedIndex=0;
  if($("players")) $("players").selectedIndex=0; $("duration").value=""; if($("level")) $("level").selectedIndex=0;
  if($("intensity")) $("intensity").selectedIndex=0; $("description").value=""; $("tags").value="";
}

/* ------------- RENDER LIST (batched) ------------- */
function renderList(reset=true){
  const list = $("list");
  if(!list) return;
  if(reset){ renderIndex=0; list.innerHTML=""; }

  const q = ($("search").value||"").trim().toLowerCase();
  const fc = ($("filter-category").value||"");
  const fl = ($("filter-level").value||"");
  let items = exercises.slice();

  // platform filter
  if(platformState.size>0){
    items = items.filter(it=>{
      if(!it.link) return false;
      try{
        const host = new URL(it.link).hostname.toLowerCase();
        if(host.includes('youtube')||host.includes('youtu.be')) return platformState.has('youtube');
        if(host.includes('instagram')) return platformState.has('instagram');
        if(host.includes('facebook')) return platformState.has('facebook');
      }catch(e){ return false; }
      return false;
    });
  }

  if(fc) items = items.filter(x=>x.category===fc);
  if(fl) items = items.filter(x=>x.level===fl);
  if(q) items = items.filter(x => (x.title||"").toLowerCase().includes(q) || (x.description||"").toLowerCase().includes(q) || (x.tags||"").toLowerCase().includes(q));

  const total = items.length;
  const start = renderIndex;
  const end = Math.min(start + RENDER_BATCH, total);
  const slice = items.slice(start, end);

  const frag = document.createDocumentFragment();
  slice.forEach(ex=>{
    const row = document.createElement('div'); row.className='exercise'; row.dataset.id=ex.id;

    // checkbox (kept for count only)
    const cb = document.createElement('input'); cb.type='checkbox'; cb.style.marginRight='8px';
    cb.addEventListener('change', ()=> updateSelectedCount());
    row.appendChild(cb);

    const left = document.createElement('div'); left.className='left';
    const h = document.createElement('div'); h.style.fontWeight='800'; h.style.fontSize='15px'; h.textContent = ex.title;
    left.appendChild(h);
    const meta = document.createElement('div'); meta.className='meta'; meta.textContent = `${ex.category} ‚Ä¢ ${ex.level} ‚Ä¢ ${ex.players||''} ‚Ä¢ ${ex.duration}m`; left.appendChild(meta);
    if(ex.link){ const a = document.createElement('a'); a.href = ex.link; a.target='_blank'; a.style.display='block'; a.style.marginTop='6px'; a.textContent = ex.link; left.appendChild(a); }
    if(ex.tags){ const tbox = document.createElement('div'); tbox.style.marginTop='8px'; ex.tags.split(',').forEach(tg=>{ const s=document.createElement('span'); s.className='tag'; s.textContent = tg.trim(); tbox.appendChild(s); }); left.appendChild(tbox); }
    row.appendChild(left);

    const right = document.createElement('div'); right.className='actions-small';

    // per-item: Tilf√∏j til Session Builder (ADMIN & PAID)
    if(isAdmin() || isPaid()){
      const addBtn = document.createElement('button'); addBtn.className='btn btn-primary btn-small'; addBtn.textContent='Tilf√∏j';
      addBtn.title = 'Tilf√∏j til Session Builder';
      addBtn.addEventListener('click', ()=> { addToSessionBuilder(ex.id); });
      right.appendChild(addBtn);
    }

    // edit (admin/paid)
    if(isAdmin() || isPaid()){
      const editBtn = document.createElement('button'); editBtn.className='btn btn-ghost'; editBtn.textContent='Rediger';
      editBtn.addEventListener('click', ()=> { editingId = ex.id; populateFormForEdit(ex); window.scrollTo({top:0,behavior:'smooth'}); });
      right.appendChild(editBtn);
    }

    // delete (admin/paid)
    if(isAdmin() || isPaid()){
      const delBtn = document.createElement('button'); delBtn.className='btn btn-ghost'; delBtn.style.color='var(--danger)'; delBtn.textContent='Slet';
      delBtn.addEventListener('click', ()=> showConfirm('Slet denne √∏velse?', ()=>{ exercises = exercises.filter(x=>x.id!==ex.id); persistExercises(); renderList(true); renderSessions(); updateSelectedCount(); }));
      right.appendChild(delBtn);
    }

    row.appendChild(right);
    frag.appendChild(row);
  });

  list.appendChild(frag);
  renderIndex = end;

  const loadMore = $("load-more");
  if(renderIndex < total){ loadMore.style.display='block'; loadMore.textContent = `Vis flere (${total - renderIndex})`; }
  else loadMore.style.display='none';

  if(total === 0 && start===0){ list.innerHTML = `<div style="color:var(--muted)">Ingen resultater</div>`; }
  updateSelectedCount();
}

/* populate form for edit */
function populateFormForEdit(ex){
  $("title").value = ex.title || "";
  $("link").value = ex.link || "";
  if($("category")) $("category").value = ex.category || "";
  if($("players")) $("players").value = ex.players || "";
  $("duration").value = ex.duration || "";
  if($("level")) $("level").value = ex.level || "";
  if($("intensity")) $("intensity").value = ex.intensity || "";
  $("description").value = ex.description || "";
  $("tags").value = ex.tags || "";
}

/* ------------- Session Builder actions ------------- */
function addToSessionBuilder(id){
  if(!isAdmin() && !isPaid()){ alert('Betalt adgang kr√¶ves'); return; }
  const box = $("session-items");
  if(box.querySelector(`[data-id="${id}"]`)){ // already in builder
    // optionally flash / scroll
    const node = box.querySelector(`[data-id="${id}"]`);
    node.style.transition = 'box-shadow .2s'; node.style.boxShadow = '0 0 0 3px rgba(34,197,94,0.15)';
    setTimeout(()=> node.style.boxShadow = '', 600);
    node.scrollIntoView({behavior:'smooth', block:'center'});
    return;
  }
  const ex = exercises.find(e=>e.id===id);
  if(!ex) return;
  const row = document.createElement('div'); row.className = 'exercise'; row.dataset.id = id; row.style.marginBottom='6px';
  row.innerHTML = `<div style="flex:1"><div style="font-weight:700">${escapeHtml(ex.title)}</div><div style="color:var(--muted)">${ex.duration}m ‚Ä¢ ${escapeHtml(ex.category)}</div></div><button class="btn btn-ghost remove-from-session" style="color:var(--danger)">Fjern</button>`;
  row.querySelector('button').addEventListener('click', ()=> { row.remove(); recalcSession(); });
  box.appendChild(row);
  recalcSession();
  // scroll into view of session builder
  const builder = $("session-items");
  builder.scrollIntoView({behavior:'smooth', block:'center'});
}

/* recalc session builder totals */
function recalcSession(){
  let total = 0, count = 0;
  document.querySelectorAll("#session-items .exercise").forEach(r=>{
    const id = r.dataset.id;
    const ex = exercises.find(e=>e.id === id);
    if(ex){ total += Number(ex.duration || 0); count++; }
  });
  $("session-total").textContent = total + " m";
  $("session-count").textContent = count + " √∏velser";
}

/* save session */
function saveSession(){
  if(!isAdmin() && !isPaid()){ alert('Betalt adgang kr√¶ves'); return; }
  const name = ($("session-name").value||"").trim();
  if(!name){ alert('Tilf√∏j et sessionsnavn'); return; }
  const ids = Array.from(document.querySelectorAll("#session-items .exercise")).map(r=>r.dataset.id);
  const total = ids.reduce((a,id)=>{ const ex = exercises.find(e=>e.id===id); return a + (ex?Number(ex.duration||0):0); }, 0);
  const s = { id: uid(), name, description: $("session-desc").value||"", items: ids, total, createdAt: new Date().toISOString() };
  sessions.unshift(s);
  persistSessions();
  renderSessions();
  alert('Session gemt');
}

/* open saved session (populate builder) */
function openSavedSession(id){
  const s = sessions.find(x=>x.id === id);
  if(!s) return alert('Session not found');
  const box = $("session-items"); box.innerHTML = "";
  s.items.forEach(iid=>{
    const ex = exercises.find(e=>e.id === iid);
    if(!ex) return;
    const row = document.createElement('div'); row.className='exercise'; row.dataset.id = iid; row.style.marginBottom='6px';
    row.innerHTML = `<div style="flex:1"><div style="font-weight:700">${escapeHtml(ex.title)}</div><div style="color:var(--muted)">${ex.duration}m ‚Ä¢ ${escapeHtml(ex.category)}</div></div><button class="btn btn-ghost remove-from-session" style="color:var(--danger)">Fjern</button>`;
    row.querySelector('button').addEventListener('click', ()=> { row.remove(); recalcSession(); });
    box.appendChild(row);
  });
  recalcSession();
  // scroll to builder
  $("session-items").scrollIntoView({behavior:'smooth', block:'center'});
}

/* render sessions list */
function renderSessions(){
  const box = $("sessions-list"); box.innerHTML = "";
  if(!sessions.length){ box.innerHTML = `<div style="color:var(--muted)">Ingen gemte sessioner</div>`; return; }
  sessions.forEach(s=>{
    const div = document.createElement('div'); div.className='exercise'; div.style.marginBottom='8px';
    div.innerHTML = `<div style="flex:1"><div style="font-weight:800">${escapeHtml(s.name)}</div><div style="color:var(--muted)">${(s.items||[]).length} √∏velser ‚Ä¢ ${s.total||0} m</div></div>`;
    const openBtn = document.createElement('button'); openBtn.className='btn btn-ghost'; openBtn.textContent='√Öbn';
    openBtn.addEventListener('click', ()=> openSavedSession(s.id));
    const delBtn = document.createElement('button'); delBtn.className='btn btn-ghost'; delBtn.style.color='var(--danger)'; delBtn.textContent='Slet';
    delBtn.addEventListener('click', ()=> showConfirm('Slet denne session?', ()=>{ sessions = sessions.filter(x=>x.id!==s.id); persistSessions(); renderSessions(); }));
    div.appendChild(openBtn);
    if(isAdmin() || isPaid()) div.appendChild(delBtn);
    box.appendChild(div);
  });
}

/* ------------- Backups / Restore ------------- */
function onBackup(){
  if(!(isAdmin() || isPaid())){ alert('Admin eller betalt adgang kr√¶ves for backup'); return; }
  try {
    const payload = { meta:{createdAt:new Date().toISOString()}, data:{ exercises, sessions, categories, levels, intensities, players } };
    const blob = new Blob([JSON.stringify(payload,null,2)], { type:'application/json' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `lezgo-backup-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
    alert('Backup downloadet.');
  } catch(err){ console.error(err); alert('Backup fejlede'); }
}
async function onRestoreFile(ev){
  if(!(isAdmin() || isPaid())){ alert('Admin eller betalt adgang kr√¶ves for restore'); ev.target.value=''; return; }
  const file = ev.target.files && ev.target.files[0]; if(!file) return;
  try{
    const text = await file.text(); const parsed = JSON.parse(text);
    if(!parsed || !parsed.data) throw new Error('Ugyldigt backup-format');
    // merge
    const inc = parsed.data;
    const exMap = new Map((exercises||[]).map(e=>[e.id,e]));
    (inc.exercises||[]).forEach(e=>{ if(!e.id) e.id=uid(); exMap.set(e.id,e); });
    exercises = Array.from(exMap.values());
    const sesMap = new Map((sessions||[]).map(s=>[s.id,s]));
    (inc.sessions||[]).forEach(s=>{ if(!s.id) s.id=uid(); sesMap.set(s.id,s); });
    sessions = Array.from(sesMap.values());
    categories = Array.from(new Set([...(categories||[]), ...(inc.categories||[])]));
    levels = Array.from(new Set([...(levels||[]), ...(inc.levels||[])]));
    intensities = Array.from(new Set([...(intensities||[]), ...(inc.intensities||[])]));
    players = Array.from(new Set([...(players||[]), ...(inc.players||[])]));
    persistExercises(); persistSessions(); persistBase();
    renderList(true); renderSessions();
    alert('Restore gennemf√∏rt ‚Äî data er flettet.');
  } catch(err){ console.error(err); alert('Restore fejlede: ' + (err.message||err)); } finally { ev.target.value=''; }
}

/* ------------- Helpers: confirm modal, utilities ------------- */
let _confirmCb = null;
function showConfirm(message, cb){
  _confirmCb = cb;
  $("confirm-message").textContent = message;
  $("confirm-modal").style.display = "flex";
}
function closeConfirm(answer){
  $("confirm-modal").style.display = "none";
  if(answer && typeof _confirmCb === 'function') _confirmCb();
  _confirmCb = null;
}

function updateSelectedCount(){
  const boxes = document.querySelectorAll('#list input[type="checkbox"]');
  let count = 0;
  boxes.forEach(b=>{ if(b.checked) count++; });
  $("selected-count").textContent = (count || 0) + " valgt";
}

function escapeHtml(str){ return (str||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* enforce UI/permissions */
function enforcePermissions(){
  // bottom bar
  const bb = $("lezgo-bottom-bar");
  if(bb) bb.style.display = (isAdmin() || isPaid()) ? 'flex' : 'none';
  // delete-all btn only admin
  if($("delete-all-btn")) $("delete-all-btn").style.display = isAdmin() ? 'inline-block' : 'none';
  // save/clear session visible for admin/paid
  if($("save-session")) $("save-session").style.display = (isAdmin() || isPaid()) ? 'inline-block' : 'none';
  if($("clear-session")) $("clear-session").style.display = (isAdmin() || isPaid()) ? 'inline-block' : 'none';
  // badges
  const b = $("badges"); b.innerHTML = '';
  if(isAdmin()){ const d=document.createElement('div'); d.className='badge'; d.textContent='ADMIN'; b.appendChild(d); $("btn-logout-header").style.display='inline-flex'; } else $("btn-logout-header").style.display='none';
  if(isPaid()){ const d=document.createElement('div'); d.className='badge'; d.textContent='PAID'; b.appendChild(d); }
}

/* ------------- Service worker register ------------- */
function registerSW(){
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('./service-worker.js').then(reg=>{ console.log('SW registered', reg.scope); }).catch(()=>{ console.warn('SW register failed'); });
  }
}

/* ------------- START ------------- */
document.addEventListener('DOMContentLoaded', ()=> { init(); });

</script>
</body>
</html>
