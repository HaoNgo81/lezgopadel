<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>LezGo Padel ‚Äî Training Bank</title>
  <meta name="theme-color" content="#071226" />
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/icon-192.png" sizes="192x192">
  <style>
    /* ===== RESET & GLOBAL ===== */
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%;margin:0;padding:0}
    body{
      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      -webkit-font-smoothing:antialiased;background:linear-gradient(180deg,#071226 0%,#04111a 100%);
      color:#e6eef6;max-width:100%;overflow-x:hidden;
    }
    :root{--panel:#0b1220;--muted:#9aa7b3;--success:#22c55e;--danger:#ef4444;--card-shadow:0 8px 22px rgba(2,6,23,.6)}
    img,svg,video,iframe{max-width:100%;height:auto;display:block}
    a{color:inherit}
    .wrap{max-width:1100px;margin:12px auto;padding:10px;width:100%}

    /* ===== HEADER / LOGO ===== */
    header{display:block;text-align:center;padding:8px 0 6px 0;margin-bottom:10px;position:relative}
    header img{display:inline-block;height:110px;max-height:18vh;width:auto;max-width:70%;object-fit:contain;margin:0 auto}

    .top-controls{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px;flex-wrap:wrap}
    .badges{display:flex;gap:8px;align-items:center}
    .badge{padding:6px 8px;border-radius:8px;font-weight:700;font-size:13px}
    .admin-badge{background:#0b7a5f;color:#fff}
    .paid-badge{background:#0b4a7a;color:#fff}

    .card{background:var(--panel);border-radius:10px;padding:10px;box-shadow:var(--card-shadow);margin-bottom:12px;overflow:hidden}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .two-column{display:grid;grid-template-columns:1fr minmax(220px,360px);gap:10px}

    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type="text"],input[type="url"],select,textarea,input[type="number"]{
      width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.06);background:#071226;color:inherit;font-size:15px;min-width:0;
    }
    textarea{min-height:80px;resize:vertical}
    .small{font-size:12px;color:var(--muted)}

    .btn{border:0;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer;white-space:nowrap}
    .btn-primary{background:var(--success);color:#05261a}
    .btn-ghost{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,.06)}
    .btn-danger{background:var(--danger);color:#fff}

    .buttons{display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:nowrap}
    .buttons .left{display:flex;gap:10px;align-items:center;min-width:0}
    .buttons .right{display:flex;align-items:center;min-width:0}

    .list{margin-top:8px}
    .exercise{display:flex;gap:10px;align-items:flex-start;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.03);margin-bottom:8px}
    .exercise a{word-break:break-all}
    .tag{background:rgba(255,255,255,.03);padding:6px 8px;border-radius:6px;font-size:13px;margin-right:8px;display:inline-block}

    .session-list{max-height:320px;overflow:auto}
    .session-item{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,.04);margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}

    .modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:9999}
    .modal .box{background:var(--panel);padding:16px;border-radius:10px;max-width:400px;width:90%}

    .wrap,.card,form,.two-column,.buttons{max-width:100% !important;overflow-x:hidden !important}

    @media (max-width:520px){
      .grid{grid-template-columns:1fr}
      .two-column{grid-template-columns:1fr}
      .buttons{flex-wrap:wrap;justify-content:flex-start}
      .buttons .right{order:3;width:100%;justify-content:flex-end}
      .buttons .left .btn{flex:1 1 auto}
      header img{height:90px;max-height:16vh;max-width:85%}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="/lezgo-logo.svg" alt="LezGo logo" id="logo">
    </header>

    <div class="top-controls">
      <div class="badges" id="badges"></div>

      <div style="display:flex;gap:8px;align-items:center">
        <select id="lang-select" title="Language" style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,.06);background:transparent;color:inherit">
          <option value="en">English</option>
          <option value="da">Dansk</option>
        </select>

        <button id="btn-buy" class="btn btn-primary" data-i18n="buy_access">Buy access</button>
        <button id="btn-admin" class="btn btn-ghost" data-i18n="admin_login">Admin login</button>
      </div>
    </div>

    <!-- FORM (Padel only) -->
    <section class="card" aria-labelledby="form-title">
      <h3 id="form-title" class="small" style="margin:0 0 8px 0;color:var(--muted)" data-i18n="add_edit">Add / Edit exercise (Padel)</h3>

      <form id="exercise-form" class="grid" autocomplete="off" onsubmit="return false;">
        <!-- SINGLE Title field (not duplicated) -->
        <div style="grid-column:1 / -1">
          <label for="title" data-i18n="label_title">Title</label>
          <input id="title" type="text" placeholder="e.g. Forehand topspin drill">
        </div>

        <div style="grid-column:1 / -1">
          <label for="category" data-i18n="label_category">Category</label>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="category" style="flex:1"></select>
            <button id="delete-category-btn" class="btn btn-ghost" title="Delete category" style="padding:8px 10px;display:none">üóëÔ∏è</button>
          </div>
        </div>

        <div style="grid-column:1 / -1">
          <label for="link" data-i18n="label_link">Link (YouTube / Instagram / Facebook)</label>
          <input id="link" type="url" placeholder="https://...">
        </div>

        <div style="grid-column:1 / -1">
          <label for="description_en" data-i18n="label_desc_en">Description (EN)</label>
          <textarea id="description_en" placeholder="Short note"></textarea>
        </div>

        <div style="grid-column:1 / -1">
          <label for="description_da" data-i18n="label_desc_da">Description (DA)</label>
          <textarea id="description_da" placeholder="Kort notat"></textarea>
        </div>

        <div>
          <label for="level" data-i18n="label_level">Level</label>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="level" style="flex:1"></select>
            <button id="delete-level-btn" class="btn btn-ghost" title="Delete level" style="padding:8px 10px;display:none">üóëÔ∏è</button>
          </div>
        </div>

        <!-- PLAYERS: select with ranges and add-new -->
        <div>
          <label for="players" data-i18n="label_players">Players</label>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="players" style="flex:1">
              <!-- options filled by JS -->
            </select>
          </div>
        </div>

        <div>
          <label for="duration" data-i18n="label_duration">Duration (minutes)</label>
          <input id="duration" type="number" min="0" placeholder="20">
        </div>

        <div>
          <label for="intensity" data-i18n="label_intensity">Intensity</label>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="intensity" style="flex:1"></select>
            <button id="delete-intensity-btn" class="btn btn-ghost" title="Delete intensity" style="padding:8px 10px;display:none">üóëÔ∏è</button>
          </div>
        </div>

        <div style="grid-column:1 / -1">
          <label for="tags" data-i18n="label_tags">Tags (comma separated)</label>
          <input id="tags" type="text" placeholder="Cross, Down the line, From glass">
        </div>

        <div class="buttons" style="grid-column:1 / -1">
          <div class="left">
            <button id="save-btn" class="btn btn-primary" data-i18n="save_exercise">‚ûï Save exercise</button>
            <button id="clear-btn" class="btn btn-ghost" data-i18n="clear_form">Clear form</button>
          </div>
          <div class="right">
            <button id="delete-all-btn" class="btn btn-danger" data-i18n="delete_all">üóëÔ∏è Delete all exercises</button>
          </div>
        </div>

        <div style="grid-column:1 / -1;margin-top:8px">
          <div class="small" style="color:var(--muted)" data-i18n="dup_note">Duplicate detection: the app warns if Title or Link already exists.</div>
        </div>
      </form>
    </section>

    <!-- FILTER + SESSION BUILDER -->
    <section class="card">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px">
        <input id="search" class="search" type="text" placeholder="Search by title, tag or description..." />
        <select id="filter-category"><option value="ALL">ALL</option></select>
        <select id="filter-level"><option value="ALL">All levels</option></select>
        <select id="filter-platform" title="Platform filter (paid users only)">
          <option value="ALL">All platforms</option>
          <option value="YouTube">YouTube</option>
          <option value="Instagram">Instagram</option>
          <option value="Facebook">Facebook</option>
          <option value="Other">Other</option>
        </select>
        <button id="show-favorites" class="btn btn-ghost">Show favorites</button>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <button id="export-sessions" class="btn btn-ghost">Export sessions</button>
          <button id="import-sessions" class="btn btn-ghost">Import sessions</button>
        </div>
      </div>

      <div class="two-column">
        <div>
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
            <button id="select-all" class="btn btn-ghost">Select all</button>
            <button id="add-selected" class="btn btn-primary">Add selected to session builder</button>
            <div class="small" style="margin-left:auto" id="selected-count">0 selected</div>
          </div>
          <div id="list" class="list"></div>
        </div>

        <aside class="card" style="padding:10px">
          <h4 style="margin:0 0 8px 0">Training Session Builder</h4>

          <div style="margin-bottom:8px">
            <label>Session name</label>
            <input id="session-name" type="text" placeholder="e.g. Match warm-up 20 min">
          </div>

          <div style="margin-bottom:8px">
            <label>Session description</label>
            <input id="session-desc" type="text" placeholder="Short description (optional)">
          </div>

          <div style="margin-bottom:8px">
            <label>Selected exercises</label>
            <div id="session-items" style="max-height:160px;overflow:auto;padding-top:6px"></div>
          </div>

          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
            <div class="small">Total time:</div>
            <div id="session-total" style="font-weight:800;margin-left:6px">0 m</div>
            <div style="margin-left:auto" class="small" id="session-count">0 exercises</div>
          </div>

          <div style="display:flex;gap:8px;align-items:center" aria-label="session actions">
            <button id="save-session" class="btn btn-primary">Save session</button>
            <button id="clear-session" class="btn btn-ghost">Clear builder</button>
          </div>

          <div id="session-lock-info" class="session-lock" style="display:none;margin-top:10px">Free users do not have access to Training Sessions. Please purchase access to use this feature.</div>

          <hr style="border:none;border-top:1px solid rgba(255,255,255,.04);margin:12px 0" />
          <h5 style="margin:8px 0 6px 0">Saved sessions</h5>
          <div id="sessions-list" class="session-list"></div>
        </aside>
      </div>
    </section>
  </div>

  <!-- Admin modal -->
  <div id="admin-modal" class="modal" style="display:none">
    <div class="box">
      <h3 style="margin-top:0">Admin login</h3>
      <p class="small" style="margin-bottom:8px">Enter admin password to unlock admin features.</p>
      <input id="admin-password" type="password" placeholder="Password" style="width:100%;padding:8px;border-radius:6px;margin-bottom:10px">
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="admin-cancel" class="btn btn-ghost">Cancel</button>
        <button id="admin-submit" class="btn btn-primary">Login</button>
      </div>
    </div>
  </div>

<script>
/* ================= CONFIG ================= */
const ADMIN_PASSWORD = 'admin123'; // change locally
const EX_KEY = 'lezgo_exercises_padelfinal_v3';
const CATS_KEY = 'lezgo_categories_padelfinal_v3';
const SESS_KEY = 'lezgo_sessions_padelfinal_v3';
const LEVELS_KEY = 'lezgo_levels_v1';
const INTENSITIES_KEY = 'lezgo_intensities_v1';
const PLAYERS_KEY = 'lezgo_players_v1';

/* Updated DEFAULT CATEGORIES: removed "Reset shot" and "Block" */
const DEFAULT_CATEGORIES = [
  "Back wall","Bandeja","Chiquita","Defense","Double wall",
  "Ground stroke backhand","Ground stroke forehand","Groundstroke",
  "Lob","Rolu","Serve","Serve Return","Side wall",
  "Smash","Vibora","Volley"
].sort((a,b)=>a.localeCompare(b,'en'));

const DEFAULT_LEVELS = ['Beginner','Intermediate','Advanced'];
const DEFAULT_INTENSITIES = ['Low','Medium','High'];
const DEFAULT_PLAYERS = ['1','2','3','4','1-2','1-3','1-4','2-3','2-4','3-4','Any','Add new...'];

/* ================= STATE ================= */
let exercises = [];
let categories = [];
let levels = [];
let intensities = [];
let playersList = [];
let sessions = [];
let editingId = null;
let showOnlyFavorites = false;
let selectedIds = new Set();

/* ================= HELPERS ================= */
const $ = id => document.getElementById(id);
function uid(){ return 'id_'+Math.random().toString(36).slice(2,9); }
function now(){ return new Date().toISOString(); }
function isAdmin(){ return localStorage.getItem('lezgo_is_admin') === '1'; }
function setAdmin(flag){ localStorage.setItem('lezgo_is_admin', flag ? '1' : '0'); updateAdminUI(); }
function isPaid(){ return localStorage.getItem('lezgo_is_paid') === '1'; }
function setPaid(flag){ localStorage.setItem('lezgo_is_paid', flag ? '1' : '0'); updatePaidUI(); }

function detectPlatform(url){
  if(!url) return 'None';
  const u = url.toLowerCase();
  if(u.includes('youtube.com') || u.includes('youtu.be')) return 'YouTube';
  if(u.includes('instagram.com')) return 'Instagram';
  if(u.includes('facebook.com') || u.includes('fb.watch') || u.includes('m.facebook.com')) return 'Facebook';
  return 'Other';
}

function normalizeTagsInput(raw){
  if(!raw) return '';
  return raw.split(',')
            .map(t=>t.replace(/^#/, '').trim())
            .filter(Boolean)
            .join(', ');
}

/* TRANSLATIONS */
const TRANSLATIONS = {
  en: {
    buy_access:'Buy access', admin_login:'Admin login', add_edit:'Add / Edit exercise (Padel)',
    label_title:'Title', label_category:'Category', label_link:'Link (YouTube / Instagram / Facebook)',
    label_desc_en:'Description (EN)', label_desc_da:'Description (DA)', label_level:'Level',
    label_players:'Players', label_duration:'Duration (minutes)', label_intensity:'Intensity',
    label_tags:'Tags (comma separated)', save_exercise:'‚ûï Save exercise', clear_form:'Clear form',
    delete_all:'üóëÔ∏è Delete all exercises', dup_note:'Duplicate detection: the app warns if Title or Link already exists.',
    buy_msg:'Simulate purchase to unlock sessions and platform filter.'
  },
  da: {
    buy_access:'K√∏b adgang', admin_login:'Admin login', add_edit:'Tilf√∏j / Rediger √∏velse (Padel)',
    label_title:'Titel', label_category:'Kategori', label_link:'Link (YouTube / Instagram / Facebook)',
    label_desc_en:'Beskrivelse (EN)', label_desc_da:'Beskrivelse (DA)', label_level:'Niveau',
    label_players:'Spillere', label_duration:'Varighed (minutter)', label_intensity:'Intensitet',
    label_tags:'Tags (komma separeret)', save_exercise:'‚ûï Gem √∏velse', clear_form:'Ryd formular',
    delete_all:'üóëÔ∏è Slet alle √∏velser', dup_note:'Duplicate detection: appen advarer hvis Title eller Link allerede findes.',
    buy_msg:'K√∏b adgang for at l√•se op for sessions og platform-filter.'
  }
};
function t(key){
  const lang = $('lang-select') ? $('lang-select').value : 'en';
  return (TRANSLATIONS[lang] && TRANSLATIONS[lang][key]) ? TRANSLATIONS[lang][key] : key;
}
function applyTranslations(){
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    if(key){
      if(el.tagName === 'INPUT' || el.tagName === 'TEXTAREA'){
        el.placeholder = t(key);
      } else {
        el.textContent = t(key);
      }
    }
  });
  if($('save-btn')) $('save-btn').textContent = t('save_exercise');
  if($('clear-btn')) $('clear-btn').textContent = t('clear_form');
  if($('delete-all-btn')) $('delete-all-btn').textContent = t('delete_all');
  if($('btn-buy')) $('btn-buy').textContent = t('buy_access');
  if($('btn-admin')) $('btn-admin').textContent = t('admin_login');
}

/* ================= STORAGE ================= */
function loadAll(){
  exercises = JSON.parse(localStorage.getItem(EX_KEY) || '[]');
  categories = JSON.parse(localStorage.getItem(CATS_KEY) || 'null') || DEFAULT_CATEGORIES.slice();
  levels = JSON.parse(localStorage.getItem(LEVELS_KEY) || 'null') || DEFAULT_LEVELS.slice();
  intensities = JSON.parse(localStorage.getItem(INTENSITIES_KEY) || 'null') || DEFAULT_INTENSITIES.slice();
  playersList = JSON.parse(localStorage.getItem(PLAYERS_KEY) || 'null') || DEFAULT_PLAYERS.slice();
  sessions = JSON.parse(localStorage.getItem(SESS_KEY) || '[]');

  if(!Array.isArray(categories)) categories = DEFAULT_CATEGORIES.slice();
  if(!Array.isArray(levels)) levels = DEFAULT_LEVELS.slice();
  if(!Array.isArray(intensities)) intensities = DEFAULT_INTENSITIES.slice();
  if(!Array.isArray(playersList)) playersList = DEFAULT_PLAYERS.slice();

  saveCategories(); saveLevels(levels); saveIntensities(intensities); savePlayers(playersList);
}
function saveExercises(){ localStorage.setItem(EX_KEY, JSON.stringify(exercises)); }
function saveCategories(){ localStorage.setItem(CATS_KEY, JSON.stringify(categories)); }
function saveLevels(arr){ localStorage.setItem(LEVELS_KEY, JSON.stringify(arr)); }
function saveIntensities(arr){ localStorage.setItem(INTENSITIES_KEY, JSON.stringify(arr)); }
function savePlayers(arr){ localStorage.setItem(PLAYERS_KEY, JSON.stringify(arr)); }
function saveSessions(){ localStorage.setItem(SESS_KEY, JSON.stringify(sessions)); }

/* ================= UI POPULATE ================= */
function init(){
  loadAll();
  populateCategory();
  populateLevelAndIntensity();
  populatePlayers();
  bindForm();
  renderList();
  renderSessions();
  updateCounts();
  updateAdminUI();
  updatePaidUI();
  applyTranslations();
}

function populateCategory(){
  const sel = $('category'); const filt = $('filter-category');
  sel.innerHTML=''; filt.innerHTML = '<option value="ALL">ALL</option>';
  categories.slice().sort((a,b)=>a.localeCompare(b,'en')).forEach(c=>{
    const o = document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o);
    const f = document.createElement('option'); f.value=c; f.textContent=c; filt.appendChild(f);
  });
  const addOpt = document.createElement('option'); addOpt.value='__ADD__'; addOpt.textContent='Add new category...'; sel.appendChild(addOpt);
  filt.value='ALL';
}

function populateLevelAndIntensity(){
  const selLevel = $('level'); const selIntensity = $('intensity'); const filterLevel = $('filter-level');
  selLevel.innerHTML=''; selIntensity.innerHTML=''; filterLevel.innerHTML = '<option value="ALL">All levels</option>';
  levels.slice().sort((a,b)=>a.localeCompare(b,'en')).forEach(x=>{
    const o=document.createElement('option'); o.value=x; o.textContent=x; selLevel.appendChild(o);
    const f=document.createElement('option'); f.value=x; f.textContent=x; filterLevel.appendChild(f);
  });
  const addLvlOpt = document.createElement('option'); addLvlOpt.value='__ADD__'; addLvlOpt.textContent='Add new level...'; selLevel.appendChild(addLvlOpt);

  intensities.slice().sort((a,b)=>a.localeCompare(b,'en')).forEach(x=>{
    const o=document.createElement('option'); o.value=x; o.textContent=x; selIntensity.appendChild(o);
  });
  const addIntOpt = document.createElement('option'); addIntOpt.value='__ADD__'; addIntOpt.textContent='Add new intensity...'; selIntensity.appendChild(addIntOpt);

  $('delete-level-btn').style.display = isAdmin() ? 'inline-flex' : 'none';
  $('delete-intensity-btn').style.display = isAdmin() ? 'inline-flex' : 'none';
}

function populatePlayers(){
  const sel = $('players'); sel.innerHTML='';
  playersList.slice().forEach(p=>{
    const o=document.createElement('option'); o.value=p; o.textContent=p; sel.appendChild(o);
  });
  // special add new option
  if(!playersList.includes('Add new...')){
    const add = document.createElement('option'); add.value='__ADD__'; add.textContent='Add new...'; sel.appendChild(add);
  }
}

/* ================= BINDINGS ================= */
function bindForm(){
  $('save-btn').addEventListener('click', onSave);
  $('clear-btn').addEventListener('click', e=>{ e.preventDefault(); clearForm(); });
  $('delete-all-btn').addEventListener('click', onDeleteAll);
  $('search').addEventListener('input', renderList);
  $('filter-category').addEventListener('change', renderList);
  $('filter-level').addEventListener('change', renderList);
  $('filter-platform').addEventListener('change', ()=>{ if(!isPaid() && !isAdmin()){ alert(t('buy_msg')); $('filter-platform').value='ALL'; return;} renderList(); });
  $('show-favorites').addEventListener('click', ()=>{ showOnlyFavorites = !showOnlyFavorites; $('show-favorites').textContent = showOnlyFavorites ? 'Show all' : 'Show favorites'; renderList(); });

  $('delete-category-btn').addEventListener('click', onDeleteCategory);
  $('category').addEventListener('change', (e)=>{ if(e.target.value==='__ADD__'){ const n = prompt('Add new category:'); if(n){ categories.push(n.trim()); saveCategories(); populateCategory(); } }});

  $('level').addEventListener('change', e=>{ if(e.target.value==='__ADD__'){ const n=prompt('Add new level:'); if(n){ levels.push(n.trim()); saveLevels(levels); populateLevelAndIntensity(); } }});
  $('intensity').addEventListener('change', e=>{ if(e.target.value==='__ADD__'){ const n=prompt('Add new intensity:'); if(n){ intensities.push(n.trim()); saveIntensities(intensities); populateLevelAndIntensity(); } }});

  $('delete-level-btn').addEventListener('click', ()=>{
    if(!isAdmin()){ alert('Only admin can delete levels.'); return; }
    const sel = $('level'); const val = sel.value;
    if(!val || val==='__ADD__'){ alert('Select a real level to delete'); return; }
    if(!confirm('Delete level "'+val+'"?')) return;
    levels = levels.filter(x=>x!==val); saveLevels(levels); populateLevelAndIntensity(); renderList();
  });
  $('delete-intensity-btn').addEventListener('click', ()=>{
    if(!isAdmin()){ alert('Only admin can delete intensities.'); return; }
    const sel = $('intensity'); const val = sel.value;
    if(!val || val==='__ADD__'){ alert('Select a real intensity to delete'); return; }
    if(!confirm('Delete intensity "'+val+'"?')) return;
    intensities = intensities.filter(x=>x!==val); saveIntensities(intensities); populateLevelAndIntensity(); renderList();
  });

  // players add new
  $('players').addEventListener('change', e=>{
    if(e.target.value === '__ADD__' || e.target.value === 'Add new...'){
      const n = prompt('Add custom players option (e.g. "1-4", "3 players"):');
      if(n){
        playersList.push(n.trim());
        savePlayers(playersList);
        populatePlayers();
      } else {
        // revert selection
        e.target.value = playersList[0] || '1';
      }
    }
  });

  $('select-all').addEventListener('click', ()=>{ document.querySelectorAll('.select-checkbox').forEach(cb=>cb.checked=true); updateSelectedSetFromUI(); });
  $('add-selected').addEventListener('click', addSelectedToBuilder);
  $('save-session').addEventListener('click', saveSessionFromBuilder);
  $('clear-session').addEventListener('click', clearBuilder);
  $('export-sessions').addEventListener('click', exportSessions);
  $('import-sessions').addEventListener('click', importSessionsPrompt);

  $('btn-admin').addEventListener('click', ()=>openAdminModal());
  $('btn-buy').addEventListener('click', ()=>buyAccess());

  $('admin-cancel').addEventListener('click', ()=>closeAdminModal());
  $('admin-submit').addEventListener('click', ()=>{
    const p = $('admin-password').value || '';
    if(p === ADMIN_PASSWORD){ setAdmin(true); closeAdminModal(); alert('Admin access granted.'); applyTranslations(); }
    else alert('Wrong password.');
  });

  $('lang-select').addEventListener('change', ()=>{ applyTranslations(); renderList(); });
}

/* ================= ADMIN / PAYMENT UI ================= */
function updateAdminUI(){
  const admin = isAdmin();
  $('delete-category-btn').style.display = admin ? 'inline-flex' : 'none';
  const badges = $('badges'); badges.innerHTML = '';
  if(admin){
    const b = document.createElement('div'); b.className='badge admin-badge'; b.textContent='ADMIN';
    const logout = document.createElement('button'); logout.className='btn btn-ghost'; logout.textContent='Logout'; logout.style.marginLeft='8px';
    logout.addEventListener('click', ()=>{ if(confirm('Logout admin?')){ setAdmin(false); applyTranslations(); }});
    badges.appendChild(b); badges.appendChild(logout);
  }
  const ps = $('filter-platform'); if(ps) ps.disabled = !(isPaid() || admin);
}

function updatePaidUI(){
  const paid = isPaid();
  const badges = $('badges');
  const existingPaid = document.querySelector('.paid-badge'); if(existingPaid) existingPaid.remove();
  if(paid){ const pb = document.createElement('div'); pb.className='badge paid-badge'; pb.textContent='PAID'; badges.appendChild(pb); }
  const locked = !paid && !isAdmin();
  $('save-session').disabled = locked;
  $('add-selected').disabled = locked;
  $('session-lock-info').style.display = locked ? 'block' : 'none';
  const ps = $('filter-platform'); if(ps) ps.disabled = !(paid || isAdmin());
}

function buyAccess(){
  if(isPaid()){ if(confirm('You already have access. Revoke access for testing?')){ setPaid(false); alert('Access revoked.'); } return; }
  if(confirm('Buy access to Training Sessions (simulated)?')){ setPaid(true); alert('Purchase simulated: access granted on this device.'); }
}

/* ================= CRUD: Exercises ================= */
function clearForm(){
  editingId = null;
  $('title').value=''; $('link').value=''; $('description_en').value=''; $('description_da').value='';
  $('duration').value=''; $('players').selectedIndex=0; $('tags').value=''; $('category').selectedIndex=0;
  $('level').selectedIndex = 0; $('intensity').selectedIndex = 0;
  $('save-btn').textContent = t('save_exercise');
}

function findDuplicate(title, link){
  if(!title && !link) return null;
  const t = (title||'').trim().toLowerCase(); const l = (link||'').trim();
  return exercises.find(ex => (ex.title && ex.title.trim().toLowerCase()===t) || (ex.link && ex.link.trim()!=='' && ex.link.trim()===l));
}

function onSave(e){
  e.preventDefault();
  const title = $('title').value.trim();
  if(!title){ alert('Please add a title.'); return; }
  const link = $('link').value.trim();
  const desc_en = $('description_en').value.trim();
  const desc_da = $('description_da').value.trim();
  const category = $('category').value === '__ADD__' ? '' : $('category').value;
  const level = $('level').value;
  const intensity = $('intensity').value;
  const players = $('players').value;

  const dup = findDuplicate(title, link);
  if(dup && (!editingId || editingId !== dup.id)){ alert('Duplicate detected: an exercise with same title or link already exists. Creation cancelled.'); return; }

  const normalizedTags = normalizeTagsInput($('tags').value || '');

  const data = {
    id: editingId || uid(),
    title, description_en: desc_en, description_da: desc_da,
    category, level, players, duration: Number($('duration').value) || 0,
    intensity, link, tags: normalizedTags, favorite:false, created: now()
  };

  if(editingId){
    const idx = exercises.findIndex(x=>x.id===editingId);
    if(idx>-1) exercises[idx] = Object.assign({}, exercises[idx], data);
    editingId = null; $('save-btn').textContent = t('save_exercise');
  } else {
    exercises.unshift(data);
  }

  saveExercises(); renderList(); clearForm();
}

/* ================= RENDER LIST ================= */
function renderList(){
  const q = ($('search').value||'').trim().toLowerCase();
  const filterCat = $('filter-category').value;
  const lvl = $('filter-level').value;
  const platformFilter = $('filter-platform') ? $('filter-platform').value : 'ALL';
  const listEl = $('list'); listEl.innerHTML='';

  let items = exercises.slice();

  if(showOnlyFavorites) items = items.filter(i=>i.favorite);
  if(filterCat && filterCat!=='ALL') items = items.filter(i=>i.category===filterCat);
  if(lvl && lvl!=='ALL') items = items.filter(i=>i.level===lvl);

  if(platformFilter && platformFilter!=='ALL' && (isPaid() || isAdmin())){
    items = items.filter(i => detectPlatform(i.link || '') === platformFilter);
  }

  if(q) items = items.filter(i => {
    const lang = $('lang-select').value || 'en';
    const title = (i.title || '').toLowerCase();
    return title.includes(q) || (i.description_en||'').toLowerCase().includes(q) || (i.description_da||'').toLowerCase().includes(q) || (i.tags||'').toLowerCase().includes(q);
  });

  if(items.length===0){ listEl.innerHTML = '<div class="small">No exercises found ‚Äî try changing filters or create a new exercise.</div>'; updateCounts(); return; }

  items.forEach(ex => {
    const el = document.createElement('div'); el.className='exercise'; el.dataset.id=ex.id;
    const cb = document.createElement('input'); cb.type='checkbox'; cb.className='select-checkbox'; cb.style.marginTop='6px';
    cb.checked = selectedIds.has(ex.id);
    cb.addEventListener('change', ev=>{ if(ev.target.checked) selectedIds.add(ex.id); else selectedIds.delete(ex.id); updateSelectedCount(); });
    el.appendChild(cb);

    const left = document.createElement('div'); left.style.flex='1';
    const h = document.createElement('div'); h.style.display='flex'; h.style.alignItems='center';
    const title = document.createElement('div'); title.textContent = ex.title || '(no title)'; title.style.fontWeight='800'; title.style.fontSize='15px';
    h.appendChild(title);
    const meta = document.createElement('div'); meta.className='meta right'; meta.style.marginLeft='8px';
    meta.innerHTML = `<div class="small">${ex.category||'Uncategorized'} ‚Ä¢ ${ex.level||''} ‚Ä¢ ${ex.players||''} ‚Ä¢ ${ex.duration?ex.duration+'m':''}</div>`;
    h.appendChild(meta);
    left.appendChild(h);

    if(ex.link){ const link = document.createElement('a'); link.href = ex.link; link.textContent = ex.link; link.target='_blank'; link.className='small'; link.style.display='block'; left.appendChild(link); }
    const desc = $('lang-select').value === 'da' ? (ex.description_da || ex.description_en) : (ex.description_en || ex.description_da) || '';
    if(desc){ const p = document.createElement('div'); p.textContent = desc; p.className='small'; p.style.marginTop='6px'; left.appendChild(p); }

    if(ex.tags){
      const wrap = document.createElement('div'); wrap.style.marginTop='8px';
      ex.tags.split(',').map(t=>t.trim()).filter(Boolean).forEach(t=>{
        const sp = document.createElement('span'); sp.className='tag'; sp.textContent = t; wrap.appendChild(sp);
      });
      left.appendChild(wrap);
    }

    const right = document.createElement('div'); right.style.display='flex'; right.style.flexDirection='column'; right.style.alignItems='flex-end'; right.style.gap='8px';
    const fav = document.createElement('button'); fav.className='fav'; fav.innerHTML = ex.favorite ? '‚òÖ' : '‚òÜ'; fav.title='Favorite';
    fav.addEventListener('click', ()=>{ ex.favorite = !ex.favorite; saveExercises(); renderList(); });
    right.appendChild(fav);

    const rowBtns = document.createElement('div'); rowBtns.style.display='flex'; rowBtns.style.gap='8px';
    const edit = document.createElement('button'); edit.className='btn btn-ghost'; edit.textContent='Edit'; edit.addEventListener('click', ()=>editItem(ex.id));
    const del = document.createElement('button'); del.className='btn btn-ghost'; del.textContent='Delete'; del.style.color='var(--danger)'; del.addEventListener('click', ()=>deleteItem(ex.id));
    rowBtns.appendChild(edit); rowBtns.appendChild(del); right.appendChild(rowBtns);

    el.appendChild(left); el.appendChild(right); listEl.appendChild(el);
  });

  updateCounts(); updateSelectedCount();
}

/* ================= EDIT / DELETE ================= */
function editItem(id){
  const ex = exercises.find(x=>x.id===id); if(!ex) return;
  editingId = id;
  $('title').value = ex.title || '';
  $('link').value = ex.link || '';
  $('description_en').value = ex.description_en || '';
  $('description_da').value = ex.description_da || '';
  $('category').value = ex.category || '';
  $('level').value = ex.level || '';
  $('intensity').value = ex.intensity || '';
  $('duration').value = ex.duration || '';
  // set players - if custom not in list, add it temporarily
  if(!playersList.includes(ex.players)){
    playersList.push(ex.players);
    savePlayers(playersList);
    populatePlayers();
  }
  $('players').value = ex.players || playersList[0] || '';
  $('tags').value = ex.tags || '';
  $('save-btn').textContent = 'Save changes';
  window.scrollTo({top:0,behavior:'smooth'});
}

function deleteItem(id){ if(!confirm('Delete this exercise?')) return; exercises = exercises.filter(x=>x.id!==id); saveExercises(); renderList(); }
function onDeleteAll(){ if(!confirm('Delete ALL exercises? This cannot be undone.')) return; exercises=[]; saveExercises(); renderList(); }

/* ================= CATEGORY DELETE (admin) ================= */
function onDeleteCategory(e){ e.preventDefault(); if(!isAdmin()){ alert('Only admin can delete categories.'); return; } const sel=$('category'); const val=sel.value; if(!val||val==='__ADD__'){ alert('Select a real category to delete'); return; } if(!confirm('Delete category "'+val+'"?')) return; categories = categories.filter(c=>c!==val); saveCategories(); populateCategory(); renderList(); }

/* ================= SESSION BUILDER ================= */
/* (unchanged from earlier; omitted for brevity in this comment block) */
function addSelectedToBuilder(){ if(!isPaid() && !isAdmin()){ alert('Upgrade required to add exercises to session builder.'); return; } updateSelectedSetFromUI(); if(selectedIds.size===0){ alert('No exercises selected'); return; } const idsToAdd=Array.from(selectedIds); const builder=$('session-items'); idsToAdd.forEach(id=>{ if(builder.querySelector(`[data-id="${id}"]`)) return; const ex=exercises.find(x=>x.id===id); if(!ex) return; const row=document.createElement('div'); row.className='session-item'; row.dataset.id=ex.id; row.innerHTML=`<div style="flex:1"><div style="font-weight:700">${ex.title||'(no title)'}</div><div class="session-meta">${ex.duration||0} m ‚Ä¢ ${ex.category||''}</div></div><div style="display:flex;gap:8px"><button class="btn btn-ghost">Remove</button></div>`; row.querySelector('button').addEventListener('click', ()=>{ row.remove(); recalcSession(); }); builder.appendChild(row); }); recalcSession(); }
function recalcSession(){ const builder=$('session-items'); const rows=Array.from(builder.children); let total=0; rows.forEach(r=>{ const id=r.dataset.id; const ex=exercises.find(x=>x.id===id); if(ex) total += Number(ex.duration)||0; }); if($('session-total')) $('session-total').textContent = total + ' m'; if($('session-count')) $('session-count').textContent = rows.length + (rows.length===1 ? ' exercise' : ' exercises'); }
function clearBuilder(){ $('session-items').innerHTML=''; if($('session-name')) $('session-name').value=''; if($('session-desc')) $('session-desc').value=''; recalcSession(); }
function saveSessionFromBuilder(){ if(!isPaid() && !isAdmin()){ alert('Upgrade required to save sessions.'); return; } const name=$('session-name').value.trim(); if(!name){ alert('Please add a session name'); return; } const desc=$('session-desc').value.trim(); const items=Array.from($('session-items').children).map(c=>c.dataset.id); if(items.length===0){ alert('Add at least one exercise'); return; } const total=items.reduce((acc,id)=>{ const ex=exercises.find(x=>x.id===id); return acc + (ex?Number(ex.duration)||0:0); },0); const sessionObj={ id:uid(), name, description:desc, items, total, created: now() }; sessions.unshift(sessionObj); saveSessions(); renderSessions(); clearBuilder(); alert('Session saved'); }
function renderSessions(){ const el=$('sessions-list'); el.innerHTML=''; if(sessions.length===0){ el.innerHTML='<div class="small">No saved sessions yet</div>'; return; } sessions.forEach(s=>{ const div=document.createElement('div'); div.className='session-item'; div.innerHTML=`<div style="flex:1"><div style="font-weight:800">${s.name}</div><div class="session-meta">${s.items.length} exercises ‚Ä¢ ${s.total} m</div></div><div style="display:flex;gap:8px"><button class="btn btn-ghost" data-id="${s.id}">Open</button><button class="btn btn-ghost" data-id="edit-${s.id}">Edit</button><button class="btn btn-ghost" data-id="del-${s.id}" style="color:var(--danger)">Delete</button></div>`; div.querySelector('button[data-id="'+s.id+'"]').addEventListener('click', ()=>openSession(s.id)); div.querySelector('button[data-id="edit-'+s.id+'"]').addEventListener('click', ()=>editSession(s.id)); div.querySelector('button[data-id="del-'+s.id+'"]').addEventListener('click', ()=>deleteSession(s.id)); el.appendChild(div); }); }
function openSession(id){ const s=sessions.find(x=>x.id===id); if(!s) return; const lines = s.items.map(iid=>{ const ex = exercises.find(x=>x.id===iid); return ex?`‚Ä¢ ${ex.title} (${ex.duration||0} m)`:'‚Ä¢ (missing)'; }); alert(`${s.name}\n\n${s.description||''}\n\n${lines.join('\n')}\n\nTotal: ${s.total} m`); }
function editSession(id){ const s=sessions.find(x=>x.id===id); if(!s) return; clearBuilder(); $('session-name').value=s.name; $('session-desc').value=s.description||''; s.items.forEach(iid=>{ const ex=exercises.find(x=>x.id===iid); if(!ex) return; const row=document.createElement('div'); row.className='session-item'; row.dataset.id=ex.id; row.innerHTML=`<div style="flex:1"><div style="font-weight:700">${ex.title}</div><div class="session-meta">${ex.duration||0} m ‚Ä¢ ${ex.category||''}</div></div><div style="display:flex;gap:8px"><button class="btn btn-ghost">Remove</button></div>`; row.querySelector('button').addEventListener('click', ()=>{ row.remove(); recalcSession(); }); $('session-items').appendChild(row); }); recalcSession(); sessions = sessions.filter(x=>x.id!==id); saveSessions(); renderSessions(); }
function deleteSession(id){ if(!confirm('Delete session?')) return; sessions = sessions.filter(x=>x.id!==id); saveSessions(); renderSessions(); }

/* ================= Export / Import ================= */
function exportSessions(){ const data=JSON.stringify(sessions,null,2); const blob=new Blob([data],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='lezgo-sessions.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
function importSessionsPrompt(){ const txt = prompt('Paste JSON of sessions to import (overwrites existing sessions).'); if(!txt) return; try{ const arr=JSON.parse(txt); if(!Array.isArray(arr)) throw new Error('JSON did not decode to an array'); sessions = arr.map(s=>Object.assign({id:s.id||uid(),name:s.name||'Imported',items:s.items||[],total:s.total||0,created:s.created||now(),description:s.description||''},s)); saveSessions(); renderSessions(); alert('Imported sessions'); }catch(err){ alert('Import failed: '+(err.message||err)); } }

/* ================= Selection helpers ================= */
function updateCounts(){ const total = exercises.length; const cd = $('count-display'); if(cd) cd.textContent = total + (total===1 ? ' exercise' : ' exercises'); }
function updateSelectedCount(){ const el = $('selected-count'); if(el) el.textContent = selectedIds.size + (selectedIds.size===1 ? ' selected' : ' selected'); }
function updateSelectedSetFromUI(){ selectedIds.clear(); document.querySelectorAll('.select-checkbox').forEach(cb=>{ if(cb.checked){ const root = cb.closest('.exercise'); if(root && root.dataset.id) selectedIds.add(root.dataset.id); }}); updateSelectedCount(); }
function keepSelectionAfterRender(){ document.querySelectorAll('.select-checkbox').forEach(cb=>{ const root = cb.closest('.exercise'); if(root && selectedIds.has(root.dataset.id)) cb.checked=true; cb.addEventListener('change', ()=>updateSelectedCount()); }); }

/* ================= INIT ================= */
loadAll();
init();
keepSelectionAfterRender();

/* register service worker (if present) */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('/service-worker.js').catch(err=>console.warn('SW failed',err));
}

/* ensure save helpers exist at end */
function saveCategories(){ localStorage.setItem(CATS_KEY, JSON.stringify(categories)); }
function saveLevels(arr){ localStorage.setItem(LEVELS_KEY, JSON.stringify(arr)); }
function saveIntensities(arr){ localStorage.setItem(INTENSITIES_KEY, JSON.stringify(arr)); }
function savePlayers(arr){ localStorage.setItem(PLAYERS_KEY, JSON.stringify(arr)); }
function saveExercises(){ localStorage.setItem(EX_KEY, JSON.stringify(exercises)); }
function saveSessions(){ localStorage.setItem(SESS_KEY, JSON.stringify(sessions)); }

</script>
</body>
</html>
