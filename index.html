<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>LezGo Padel ‚Äî Training Bank</title>
  <meta name="theme-color" content="#0f1720" id="meta-theme-color" />
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" href="ICON-192x192.png" sizes="192x192">

  <style>
    /* ---------- RESET ---------- */
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%;margin:0;padding:0;overflow-x:hidden}
    body{font-family:Inter,system-ui,Arial,sans-serif;-webkit-font-smoothing:antialiased;transition:background .25s,color .25s}
    a{color:inherit;text-decoration:none}

    /* ---------- THEME VARIABLES (dark default = antracit) ---------- */
    :root{
      --bg-top: #0f1720;
      --bg-bottom: #071226;
      --panel: #0b1a25;
      --muted: #9aa7b3;
      --text: #e6eef6;
      --accent: #22c55e;
      --accent-dark: #0b4428;
      --danger: #ef4444;
      --card-shadow: 0 10px 28px rgba(2,6,23,.6);
      --border-soft: rgba(255,255,255,.04);
      --max-w:1100px;
    }

    body.light { --bg-top:#caced5; --bg-bottom:#bfc3cb; --panel:#d8dce3; --muted:#3c4652; --text:#0b1220; --accent:#16a34a; --accent-dark:#106b37; --danger:#dc2626; --card-shadow:0 6px 14px rgba(0,0,0,.12); --border-soft: rgba(0,0,0,.14); }

    .app-bg{ background: linear-gradient(180deg,var(--bg-top) 0%,var(--bg-bottom) 100%); color:var(--text);min-height:100vh; padding-bottom:170px; }

    .container{max-width:var(--max-w);margin:14px auto;padding:12px;width:94%}

    header{display:flex;flex-direction:column;align-items:center;gap:12px;margin-bottom:12px;padding-top:8px}
    #logo{width:min(62vw,520px);max-height:26vh;height:auto;display:block;margin:0 auto;object-fit:contain;transition:filter .18s,opacity .18s}
    body.light #logo{filter:brightness(0.65) saturate(1.1) contrast(1.08);opacity:0.98}

    .controls{display:flex;gap:12px;align-items:center;width:100%;justify-content:space-between;flex-wrap:wrap;padding:0 6px}
    .badges{display:flex;gap:8px;align-items:center}
    .badge{background:rgba(255,255,255,.04);padding:6px 10px;border-radius:8px;font-weight:700;color:var(--muted)}

    .btn{border:0;padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer;background:transparent;color:var(--text);display:inline-flex;align-items:center;gap:8px}
    .btn-primary{background:var(--accent);color:#05261a;box-shadow:0 6px 14px rgba(0,0,0,.08)}
    .btn-ghost{background:transparent;border:1px solid var(--border-soft);color:var(--muted);padding:10px 12px}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-small{padding:6px 8px;border-radius:8px;font-weight:700}

    .theme-toggle{height:48px; min-width:48px; display:inline-grid;place-items:center;border-radius:12px; border:1px solid var(--border-soft); background:transparent; cursor:pointer; padding:6px;transition:background .18s, border-color .18s, box-shadow .18s, transform .06s;}
    .theme-toggle svg{width:22px;height:22px;display:block}

    .card{background:var(--panel);border-radius:12px;padding:14px;margin-bottom:14px;box-shadow:var(--card-shadow);transition:background .2s,box-shadow .2s}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=text],input[type=url],input[type=number],select,textarea{width:100%;padding:12px;border-radius:10px;border:1px solid var(--border-soft);background:transparent;color:var(--text);font-size:15px;transition:border-color .15s,background .15s}
    textarea{min-height:84px;resize:vertical}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:680px){.grid{grid-template-columns:1fr}}
    .actions-row{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .two-column{display:grid;grid-template-columns:1fr 380px;gap:12px}
    @media(max-width:980px){.two-column{grid-template-columns:1fr}}
    .exercise{display:flex;gap:10px;padding:10px;border-radius:10px;border:1px solid var(--border-soft);align-items:flex-start}
    .tag{background:rgba(255,255,255,.03);padding:6px 8px;border-radius:8px;margin-right:8px;font-size:13px;display:inline-block}
    .actions-small{display:flex;flex-direction:column;gap:6px}

    /* duplicate highlight */
    .duplicate {
      border: 2px solid var(--danger) !important;
      background: rgba(239,68,68,0.06) !important;
    }

    /* bottom bar - admin only (visibility controlled via JS) */
    #lezgo-bottom-bar{ position: fixed !important; bottom: 12px !important; left: 12px !important; right: 12px !important; width: auto !important; max-width: calc(var(--max-w) - 16px) !important; margin: 0 auto !important; display:flex !important; gap:10px; justify-content: center; align-items: center; padding: 10px; background: linear-gradient(180deg, rgba(0,0,0,0.06), rgba(0,0,0,0.02)); border-radius: 12px; z-index: 99999 !important; box-shadow: 0 10px 28px rgba(0,0,0,0.16); -webkit-backdrop-filter: blur(6px); backdrop-filter: blur(6px); transform: none !important; pointer-events: auto !important; }
    #lezgo-bottom-bar .lezgo-btn { padding: .6rem .9rem; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; background: var(--accent); color: white; min-width:110px; text-align:center; display:inline-block !important; visibility:visible !important; }
    #lezgo-bottom-bar .lezgo-btn.restore { background:transparent; color:var(--text); border:1px solid var(--border-soft) }
    #lezgo-bottom-bar input[type=file]{ display:none }

    /* SoMe filter pills */
    .platform-filters{display:flex;gap:6px;align-items:center}
    .platform-filters button{padding:6px 10px;border-radius:999px;border:1px solid var(--border-soft);background:transparent;color:var(--muted);cursor:pointer}
    .platform-filters button.active{background:var(--accent);color:#05261a;border-color:transparent}

    /* session detail */
    #session-detail-modal{ position: fixed; inset:0; z-index:100000; display:none; align-items:center; justify-content:center; background: linear-gradient(180deg, rgba(2,6,23,0.8), rgba(2,6,23,0.9)); padding:20px; }
    #session-detail-modal .modal-card{ width:100%; max-width:900px; max-height:96vh; overflow:auto; border-radius:12px; padding:18px; background:var(--panel); box-shadow:0 20px 60px rgba(0,0,0,0.6); }
    @media(max-width:520px){ .container { padding:10px 10px 200px } }

    /* dark select fix */
    body:not(.light) select, body:not(.light) select option, body:not(.light) select optgroup { color: var(--text) !important; background: var(--panel) !important; }
  </style>
</head>

<body class="app-bg">
  <div class="container">
    <header>
      <img id="logo" src="lezgo-logo.svg" alt="LezGo logo">
      <div class="controls">
        <div class="badges" id="badges"></div>
        <div style="display:flex;gap:10px;align-items:center">
          <select id="lang-select" style="padding:8px;border-radius:8px;border:1px solid var(--border-soft);background:transparent;color:var(--text)" aria-label="Language select">
            <option value="en">English</option>
            <option value="da">Dansk</option>
          </select>

          <button id="btn-buy" class="btn btn-primary" data-i18n="buyAccess">Buy access</button>

          <!-- Admin login / logout -->
          <button id="btn-admin" class="btn btn-ghost" data-i18n="adminLogin">Admin login</button>
          <button id="btn-logout-header" class="btn btn-ghost" style="display:none; color:var(--danger)">Log out</button>

          <button id="theme-toggle" class="theme-toggle" title="Toggle theme" aria-label="Toggle theme">
            <svg id="theme-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"></svg>
          </button>
        </div>
      </div>
    </header>

    <section class="card">
      <h3 data-i18n="addEditTitle" style="margin:0 0 10px 0;color:var(--muted)">Add / Edit exercise (Padel)</h3>

      <form id="exercise-form" class="grid" onsubmit="return false;">
        <div style="grid-column:1/-1;">
          <label id="label-title" data-i18n="titleLabel">Title</label>
          <input id="title" type="text" placeholder="e.g. Forehand topspin drill" data-i18n-placeholder="titlePlaceholder" autocomplete="off">
        </div>

        <div>
          <label id="label-category" data-i18n="categoryLabel">Category</label>
          <select id="category"></select>
        </div>

        <div>
          <label id="label-players" data-i18n="playersLabel">Players</label>
          <select id="players"></select>
        </div>

        <div>
          <label id="label-duration" data-i18n="durationLabel">Duration (minutes)</label>
          <input id="duration" type="number" min="0" placeholder="20">
        </div>

        <div>
          <label id="label-level" data-i18n="levelLabel">Level</label>
          <select id="level"></select>
        </div>

        <div>
          <label id="label-intensity" data-i18n="intensityLabel">Intensity</label>
          <select id="intensity"></select>
        </div>

        <div style="grid-column:1/-1;">
          <label id="label-video" data-i18n="videoLabel">Video link (YouTube / Instagram / Facebook)</label>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="link" type="url" placeholder="https://..." data-i18n-placeholder="videoPlaceholder" style="flex:1" autocomplete="off">
            <button id="analyze-btn" class="btn btn-ghost" title="Analyze video">üîç Analyze</button>
          </div>
        </div>

        <div style="grid-column:1/-1;">
          <label id="label-description" data-i18n="descriptionLabel">Description</label>
          <textarea id="description" placeholder="Short description"></textarea>
        </div>

        <div style="grid-column:1/-1;">
          <label id="label-tags" data-i18n="tagsLabel">Tags (comma separated)</label>
          <input id="tags" type="text" placeholder="e.g. Cross, Chiquita, Vibora" data-i18n-placeholder="tagsPlaceholder">
        </div>

        <div class="actions-row" style="grid-column:1/-1;margin-top:4px;">
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button id="save-btn" class="btn btn-primary" data-i18n="saveBtn">‚ûï Save exercise</button>
            <button id="clear-btn" class="btn btn-ghost" data-i18n="clearBtn">Clear form</button>
          </div>
          <button id="delete-all-btn" class="btn btn-danger" data-i18n="deleteAllBtn" style="display:none">üóëÔ∏è Delete all</button>
        </div>
      </form>
    </section>

    <section class="card">
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;align-items:center">
        <input id="search" type="text" placeholder="Search..." style="flex:1;padding:10px;border-radius:10px;border:1px solid var(--border-soft);background:transparent;color:var(--text)" data-i18n-placeholder="searchPlaceholder">
        <div class="platform-filters" aria-hidden="false" title="Filter by platform">
          <button data-platform="youtube" class="platform-btn" id="pf-y">YouTube</button>
          <button data-platform="instagram" class="platform-btn" id="pf-i">Instagram</button>
          <button data-platform="facebook" class="platform-btn" id="pf-f">Facebook</button>
        </div>
        <select id="filter-category" style="padding:10px;border-radius:10px;border:1px solid var(--border-soft);background:transparent;color:var(--text)"><option>ALL</option></select>
        <select id="filter-level" style="padding:10px;border-radius:10px;border:1px solid var(--border-soft);background:transparent;color:var(--text)"><option>ALL</option></select>
        <button id="show-favorites" class="btn btn-ghost" data-i18n="showFavorites">Show favorites</button>
      </div>

      <div class="two-column">
        <div>
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap">
            <button id="select-all" class="btn btn-ghost" data-i18n="selectAll">Select all</button>
            <button id="add-selected" class="btn btn-primary" data-i18n="addToSession">Add to session</button>
            <div style="margin-left:auto" id="selected-count">0 selected</div>
          </div>
          <div id="list"></div>
        </div>

        <aside class="card">
          <h4 style="margin:0" data-i18n="sessionBuilderTitle">Training Session Builder</h4>

          <label data-i18n="sessionNameLabel">Session name</label>
          <input id="session-name" type="text">

          <label style="margin-top:8px" data-i18n="sessionDescLabel">Session description</label>
          <input id="session-desc" type="text">

          <label style="margin-top:8px" data-i18n="exercisesLabel">Exercises</label>
          <div id="session-items" style="max-height:240px;overflow:auto"></div>

          <div style="display:flex;gap:10px;align-items:center;margin-top:10px;">
            <div data-i18n="totalLabel">Total:</div>
            <div id="session-total" style="font-weight:700">0 m</div>
            <div style="margin-left:auto" id="session-count">0 exercises</div>
          </div>

          <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
            <button id="save-session" class="btn btn-primary" data-i18n="saveSession" style="display:none">Save session</button>
            <button id="clear-session" class="btn btn-ghost" data-i18n="clearSession" style="display:none">Clear</button>
          </div>

          <div id="session-lock-info" style="margin-top:14px;color:var(--muted);display:none;" data-i18n="freeInfo">
            Free users cannot save or build sessions. Buy access to unlock.
          </div>

          <hr style="border:none;border-top:1px solid var(--border-soft);margin:14px 0">
          <h4 style="margin:0 0 6px 0;" data-i18n="savedSessionsTitle">Saved sessions</h4>
          <div id="sessions-list" style="max-height:200px;overflow:auto"></div>
        </aside>
      </div>
    </section>
  </div><!-- container end -->

  <!-- Full-screen session detail modal -->
  <div id="session-detail-modal" role="dialog" aria-modal="true" tabindex="-1">
    <div class="modal-card" role="document">
      <div class="modal-header">
        <h2 id="session-detail-title">Session</h2>
        <div style="color:var(--muted);font-size:13px" id="session-detail-meta"></div>
        <div class="modal-close" style="margin-left:auto">
          <button id="session-detail-close" class="btn btn-ghost">Close</button>
        </div>
      </div>
      <div id="session-detail-body" style="margin-top:12px"></div>
    </div>
  </div>

  <!-- Bottom bar: Backup + Restore (admin only) -->
  <div id="lezgo-bottom-bar" aria-hidden="true" style="display:none">
    <button id="btn-backup" class="lezgo-btn">Backup</button>
    <label for="file-restore" class="lezgo-btn restore" style="cursor:pointer">Restore</label>
    <input id="file-restore" type="file" accept="application/json" />
  </div>

  <!-- Admin modal -->
  <div id="admin-modal" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:999">
    <div style="background:var(--panel);padding:14px;border-radius:10px;max-width:420px;width:92%">
      <h3 style="margin-top:0" data-i18n="adminLogin">Admin login</h3>
      <input id="admin-password" type="password" placeholder="Password" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border-soft);margin-bottom:12px">
      <div style="display:flex;gap:12px;justify-content:flex-end">
        <button id="admin-cancel" class="btn btn-ghost" data-i18n="cancelBtn">Cancel</button>
        <button id="admin-submit" class="btn btn-primary" data-i18n="loginBtn">Login</button>
      </div>
    </div>
  </div>

  <script>
    /* CONFIG & KEYS */
    const ADMIN_PASSWORD = "admin123";
    const EX_KEY = "lezgo_exercises_v1";
    const CAT_KEY = "lezgo_categories_v1";
    const LVL_KEY = "lezgo_levels_v1";
    const INT_KEY = "lezgo_intensities_v1";
    const PLR_KEY = "lezgo_players_v1";
    const SES_KEY = "lezgo_sessions_v1";
    const THEME_KEY = 'lezgo_theme';
    const LANG_KEY = 'lezgo_lang';
    const STORAGE_META_KEY = 'lezgo_meta_v1';

    const DEFAULT_CATEGORIES = ["Back wall","Bandeja","Chiquita","Defense","Double wall","Groundstroke","Lob","Serve","Smash","Vibora","Volley"].sort();
    const DEFAULT_LEVELS = ["Beginner","Intermediate","Advanced"];
    const DEFAULT_INT = ["Low","Medium","High"];
    const DEFAULT_PLAYERS = ["1","2","3","4","1-2","1-3","1-4","2-4","Any","Add new..."];

    const translations = {
      en: { addEditTitle:"Add / Edit exercise (Padel)", titleLabel:"Title", titlePlaceholder:"e.g. Forehand topspin drill", categoryLabel:"Category", playersLabel:"Players", durationLabel:"Duration (minutes)", levelLabel:"Level", intensityLabel:"Intensity", videoLabel:"Video link (YouTube / Instagram / Facebook)", videoPlaceholder:"https://...", descriptionLabel:"Description", tagsLabel:"Tags (comma separated)", tagsPlaceholder:"e.g. Cross, Chiquita, Vibora", saveBtn:"‚ûï Save exercise", clearBtn:"Clear form", deleteAllBtn:"üóëÔ∏è Delete all", searchPlaceholder:"Search...", filterAll:"ALL", showFavorites:"Show favorites", selectAll:"Select all", addToSession:"Add to session", selectedCountSuffix:" selected", sessionBuilderTitle:"Training Session Builder", sessionNameLabel:"Session name", sessionDescLabel:"Session description", exercisesLabel:"Exercises", totalLabel:"Total:", saveSession:"Save session", clearSession:"Clear", freeInfo:"Free users cannot save or build sessions. Buy access to unlock.", noMatches:"No matches", noSessions:"No sessions saved", buyAccess:"Buy access", adminLogin:"Admin login", cancelBtn:"Cancel", loginBtn:"Login", savedSessionsTitle:"Saved sessions", openBtn:"Open", deleteBtn:"Delete", deleteConfirm:"Delete item?", deleteSessionConfirm:"Delete session?" },
      da: { addEditTitle:"Tilf√∏j / Rediger √∏velse (Padel)", titleLabel:"Titel", titlePlaceholder:"f.eks. Forehand topspin drill", categoryLabel:"Kategori", playersLabel:"Spillere", durationLabel:"Varighed (minutter)", levelLabel:"Niveau", intensityLabel:"Intensitet", videoLabel:"Videolink (YouTube / Instagram / Facebook)", videoPlaceholder:"https://...", descriptionLabel:"Beskrivelse", tagsLabel:"Tags (kommasepareret)", tagsPlaceholder:"f.eks. Cross, Chiquita, Vibora", saveBtn:"‚ûï Gem √∏velse", clearBtn:"Ryd formular", deleteAllBtn:"üóëÔ∏è Slet alle", searchPlaceholder:"S√∏g...", filterAll:"ALLE", showFavorites:"Vis favoritter", selectAll:"V√¶lg alle", addToSession:"Tilf√∏j til session", selectedCountSuffix:" valgt", sessionBuilderTitle:"Byg tr√¶ningssession", sessionNameLabel:"Sessionsnavn", sessionDescLabel:"Sessionsbeskrivelse", exercisesLabel:"√òvelser", totalLabel:"Total:", saveSession:"Gem session", clearSession:"Ryd", freeInfo:"Gratis brugere kan ikke gemme eller bygge sessioner. K√∏b adgang for at l√•se op.", noMatches:"Ingen resultater", noSessions:"Ingen gemte sessioner", buyAccess:"K√∏b adgang", adminLogin:"Admin login", cancelBtn:"Annuller", loginBtn:"Login", savedSessionsTitle:"Gemte sessioner", openBtn:"√Öbn", deleteBtn:"Slet", deleteConfirm:"Slet vare?", deleteSessionConfirm:"Slet session?" }
    };

    /* STATE */
    let exercises = []; let categories = []; let levels = []; let intensities = []; let players = []; let sessions = []; let editingId = null; let selectedIds = new Set();
    const $ = id => document.getElementById(id);
    const uid = () => "id_" + Math.random().toString(36).slice(2,10);
    const isAdmin = () => localStorage.getItem("is_admin") === "1";
    const isPaid  = () => localStorage.getItem("is_paid") === "1";

    /* THEME */
    function applyTheme(theme){ if(theme === 'light'){ document.body.classList.add('light'); document.querySelector('#meta-theme-color').setAttribute('content','#eceff1'); setThemeIcon('light'); } else { document.body.classList.remove('light'); document.querySelector('#meta-theme-color').setAttribute('content','#0f1720'); setThemeIcon('dark'); } localStorage.setItem(THEME_KEY, theme); }
    function toggleTheme(){ const current = localStorage.getItem(THEME_KEY) || 'dark'; const next = current === 'dark' ? 'light' : 'dark'; applyTheme(next); }
    function setThemeIcon(mode){ const svg = document.getElementById('theme-icon'); if(!svg) return; if(mode === 'light'){ svg.innerHTML = '<path d="M12 3v2M12 19v2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M1 12h2M21 12h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4M12 7a5 5 0 100 10 5 5 0 000-10z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>'; } else { svg.innerHTML = '<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>'; } }

    /* STORAGE LOAD */
    function loadAll(){ exercises = JSON.parse(localStorage.getItem(EX_KEY) || "[]"); categories = JSON.parse(localStorage.getItem(CAT_KEY) || "null") || DEFAULT_CATEGORIES; levels = JSON.parse(localStorage.getItem(LVL_KEY) || "null") || DEFAULT_LEVELS; intensities = JSON.parse(localStorage.getItem(INT_KEY) || "null") || DEFAULT_INT; players = JSON.parse(localStorage.getItem(PLR_KEY) || "null") || DEFAULT_PLAYERS; sessions = JSON.parse(localStorage.getItem(SES_KEY) || "[]"); saveBase(); }
    function saveBase(){ localStorage.setItem(CAT_KEY, JSON.stringify(categories)); localStorage.setItem(LVL_KEY, JSON.stringify(levels)); localStorage.setItem(INT_KEY, JSON.stringify(intensities)); localStorage.setItem(PLR_KEY, JSON.stringify(players)); saveMeta(); }
    function saveMeta(){ const meta = { theme: localStorage.getItem(THEME_KEY) || 'dark', lang: localStorage.getItem(LANG_KEY) || 'en', updatedAt: new Date().toISOString() }; localStorage.setItem(STORAGE_META_KEY, JSON.stringify(meta)); }

    /* I18N */
    function t(key){ const lang = localStorage.getItem(LANG_KEY) || 'en'; return (translations[lang] && translations[lang][key]) || (translations.en[key] || ''); }
    function applyTranslationsToDOM(){ document.querySelectorAll('[data-i18n]').forEach(el=>{ const k = el.getAttribute('data-i18n'); if(k) el.textContent = t(k); }); document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{ const k = el.getAttribute('data-i18n-placeholder'); if(k) el.placeholder = t(k); }); const fc = $("filter-category"); if(fc && fc.options.length>0) fc.options[0].text = t('filterAll'); const fl = $("filter-level"); if(fl && fl.options.length>0) fl.options[0].text = t('filterAll'); updateSelectedCount(); renderList(); renderSessions(); updateBadges(); }

    /* UI population */
    function populateCategories(){ const sel = $("category"); const fil = $("filter-category"); if(!sel||!fil) return; sel.innerHTML=""; fil.innerHTML=""; let optAll = document.createElement("option"); optAll.textContent = t('filterAll'); optAll.value = ""; fil.appendChild(optAll); categories.forEach(c=>{ let o=document.createElement("option"); o.value=c; o.textContent=c; sel.appendChild(o); let f=document.createElement("option"); f.value=c; f.textContent=c; fil.appendChild(f); }); let add=document.createElement("option"); add.value="__ADD__"; add.textContent = (localStorage.getItem(LANG_KEY) === 'da') ? "Tilf√∏j ny kategori..." : "Add new category..."; sel.appendChild(add); }
    function populateLevels(){ const sel = $("level"); const fil = $("filter-level"); if(!sel||!fil) return; sel.innerHTML=""; fil.innerHTML=""; let optAll = document.createElement("option"); optAll.textContent = t('filterAll'); optAll.value = ""; fil.appendChild(optAll); levels.forEach(c=>{ let o=document.createElement("option"); o.value=c; o.textContent=c; sel.appendChild(o); let f=document.createElement("option"); f.value=c; f.textContent=c; fil.appendChild(f); }); let add=document.createElement("option"); add.value="__ADD__"; add.textContent = (localStorage.getItem(LANG_KEY) === 'da') ? "Tilf√∏j nyt niveau..." : "Add new level..."; sel.appendChild(add); }
    function populateIntensity(){ const sel=$("intensity"); if(!sel) return; sel.innerHTML=""; intensities.forEach(c=>{ let o=document.createElement("option"); o.value=c; o.textContent=c; sel.appendChild(o); }); let add=document.createElement("option"); add.value="__ADD__"; add.textContent = (localStorage.getItem(LANG_KEY) === 'da') ? "Tilf√∏j ny intensitet..." : "Add new intensity..."; sel.appendChild(add); }
    function populatePlayers(){ const sel=$("players"); if(!sel) return; sel.innerHTML=""; players.forEach(c=>{ let o=document.createElement("option"); o.value=c; o.textContent=c; sel.appendChild(o); }); }

    /* PLATFORM FILTER STATE (set of selected platforms) */
    const platformState = new Set(); // possible values: 'youtube','instagram','facebook'

    /* INIT */
    function init(){
      const savedTheme = localStorage.getItem(THEME_KEY) || 'dark'; applyTheme(savedTheme);
      const savedLang = localStorage.getItem(LANG_KEY) || 'en'; $("lang-select").value = savedLang;
      loadAll(); populateCategories(); populateLevels(); populateIntensity(); populatePlayers(); bindEvents(); applyTranslationsToDOM(); renderList(); renderSessions(); updateBadges(); enforcePermissions();
    }

    /* EVENTS */
    function bindEvents(){
      $("theme-toggle").addEventListener("click", toggleTheme);
      $("btn-admin").addEventListener("click", ()=> $("admin-modal").style.display="flex");
      $("admin-cancel").addEventListener("click", ()=> $("admin-modal").style.display="none");
      $("admin-submit").addEventListener("click", ()=>{ if($("admin-password").value===ADMIN_PASSWORD){ localStorage.setItem("is_admin","1"); $("admin-modal").style.display="none"; updateBadges(); updateSessionLock(); enforcePermissions(); alert('Admin enabled'); } else alert("Wrong password"); });

      $("btn-buy").addEventListener("click", ()=>{ if(isPaid()){ if(confirm(localStorage.getItem(LANG_KEY)==='da'?"Deaktiver betalt adgang?":"Disable paid access?")){ localStorage.removeItem("is_paid"); updateBadges(); updateSessionLock(); enforcePermissions(); } } else { if(confirm(localStorage.getItem(LANG_KEY)==='da'?"Simuler k√∏b?":"Simulate purchase?")){ localStorage.setItem("is_paid","1"); updateBadges(); updateSessionLock(); enforcePermissions(); } } });

      $("btn-logout-header").addEventListener("click", ()=>{ localStorage.removeItem("is_admin"); updateBadges(); updateSessionLock(); enforcePermissions(); $("btn-logout-header").style.display="none"; alert('Logged out'); });

      $("category").addEventListener("change", e=>{ if(e.target.value==="__ADD__"){ let n=prompt(localStorage.getItem(LANG_KEY)==='da'?"Ny kategori:":"New category:"); if(n){ categories.push(n.trim()); saveBase(); populateCategories(); } }});
      $("level").addEventListener("change", e=>{ if(e.target.value==="__ADD__"){ let n=prompt(localStorage.getItem(LANG_KEY)==='da'?"Nyt niveau:":"New level:"); if(n){ levels.push(n.trim()); saveBase(); populateLevels(); } }});
      $("intensity").addEventListener("change", e=>{ if(e.target.value==="__ADD__"){ let n=prompt(localStorage.getItem(LANG_KEY)==='da'?"Ny intensitet:":"New intensity:"); if(n){ intensities.push(n.trim()); saveBase(); populateIntensity(); } }});
      $("players").addEventListener("change", e=>{ if(e.target.value==="Add new..."||e.target.value==="__ADD__"){ let n=prompt(localStorage.getItem(LANG_KEY)==='da'?"Tilf√∏j ny spiller-range:":"Add new players range:"); if(n){ players.push(n.trim()); saveBase(); populatePlayers(); } }});

      $("save-btn").addEventListener("click", onSave);
      $("clear-btn").addEventListener("click", clearForm);
      $("delete-all-btn").addEventListener("click", ()=>{ if(!isAdmin()){ alert('Admin access required'); return; } const pass = prompt('Enter admin password to confirm Delete ALL:'); if(pass !== ADMIN_PASSWORD){ alert('Wrong admin code'); return; } if(confirm(localStorage.getItem(LANG_KEY)==='da'?"Slet ALLE √∏velser?":"Delete ALL exercises?")){ exercises=[]; localStorage.setItem(EX_KEY,"[]"); renderList(); }});

      $("search").addEventListener("input", renderList);
      $("filter-category").addEventListener("change", renderList);
      $("filter-level").addEventListener("change", renderList);

      $("show-favorites").addEventListener("click", ()=>{ let b=$("show-favorites"); b.textContent = b.textContent===t('showFavorites') ? ((localStorage.getItem(LANG_KEY)==='da')?"Vis alle":"Show all") : t('showFavorites'); renderList(); });

      $("select-all").addEventListener("click", ()=>{ document.querySelectorAll(".select-item").forEach(ch=>ch.checked=true); updateSelectedSet(); });
      $("add-selected").addEventListener("click", ()=>{ if(!isAdmin() && !isPaid()){ alert(localStorage.getItem(LANG_KEY)==='da'?"Betalt adgang kr√¶ves.":"Paid access required."); return; } addSelectedToSession(); });
      $("save-session").addEventListener("click", ()=>{ if(!isAdmin() && !isPaid()){ alert(localStorage.getItem(LANG_KEY)==='da'?"Betalt adgang kr√¶ves.":"Paid access required."); return; } saveSession(); });
      $("clear-session").addEventListener("click", ()=>{ if(!isAdmin() && !isPaid()){ alert(localStorage.getItem(LANG_KEY)==='da'?"Betalt adgang kr√¶ves.":"Paid access required."); return; } clearSessionBuilder(); });

      $("lang-select").addEventListener("change", (e)=>{ const lang = e.target.value || 'en'; localStorage.setItem(LANG_KEY, lang); applyTranslationsToDOM(); populateCategories(); populateLevels(); populateIntensity(); populatePlayers(); });

      $("analyze-btn").addEventListener('click', async (ev)=>{ ev.preventDefault(); const link = $("link").value.trim(); if(!link){ alert(localStorage.getItem(LANG_KEY)==='da' ? "Inds√¶t et videolink f√∏rst" : "Please paste a video link first"); return; } const btn = ev.currentTarget; const prev = btn.textContent; btn.textContent = localStorage.getItem(LANG_KEY)==='da' ? "Analyserer‚Ä¶" : "Analysing‚Ä¶"; btn.disabled = true; try{ const meta = await fetchVideoMetadata(link); if(meta){ if(meta.title) $("title").value = meta.title; if(meta.description) $("description").value = meta.description; const suggestions = analyzeTextToFields(meta.title || "", meta.description || "", localStorage.getItem(LANG_KEY) || 'en'); if(!$("category").value || $("category").value === "") { if(suggestions.category) { if(!categories.includes(suggestions.category)) { categories.push(suggestions.category); saveBase(); populateCategories(); } $("category").value = suggestions.category; } } if(!$("players").value || $("players").value==="") $("players").value = suggestions.players || $("players").options[0].value; if(!$("level").value || $("level").value==="") $("level").value = suggestions.level || $("level").options[0].value; if(!$("intensity").value || $("intensity").value==="") $("intensity").value = suggestions.intensity || $("intensity").options[0].value; if(!$("tags").value || $("tags").value==="") $("tags").value = suggestions.tags || ""; console.log("Analysis suggestions:", suggestions); } else { alert(localStorage.getItem(LANG_KEY)==='da' ? "Kunne ikke hente metadata for videoen. Pr√∏v med et YouTube-link eller tjek CORS." : "Could not fetch video metadata. Try a YouTube link or check CORS."); } }catch(err){ console.error("Analyze error:", err); alert(localStorage.getItem(LANG_KEY)==='da' ? "Fejl under analyse" : "Error during analysis"); } finally{ btn.textContent = prev; btn.disabled = false; } });

      // Bottom bar backup/restore
      $("btn-backup").addEventListener("click", onBackup);
      $("file-restore").addEventListener("change", onRestoreFile);

      // Platform filter buttons
      document.querySelectorAll('.platform-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const p = btn.getAttribute('data-platform');
          if (platformState.has(p)) { platformState.delete(p); btn.classList.remove('active'); }
          else { platformState.add(p); btn.classList.add('active'); }
          renderList();
        });
      });
    }

    /* Helpers for platform detection */
    function linkPlatform(link){
      if(!link) return null;
      try{
        const u = new URL(link);
        const h = u.hostname.toLowerCase();
        if(h.includes('youtube') || h.includes('youtu.be')) return 'youtube';
        if(h.includes('instagram')) return 'instagram';
        if(h.includes('facebook')) return 'facebook';
      }catch(e){}
      return null;
    }

    /* SAVE EXERCISE with duplicate checks (title OR link) */
    function onSave(){
      let title = $("title").value.trim();
      let link = $("link").value.trim();
      if(!title){ alert(localStorage.getItem(LANG_KEY)==='da'?"Indtast titel":"Enter title"); return; }

      // duplicate checks (case-insensitive title, exact link)
      const titleLC = title.toLowerCase();
      const dupByTitle = exercises.filter(e => (e.title||'').toLowerCase() === titleLC && e.id !== editingId);
      const dupByLink = link ? exercises.filter(e => (e.link||'') === link && e.id !== editingId) : [];

      // clear previous duplicate highlights
      document.querySelectorAll('.duplicate').forEach(el => el.classList.remove('duplicate'));

      if(dupByTitle.length || dupByLink.length){
        // highlight matching saved items
        const idsToHighlight = new Set([...dupByTitle.map(d=>d.id), ...dupByLink.map(d=>d.id)]);
        idsToHighlight.forEach(id => {
          const node = document.querySelector(`.exercise[data-id="${id}"]`);
          if(node) {
            node.classList.add('duplicate');
            node.scrollIntoView({behavior:'smooth', block:'center'});
          }
        });
        alert(localStorage.getItem(LANG_KEY)==='da' ? "Duplikat fundet: titel eller link findes allerede. Tjek de markerede √∏velser." : "Duplicate found: same title or link already exists. The matching saved items are highlighted.");
        return; // do not save duplicates
      }

      let ex = { id: editingId || uid(), title, category: $("category").value, players: $("players").value, duration: Number($("duration").value||0), level: $("level").value, intensity: $("intensity").value, link: link, description: $("description").value.trim(), tags: normalizeTags($("tags").value.trim()), favorite:false, createdAt: new Date().toISOString() };
      if(editingId){ let idx = exercises.findIndex(x=>x.id===editingId); if(idx>-1) exercises[idx]=ex; } else exercises.unshift(ex);
      localStorage.setItem(EX_KEY, JSON.stringify(exercises));
      clearForm(); renderList();
    }

    function normalizeTags(str){ if(!str) return ""; return str.split(",").map(t=>t.replace(/^#+/,"").trim()).filter(Boolean).join(", "); }
    function clearForm(){ editingId=null; $("title").value=""; if($("category")) $("category").selectedIndex=0; if($("players")) $("players").selectedIndex=0; $("duration").value=""; if($("level")) $("level").selectedIndex=0; if($("intensity")) $("intensity").selectedIndex=0; $("link").value=""; $("description").value=""; $("tags").value=""; $("save-btn").textContent=t('saveBtn'); }

    /* RENDER LIST with platform filter and permissioned Edit/Delete */
    function renderList(){
      // clear previous duplicate classes
      document.querySelectorAll('.duplicate').forEach(el => el.classList.remove('duplicate'));

      let q = ($("search") && $("search").value.trim().toLowerCase()) || "";
      let fc = ($("filter-category") && $("filter-category").value) || "";
      let fl = ($("filter-level") && $("filter-level").value) || "";
      let list = $("list"); if(!list) return; list.innerHTML="";
      let items = exercises.slice();

      // platform filter: if user selected any platform(s), only include those matching
      if(platformState.size > 0){
        items = items.filter(it => {
          const p = linkPlatform(it.link);
          return p && platformState.has(p);
        });
      }

      if(fc && fc!=="") items = items.filter(x=>x.category===fc);
      if(fl && fl!=="") items = items.filter(x=>x.level===fl);
      if(q) items = items.filter(x => x.title.toLowerCase().includes(q) || (x.description||"").toLowerCase().includes(q) || (x.tags||"").toLowerCase().includes(q) );
      if($("show-favorites") && $("show-favorites").textContent!==t('showFavorites')) items = items.filter(x=>x.favorite);
      if(items.length===0){ list.innerHTML = `<div style="color:var(--muted)">${t('noMatches')}</div>`; return; }

      items.forEach(ex=>{
        let row=document.createElement("div"); row.className="exercise"; row.dataset.id=ex.id;
        let cb=document.createElement("input"); cb.type="checkbox"; cb.className="select-item"; cb.addEventListener("change", updateSelectedSet); row.appendChild(cb);
        let left=document.createElement("div"); left.style.flex="1";
        let ttitle=document.createElement("div"); ttitle.style.fontWeight="800"; ttitle.style.fontSize="15px"; ttitle.textContent=ex.title; left.appendChild(ttitle);
        let meta=document.createElement("div"); meta.style.color="var(--muted)"; meta.style.marginTop="6px"; meta.textContent = `${ex.category} ‚Ä¢ ${ex.level} ‚Ä¢ ${ex.players} ‚Ä¢ ${ex.duration}m`; left.appendChild(meta);
        if(ex.link){
          let a=document.createElement("a"); a.href=ex.link; a.target="_blank"; a.textContent=ex.link; a.style.color="var(--muted)"; a.style.display="block"; a.style.marginTop="6px";
          // platform icon label
          const p = linkPlatform(ex.link);
          if(p){
            const sp = document.createElement('span'); sp.style.marginLeft='8px'; sp.style.color='var(--muted)'; sp.style.fontSize='12px'; sp.textContent = `(${p})`;
            a.appendChild(sp);
          }
          left.appendChild(a);
        }
        if(ex.tags){
          let tags=document.createElement("div"); tags.style.marginTop="8px";
          ex.tags.split(",").forEach(tg=>{ let s=document.createElement("span"); s.className="tag"; s.textContent=tg.trim(); tags.appendChild(s); });
          left.appendChild(tags);
        }
        row.appendChild(left);

        let right=document.createElement("div"); right.className="actions-small";
        // Edit: only for paid or admin
        if(isAdmin() || isPaid()){
          let edit=document.createElement("button"); edit.className="btn btn-ghost"; edit.textContent=(localStorage.getItem(LANG_KEY)==='da'?"Rediger":"Edit"); edit.addEventListener("click", ()=>{ if(!isAdmin() && !isPaid()){ alert('Paid access required'); return; } editItem(ex.id); }); right.appendChild(edit);
        }
        // Delete: only for paid or admin (paid allowed per-item delete)
        if(isAdmin() || isPaid()){
          let del=document.createElement("button"); del.className="btn btn-ghost"; del.style.color="var(--danger)"; del.textContent=(localStorage.getItem(LANG_KEY)==='da'?"Slet":"Delete");
          del.addEventListener("click", ()=>{ if(!isAdmin() && !isPaid()){ alert('Admin or Paid access required'); return; } if(confirm(t('deleteConfirm'))){ exercises = exercises.filter(x=>x.id!==ex.id); localStorage.setItem(EX_KEY, JSON.stringify(exercises)); renderList(); } });
          right.appendChild(del);
        }

        row.appendChild(right); list.appendChild(row);
      });
      updateSelectedSet();
    }

    function editItem(id){ let ex = exercises.find(x=>x.id===id); if(!ex) return; editingId=id; $("title").value=ex.title; $("category").value=ex.category; $("players").value=ex.players; $("duration").value=ex.duration; $("level").value=ex.level; $("intensity").value=ex.intensity; $("link").value=ex.link; $("description").value=ex.description; $("tags").value=ex.tags; $("save-btn").textContent = t('saveBtn'); window.scrollTo({top:0,behavior:"smooth"}); }

    /* SESSION BUILDER (unchanged permissions) */
    function updateSelectedSet(){ selectedIds.clear(); document.querySelectorAll(".select-item").forEach(cb=>{ if(cb.checked) selectedIds.add(cb.closest(".exercise").dataset.id); }); updateSelectedCount(); }
    function updateSelectedCount(){ const suffix = t('selectedCountSuffix') || ' selected'; if($("selected-count")) $("selected-count").textContent = (selectedIds.size || 0) + suffix; }
    function addSelectedToSession(){ if(!isAdmin() && !isPaid()){ alert(localStorage.getItem(LANG_KEY)==='da'?"Betalt adgang kr√¶ves.":"Paid access required."); return; } let box=$("session-items"); selectedIds.forEach(id=>{ if(box.querySelector(`[data-id="${id}"]`)) return; let ex=exercises.find(x=>x.id===id); if(!ex) return; let row=document.createElement("div"); row.className="exercise"; row.dataset.id=id; row.innerHTML=`<div style="flex:1"><div style="font-weight:700">${ex.title}</div><div style="color:var(--muted)">${ex.duration}m ‚Ä¢ ${ex.category}</div></div><button class="btn btn-ghost remove-from-session" style="color:var(--danger)">${localStorage.getItem(LANG_KEY)==='da'?"Fjern":"Remove"}</button>`; row.querySelector("button").addEventListener("click", ()=>{ row.remove(); recalcSession(); }); box.appendChild(row); }); recalcSession(); }
    function recalcSession(){ let total=0,count=0; document.querySelectorAll("#session-items .exercise").forEach(row=>{ let ex=exercises.find(x=>x.id===row.dataset.id); if(ex){ total+=Number(ex.duration||0); count++; }}); if($("session-total")) $("session-total").textContent=total+" m"; if($("session-count")) $("session-count").textContent=count+" exercises"; }
    function clearSessionBuilder(){ if(!isAdmin() && !isPaid()){ alert(localStorage.getItem(LANG_KEY)==='da'?"Betalt adgang kr√¶ves.":"Paid access required."); return; } if($("session-items")) $("session-items").innerHTML=""; if($("session-name")) $("session-name").value=""; if($("session-desc")) $("session-desc").value=""; recalcSession(); }
    function saveSession(){ if(!isAdmin() && !isPaid()){ alert(localStorage.getItem(LANG_KEY)==='da'?"Betalt adgang kr√¶ves.":"Paid access required."); return; } let name=$("session-name").value.trim(); if(!name){ alert(localStorage.getItem(LANG_KEY)==='da'?"Tilf√∏j et sessionsnavn":"Add a session name"); return; } let ids=[]; document.querySelectorAll("#session-items .exercise").forEach(r=>ids.push(r.dataset.id)); let total = ids.reduce((a,id)=>{ let ex=exercises.find(x=>x.id===id); return a+(ex?Number(ex.duration||0):0); },0); let ses={id:uid(),name,description:$("session-desc").value,items:ids,total,createdAt:new Date().toISOString()}; sessions.unshift(ses); localStorage.setItem(SES_KEY, JSON.stringify(sessions)); renderSessions(); clearSessionBuilder(); }

    function renderSessions(){ let box=$("sessions-list"); if(!box) return; box.innerHTML=""; if(sessions.length===0){ box.innerHTML=`<div style="color:var(--muted)">${t('noSessions')}</div>`; return; } sessions.forEach(s=>{ let div=document.createElement("div"); div.className="exercise"; div.innerHTML=`<div style="flex:1"><div style="font-weight:800">${s.name}</div><div style="color:var(--muted)">${(s.items||[]).length} exercises ‚Ä¢ ${s.total||0} m</div></div>`; const btnOpen = document.createElement('button'); btnOpen.className='btn btn-ghost open-session'; btnOpen.textContent = t('openBtn'); const btnDelete = document.createElement('button'); btnDelete.className='btn btn-ghost delete-session'; btnDelete.style.color='var(--danger)'; btnDelete.textContent = t('deleteBtn');

      btnOpen.addEventListener('click', ()=> {
        if(!isAdmin() && !isPaid()){
          alert(localStorage.getItem(LANG_KEY)==='da' ? "Du skal v√¶re admin eller have betalt adgang for at √•bne sessions." : "You need admin or paid access to open sessions.");
          return;
        }
        openSavedSession(s.id);
      });

      btnDelete.addEventListener('click', ()=> {
        if(!isAdmin() && !isPaid()){
          alert('Admin or Paid access required');
          return;
        }
        if(confirm(t('deleteSessionConfirm'))){ sessions = sessions.filter(x=>x.id!==s.id); localStorage.setItem(SES_KEY, JSON.stringify(sessions)); renderSessions(); }
      });

      div.appendChild(btnOpen);
      if(isAdmin() || isPaid()) div.appendChild(btnDelete);
      box.appendChild(div);
    }); }

    /* Full-screen session viewer */
    function showDetailedSessionViewFullScreen(session){
      const modal = $("session-detail-modal");
      const titleEl = $("session-detail-title");
      const metaEl = $("session-detail-meta");
      const bodyEl = $("session-detail-body");
      titleEl.textContent = session.name || session.title || 'Saved session';
      metaEl.textContent = `${(session.items?session.items.length: (session.payload && session.payload.links? session.payload.links.length:0))} exercises ‚Ä¢ ${session.total||0} m`;
      bodyEl.innerHTML = "";
      if(session.description) {
        const p = document.createElement('p'); p.style.color='var(--muted)'; p.textContent = session.description; bodyEl.appendChild(p);
      }
      const ul = document.createElement('div'); ul.style.display='grid'; ul.style.gap='10px'; ul.style.marginTop='12px';
      if(Array.isArray(session.items) && session.items.length){
        session.items.forEach(id => {
          const ex = exercises.find(e=>e.id === id);
          const el = document.createElement('div'); el.className='exercise'; el.style.alignItems='center';
          if(ex){
            el.innerHTML = `<div style="flex:1"><div style="font-weight:700">${escapeHtml(ex.title)}</div><div style="color:var(--muted)">${escapeHtml(ex.category)} ‚Ä¢ ${escapeHtml(ex.duration + 'm')}</div></div><div style="margin-left:10px"><a class="btn btn-small btn-ghost" href="${escapeAttr(ex.link || '#')}" target="_blank">Open link</a></div>`;
          } else {
            el.innerHTML = `<div style="flex:1"><div style="font-weight:700">Exercise not found</div><div style="color:var(--muted)">ID: ${escapeHtml(id)}</div></div>`;
          }
          ul.appendChild(el);
        });
      } else if(session.payload && Array.isArray(session.payload.links) && session.payload.links.length){
        session.payload.links.forEach((ln, idx) => {
          const el = document.createElement('div'); el.className='exercise'; el.style.alignItems='center';
          el.innerHTML = `<div style="flex:1"><div style="font-weight:700">Link ${idx+1}</div><div style="color:var(--muted)">${escapeHtml(ln)}</div></div><div style="margin-left:10px"><a class="btn btn-small btn-ghost" href="${escapeAttr(ln)}" target="_blank">Open</a></div>`;
          ul.appendChild(el);
        });
      } else {
        const empty = document.createElement('div'); empty.style.color='var(--muted)'; empty.textContent = 'No exercises or links in this session'; ul.appendChild(empty);
      }
      bodyEl.appendChild(ul);
      modal.style.display = 'flex';
      $("session-detail-close").focus();
    }
    function escapeHtml(text){ if(text===null || text===undefined) return ''; return String(text).replace(/[&<>"']/g, function(m){ return ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]; }); }
    function escapeAttr(s){ if(!s) return '#'; return s.replace(/"/g, '&quot;'); }
    $("session-detail-close")?.addEventListener('click', ()=>{ $("session-detail-modal").style.display='none'; });

    /* OPEN SAVED SESSION */
    function openSavedSession(sessionId){
      try {
        const session = sessions.find(s => s.id === sessionId);
        if(!session){ console.warn('Session not found', sessionId); alert('Session not found or has been deleted.'); return; }
        if(!session.items && session.links) { session.payload = session.payload || {}; session.payload.links = session.links; }
        if(!Array.isArray(session.items) && !(session.payload && Array.isArray(session.payload.links))){ console.error('Invalid session format', session); alert('Session format invalid. Try restoring from a backup.'); return; }
        showDetailedSessionViewFullScreen(session);
      } catch(err){ console.error('Error opening session', err); alert('Could not open session. Check console for details.'); }
    }

    /* BACKUP & RESTORE - now admin-only visibility and still accessible only if admin (action protected) */
    function onBackup(){
      if(!isAdmin()){ alert('Admin access required to backup'); return; }
      try {
        const meta = { createdAt:new Date().toISOString(), lezgoVersion: 'v3', meta: JSON.parse(localStorage.getItem(STORAGE_META_KEY) || "{}") };
        const payload = { meta, data: { exercises: exercises || [], sessions: sessions || [], categories: categories || [], levels: levels || [], intensities: intensities || [], players: players || [] } };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `lezgo-backup-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      } catch(e){ console.error('Backup error', e); alert('Backup failed. See console.'); }
    }

    async function onRestoreFile(ev){
      if(!isAdmin()){ alert('Admin access required to restore'); ev.target.value=''; return; } // protect
      const file = ev.target.files && ev.target.files[0]; if(!file) return;
      try {
        const text = await file.text(); const parsed = JSON.parse(text); if(!parsed || !parsed.data) throw new Error('Invalid backup format (missing data).');
        const incomingExercises = Array.isArray(parsed.data.exercises) ? parsed.data.exercises : [];
        const incomingSessions = Array.isArray(parsed.data.sessions) ? parsed.data.sessions : [];
        const incomingCategories = Array.isArray(parsed.data.categories) ? parsed.data.categories : [];
        const incomingLevels = Array.isArray(parsed.data.levels) ? parsed.data.levels : [];
        const incomingIntensities = Array.isArray(parsed.data.intensities) ? parsed.data.intensities : [];
        const incomingPlayers = Array.isArray(parsed.data.players) ? parsed.data.players : [];
        const exById = new Map((exercises||[]).map(e=>[e.id,e])); incomingExercises.forEach(e=>{ if(!e.id) e.id = uid(); exById.set(e.id, e); }); exercises = Array.from(exById.values());
        const sesById = new Map((sessions||[]).map(s=>[s.id,s])); incomingSessions.forEach(s=>{ if(!s.id) s.id = uid(); sesById.set(s.id, s); }); sessions = Array.from(sesById.values());
        categories = Array.from(new Set([...(categories||[]), ...incomingCategories])); levels = Array.from(new Set([...(levels||[]), ...incomingLevels])); intensities = Array.from(new Set([...(intensities||[]), ...incomingIntensities])); players = Array.from(new Set([...(players||[]), ...incomingPlayers]));
        localStorage.setItem(EX_KEY, JSON.stringify(exercises)); localStorage.setItem(SES_KEY, JSON.stringify(sessions)); localStorage.setItem(CAT_KEY, JSON.stringify(categories)); localStorage.setItem(LVL_KEY, JSON.stringify(levels)); localStorage.setItem(INT_KEY, JSON.stringify(intensities)); localStorage.setItem(PLR_KEY, JSON.stringify(players)); saveMeta();
        populateCategories(); populateLevels(); populateIntensity(); populatePlayers(); renderList(); renderSessions(); updateBadges(); updateSessionLock(); enforcePermissions();
        alert('Restore completed. Data merged.');
      } catch(err){ console.error('Restore error', err); alert('Restore failed: ' + (err.message || err)); } finally { ev.target.value = ''; }
    }

    /* BADGES + LOCK */
    function updateBadges(){ if($("badges")) $("badges").innerHTML=""; if(isAdmin()){ let d=document.createElement("div"); d.className="badge"; d.textContent="ADMIN"; $("badges").appendChild(d); $("btn-logout-header").style.display="inline-flex"; } else { $("btn-logout-header").style.display="none"; } if(isPaid()){ let d=document.createElement("div"); d.className="badge"; d.textContent="PAID"; $("badges").appendChild(d); } }
    function updateSessionLock(){ let locked = (!isPaid() && !isAdmin()); if($("save-session")) $("save-session").disabled=locked; if($("add-selected")) $("add-selected").disabled=locked; if($("session-lock-info")) $("session-lock-info").style.display = locked ? "block":"none"; }

    /* ENFORCE PERMISSIONS (Backup/Restore and Delete All visible only to admin; paid can per-item delete/edit) */
    function enforcePermissions(){
      // Delete All visible only to admin
      if(isAdmin()){ $("delete-all-btn").style.display='inline-block'; } else { $("delete-all-btn").style.display='none'; }

      // Session builder controls for paid or admin
      if(isAdmin() || isPaid()){
        if($("save-session")) $("save-session").style.display='inline-block';
        if($("clear-session")) $("clear-session").style.display='inline-block';
        if($("add-selected")) $("add-selected").style.display='inline-block';
        if($("session-lock-info")) $("session-lock-info").style.display='none';
      } else {
        if($("save-session")) $("save-session").style.display='none';
        if($("clear-session")) $("clear-session").style.display='none';
        if($("add-selected")) $("add-selected").style.display='inline-block';
        if($("session-lock-info")) $("session-lock-info").style.display='block';
      }

      // Bottom bar (backup/restore) visible only if admin
      const bb = document.getElementById('lezgo-bottom-bar');
      if(bb){
        if(isAdmin()){
          bb.style.display = 'flex'; bb.setAttribute('aria-hidden','false');
        } else {
          bb.style.display = 'none'; bb.setAttribute('aria-hidden','true');
        }
      }

      renderList();
      renderSessions();
      updateBadges();
      updateSessionLock();
    }

    /* START */
    function robustInitWrapper(){ try{ init(); console.log("init() executed."); }catch(err){ console.error("init() failed:", err); } }
    if(document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', robustInitWrapper); } else { robustInitWrapper(); }

    /* SERVICE WORKER registration (unchanged) */
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(reg => console.log('ServiceWorker registered with scope:', reg.scope))
          .catch(err => console.warn('SW register failed:', err));
      });
    }

    /* ========== Video metadata helpers & analyze ========== */
    async function fetchVideoMetadata(link){
      try{
        const yt = extractYouTubeId(link);
        if(yt){
          try{
            const oUrl = `https://www.youtube.com/oembed?url=${encodeURIComponent(link)}&format=json`;
            const r = await fetch(oUrl);
            if(r.ok){ const j = await r.json(); return { title: j.title||'', description: j.author_name||'' }; }
          }catch(e){ console.warn('oembed fail', e); }
        }
        const noembed = `https://noembed.com/embed?url=${encodeURIComponent(link)}`;
        const r2 = await fetch(noembed);
        if(r2.ok){ const j2 = await r2.json(); return { title: j2.title||'', description: j2.author_name||'' }; }
      }catch(e){ console.warn('fetchVideoMetadata error', e); }
      return null;
    }
    function extractYouTubeId(url){ try{ const u = new URL(url); if(u.hostname.includes('youtu.be')) return u.pathname.slice(1); if(u.hostname.includes('youtube.com')){ const p = u.searchParams.get('v'); if(p) return p; const parts = u.pathname.split('/'); const idx = parts.indexOf('embed'); if(idx>-1 && parts[idx+1]) return parts[idx+1]; } }catch(e){} return null; }

    function analyzeTextToFields(title, description, lang){
      const text = (title + " " + description).toLowerCase();
      const suggestions = {};
      const categoryMap = { "Bandeja":["bandeja"], "Chiquita":["chiquita"], "Vibora":["vibora"], "Serve":["serve"], "Smash":["smash"], "Lob":["lob"], "Defense":["defend","defense"], "Volley":["volley"], "Groundstroke":["forehand","backhand"], "Double wall":["double wall"] };
      for(const [cat, keys] of Object.entries(categoryMap)){ for(const k of keys) if(text.includes(k)){ suggestions.category = cat; break; } if(suggestions.category) break; }
      if(text.match(/\bbeginner|beginners|begynder|nybegynder\b/)) suggestions.level = localize("Beginner", lang);
      else if(text.match(/\bintermediate|mellem|√∏vet\b/)) suggestions.level = localize("Intermediate", lang);
      else if(text.match(/\badvanced|avanceret|pro\b/)) suggestions.level = localize("Advanced", lang);
      const playersMatch = text.match(/\b(1|2|3|4|1\-2|1\-3|1\-4|2\-4)\b/);
      if(playersMatch) suggestions.players = playersMatch[0];
      if(text.match(/\b(high|intense|intensiv|h√•rd)\b/)) suggestions.intensity = localize("High", lang);
      else if(text.match(/\b(medium|moderat)\b/)) suggestions.intensity = localize("Medium", lang);
      else suggestions.intensity = localize("Low", lang);
      const words = text.replace(/[^\w√¶√∏√•√Ü√ò√Ö]/g," ").split(/\s+/).filter(w=>w.length>3);
      const stop = new Set(["video","padel","drill","exercise","exercises","howto","tutorial","padelvideo","learn"]);
      const tagCandidates = [];
      for(const w of words){ if(!stop.has(w) && !tagCandidates.includes(w)) tagCandidates.push(w); if(tagCandidates.length>=6) break; }
      suggestions.tags = tagCandidates.slice(0,6).join(", ");
      if(!suggestions.category && tagCandidates.length) suggestions.category = capitalize(tagCandidates[0]);
      return suggestions;
    }
    function capitalize(s){ if(!s) return s; return s.charAt(0).toUpperCase() + s.slice(1); }
    function localize(key, lang){ if(!lang) lang='en'; const map = { en: {"Beginner":"Beginner","Intermediate":"Intermediate","Advanced":"Advanced","Low":"Low","Medium":"Medium","High":"High"}, da: {"Beginner":"Beginner","Intermediate":"Intermediate","Advanced":"Advanced","Low":"Low","Medium":"Medium","High":"High"} }; return (map[lang] && map[lang][key]) || key; }

  </script>
</body>
</html>
