<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>LezGo Padel ‚Äî Training Bank</title>
  <meta name="theme-color" content="#0f1720" id="meta-theme-color" />
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" href="ICON-192x192.png" sizes="192x192">

  <style>
    /* RESET + VARS */
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%;margin:0;padding:0;overflow-x:hidden}
    body{font-family:Inter,system-ui,Arial,sans-serif;-webkit-font-smoothing:antialiased;transition:background .25s,color .25s; background: linear-gradient(180deg,#0f1720 0%,#071226 100%); color:#e6eef6; padding-bottom:220px;}
    :root{ --panel:#0b1a25; --muted:#9aa7b3; --accent:#22c55e; --danger:#ef4444; --border-soft: rgba(255,255,255,.04); --max-w:1100px; }
    body.light{ background: linear-gradient(180deg,#caced5 0%,#bfc3cb 100%); color:#0b1220; --panel:#d8dce3; --muted:#3c4652; --accent:#16a34a; --danger:#dc2626; }

    .container{max-width:var(--max-w);margin:14px auto;padding:12px;width:94%}
    header{display:flex;flex-direction:column;align-items:center;gap:12px;margin-bottom:12px;padding-top:8px}
    #logo{width:min(62vw,520px);max-height:26vh;height:auto;display:block;margin:0 auto;object-fit:contain}

    .controls{display:flex;gap:12px;align-items:center;width:100%;justify-content:space-between;flex-wrap:wrap;padding:0 6px}
    .badges{display:flex;gap:8px;align-items:center}
    .badge{background:rgba(255,255,255,.04);padding:6px 10px;border-radius:8px;font-weight:700;color:var(--muted)}

    .btn{border:0;padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer;background:transparent;color:inherit;display:inline-flex;align-items:center;gap:8px}
    .btn-primary{background:var(--accent);color:#05261a}
    .btn-ghost{background:transparent;border:1px solid var(--border-soft);color:var(--muted);padding:10px 12px;border-radius:10px}
    .btn-danger{background:var(--danger);color:#fff;border-radius:10px}
    .btn-small{padding:6px 8px;border-radius:8px;font-weight:700}

    .card{background:var(--panel);border-radius:12px;padding:14px;margin-bottom:14px;box-shadow:0 10px 28px rgba(2,6,23,.6)}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=text],input[type=url],input[type=number],select,textarea{width:100%;padding:12px;border-radius:10px;border:1px solid var(--border-soft);background:transparent;color:inherit}
    textarea{min-height:84px;resize:vertical}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:680px){.grid{grid-template-columns:1fr}}

    .exercise{display:flex;gap:10px;padding:12px;border-radius:10px;border:1px solid var(--border-soft);align-items:flex-start;overflow:hidden}
    .exercise .left{flex:1; min-width:0} /* important for text wrap in flex */
    .exercise .meta{color:var(--muted);margin-top:8px}
    .tag{background:rgba(255,255,255,.03);padding:6px 8px;border-radius:8px;margin-right:8px;font-size:13px;display:inline-block;margin-top:8px}

    /* force long words/urls to wrap on mobile */
    .exercise, .exercise a, .exercise div { overflow-wrap:anywhere; word-break:break-word; hyphens:auto; }
    a { color: #2fa1ff; }

    .actions-small{display:flex;flex-direction:column;gap:8px;align-items:flex-end}
    .actions-small .btn{white-space:nowrap}

    .duplicate { border: 2px solid var(--danger) !important; background: rgba(239,68,68,0.06) !important; }

    /* bottom bar (admin/paid) - sits above page content (non-overlapping due to body padding-bottom) */
    #lezgo-bottom-bar{ position: fixed; bottom: 12px; left: 12px; right: 12px; max-width: calc(var(--max-w) - 24px); margin: 0 auto; display:none; gap:12px; justify-content:center; align-items:center; padding:10px; background: linear-gradient(180deg, rgba(0,0,0,0.06), rgba(0,0,0,0.02)); border-radius:12px; z-index:99999; box-shadow:0 10px 28px rgba(0,0,0,0.16); pointer-events:auto; }
    #lezgo-bottom-bar .lezgo-btn{ padding:.6rem .9rem; border-radius:10px; background:var(--accent); color:#05261a; min-width:110px; text-align:center; font-weight:800}
    #lezgo-bottom-bar .lezgo-btn.restore{ background:transparent; border:1px solid var(--border-soft); color:inherit; }

    /* saved-links area inside aside */
    #saved-links-list .link-row{ display:flex; gap:8px; align-items:center; justify-content:space-between; padding:8px; border-radius:8px; border:1px solid var(--border-soft); margin-top:8px; }
    #saved-links-list .meta{ color:var(--muted); font-size:13px; overflow-wrap:anywhere }

    /* saved-files area (backups) */
    #saved-files-list .file-row{ display:flex; gap:8px; align-items:center; justify-content:space-between; padding:8px; border-radius:8px; border:1px solid var(--border-soft); margin-top:8px; }
    #saved-files-list .meta{ color:var(--muted); font-size:13px }

    /* confirm modal */
    #confirm-modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(2,6,23,0.6); z-index:100000; }
    #confirm-modal .modal{ background:var(--panel); padding:18px; border-radius:12px; max-width:420px; width:92%; box-shadow:0 20px 60px rgba(0,0,0,0.6) }
    #confirm-modal .modal p{ margin:0 0 12px 0; color:var(--muted) }
    #confirm-modal .row{ display:flex; gap:10px; justify-content:flex-end }

    @media(max-width:520px){
      .container{padding:10px 10px 260px} /* ekstra bundplads s√• bottom bar ikke overlapper indhold */
      #lezgo-bottom-bar{ left:10px; right:10px; }
      .actions-small{align-items:flex-end}
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <img id="logo" src="lezgo-logo.svg" alt="LezGo logo">
      <div class="controls">
        <div class="badges" id="badges"></div>
        <div style="display:flex;gap:10px;align-items:center">
          <select id="lang-select" style="padding:8px;border-radius:8px;border:1px solid var(--border-soft);background:transparent;color:inherit" aria-label="Language select">
            <option value="da">Dansk</option>
            <option value="en">English</option>
          </select>

          <button id="btn-buy" class="btn btn-primary">K√∏b adgang</button>
          <button id="btn-admin" class="btn btn-ghost">Admin login</button>
          <button id="btn-logout-header" class="btn btn-ghost" style="display:none;color:var(--danger)">Log ud</button>
        </div>
      </div>
    </header>

    <!-- FORM -->
    <section class="card">
      <h3 style="margin:0 0 10px 0;color:var(--muted)">Tilf√∏j / Rediger √∏velse (Padel)</h3>
      <form id="exercise-form" class="grid" onsubmit="return false;">
        <div style="grid-column:1/-1;">
          <label>Titel</label>
          <input id="title" type="text" placeholder="f.eks. Forehand topspin drill" autocomplete="off">
        </div>

        <div><label>Kategori</label><select id="category"></select></div>
        <div><label>Spillere</label><select id="players"></select></div>
        <div><label>Varighed (min)</label><input id="duration" type="number" min="0" placeholder="20"></div>
        <div><label>Niveau</label><select id="level"></select></div>
        <div><label>Intensitet</label><select id="intensity"></select></div>

        <div style="grid-column:1/-1;">
          <label>Videolink (YouTube / Instagram / Facebook)</label>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="link" type="url" placeholder="https://..." style="flex:1" autocomplete="off">
            <button id="analyze-btn" class="btn btn-ghost">üîç Analyser</button>
          </div>
        </div>

        <div style="grid-column:1/-1;"><label>Beskrivelse</label><textarea id="description"></textarea></div>
        <div style="grid-column:1/-1;"><label>Tags (kommasepareret)</label><input id="tags" type="text" placeholder="fx Cross, Chiquita, Vibora"></div>

        <div class="actions-row" style="grid-column:1/-1;margin-top:8px;display:flex;justify-content:space-between;align-items:center">
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button id="save-btn" class="btn btn-primary">‚ûï Gem √∏velse</button>
            <button id="clear-btn" class="btn btn-ghost">Ryd</button>
          </div>
          <button id="delete-all-btn" class="btn btn-danger" style="display:none">üóëÔ∏è Slet alle</button>
        </div>
      </form>
    </section>

    <!-- LIST + ASIDE -->
    <section class="card">
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;align-items:center">
        <input id="search" type="text" placeholder="S√∏g..." style="flex:1;padding:10px;border-radius:10px;border:1px solid var(--border-soft);background:transparent;color:inherit">
        <div class="platform-filters">
          <button data-platform="youtube" class="platform-btn" id="pf-y">YouTube</button>
          <button data-platform="instagram" class="platform-btn" id="pf-i">Instagram</button>
          <button data-platform="facebook" class="platform-btn" id="pf-f">Facebook</button>
        </div>
        <select id="filter-category" style="padding:10px;border-radius:10px;border:1px solid var(--border-soft);background:transparent;color:inherit"><option>ALL</option></select>
        <select id="filter-level" style="padding:10px;border-radius:10px;border:1px solid var(--border-soft);background:transparent;color:inherit"><option>ALL</option></select>
        <button id="show-favorites" class="btn btn-ghost">Vis favoritter</button>
      </div>

      <div class="two-column" style="display:grid;grid-template-columns:1fr 380px;gap:12px">
        <div>
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap">
            <button id="select-all" class="btn btn-ghost">V√¶lg alle</button>
            <button id="add-selected" class="btn btn-primary">Tilf√∏j til session</button>
            <div style="margin-left:auto" id="selected-count">0 valgt</div>
          </div>
          <div id="list"></div>
        </div>

        <aside class="card">
          <h4 style="margin:0">Training Session Builder</h4>

          <label>Sessionsnavn</label>
          <input id="session-name" type="text">

          <label style="margin-top:8px">Sessionsbeskrivelse</label>
          <input id="session-desc" type="text">

          <label style="margin-top:8px">√òvelser</label>
          <div id="session-items" style="max-height:240px;overflow:auto"></div>

          <div style="display:flex;gap:10px;align-items:center;margin-top:10px;">
            <div>Total:</div>
            <div id="session-total" style="font-weight:700">0 m</div>
            <div style="margin-left:auto" id="session-count">0 √∏velser</div>
          </div>

          <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
            <button id="save-session" class="btn btn-primary" style="display:none">Gem session</button>
            <button id="clear-session" class="btn btn-ghost" style="display:none">Ryd</button>
          </div>

          <div id="session-lock-info" style="margin-top:14px;color:var(--muted);display:none">
            Gratis brugere kan ikke gemme eller bygge sessioner. K√∏b adgang for at l√•se op.
          </div>

          <hr style="border:none;border-top:1px solid var(--border-soft);margin:14px 0">
          <h4 style="margin:0 0 6px 0;">Gemte sessioner</h4>
          <div id="sessions-list" style="max-height:160px;overflow:auto"></div>

          <hr style="border:none;border-top:1px solid var(--border-soft);margin:14px 0">
          <h4 style="margin:0 0 6px 0;">Gemte links</h4>
          <div id="saved-links-list" style="max-height:220px;overflow:auto"></div>

          <hr style="border:none;border-top:1px solid var(--border-soft);margin:14px 0">
          <h4 style="margin:0 0 6px 0;">Saved files (backups)</h4>
          <div id="saved-files-list"></div>
        </aside>
      </div>
    </section>
  </div><!-- container end -->

  <!-- Confirm modal -->
  <div id="confirm-modal" role="dialog" aria-modal="true" style="display:none">
    <div class="modal">
      <h3 id="confirm-title">Bekr√¶ft</h3>
      <p id="confirm-message">Er du sikker?</p>
      <div class="row">
        <button id="confirm-no" class="btn btn-ghost">Nej</button>
        <button id="confirm-yes" class="btn btn-danger">Ja</button>
      </div>
    </div>
  </div>

  <!-- Bottom bar (Backup / Restore) - visible for Admin OR Paid -->
  <div id="lezgo-bottom-bar" aria-hidden="true" style="display:none">
    <button id="btn-backup" class="lezgo-btn">Backup</button>
    <label for="file-restore" class="lezgo-btn restore" style="cursor:pointer">Restore</label>
    <input id="file-restore" type="file" accept="application/json" />
  </div>

  <!-- Admin modal -->
  <div id="admin-modal" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:999">
    <div style="background:var(--panel);padding:14px;border-radius:10px;max-width:420px;width:92%">
      <h3 style="margin-top:0">Admin login</h3>
      <input id="admin-password" type="password" placeholder="Password" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border-soft);margin-bottom:12px">
      <div style="display:flex;gap:12px;justify-content:flex-end">
        <button id="admin-cancel" class="btn btn-ghost">Annuller</button>
        <button id="admin-submit" class="btn btn-primary">Login</button>
      </div>
    </div>
  </div>

<script>
/* KONFIG */
const ADMIN_PASSWORD = "admin123";
const EX_KEY = "lezgo_exercises_v1";
const CAT_KEY = "lezgo_categories_v1";
const LVL_KEY = "lezgo_levels_v1";
const INT_KEY = "lezgo_intensities_v1";
const PLR_KEY = "lezgo_players_v1";
const SES_KEY = "lezgo_sessions_v1";
const BACKUPS_KEY = "lezgo_backups_v1";

const DEFAULT_CATEGORIES = ["Back wall","Bandeja","Chiquita","Defense","Double wall","Groundstroke","Lob","Serve","Smash","Vibora","Volley"].sort();
const DEFAULT_LEVELS = ["Beginner","Intermediate","Advanced"];
const DEFAULT_INT = ["Low","Medium","High"];
const DEFAULT_PLAYERS = ["1","2","3","4","1-2","1-3","1-4","2-4","Any","Add new..."];

let exercises = []; let categories = []; let levels = []; let intensities = []; let players = []; let sessions = []; let backups = [];
let editingId = null; let selectedIds = new Set();
const $ = id => document.getElementById(id);
const uid = () => "id_" + Math.random().toString(36).slice(2,10);
const isAdmin = () => localStorage.getItem("is_admin") === "1";
const isPaid  = () => localStorage.getItem("is_paid") === "1";
const platformState = new Set();

function loadAll(){
  exercises = JSON.parse(localStorage.getItem(EX_KEY) || "[]");
  categories = JSON.parse(localStorage.getItem(CAT_KEY) || "null") || DEFAULT_CATEGORIES;
  levels = JSON.parse(localStorage.getItem(LVL_KEY) || "null") || DEFAULT_LEVELS;
  intensities = JSON.parse(localStorage.getItem(INT_KEY) || "null") || DEFAULT_INT;
  players = JSON.parse(localStorage.getItem(PLR_KEY) || "null") || DEFAULT_PLAYERS;
  sessions = JSON.parse(localStorage.getItem(SES_KEY) || "[]");
  backups = JSON.parse(localStorage.getItem(BACKUPS_KEY) || "[]");
}
function persistExerciseList(){ localStorage.setItem(EX_KEY, JSON.stringify(exercises)); }
function persistSessions(){ localStorage.setItem(SES_KEY, JSON.stringify(sessions)); }
function persistBackups(){ localStorage.setItem(BACKUPS_KEY, JSON.stringify(backups)); }

function init(){
  loadAll();
  populateCategories(); populateLevels(); populateIntensity(); populatePlayers();
  bindEvents();
  renderList(); renderSessions(); renderSavedLinks(); renderSavedFiles(); updateBadges(); enforcePermissions();
}

/* UI population */
function populateCategories(){ const sel=$("category"), fil=$("filter-category"); if(!sel||!fil) return; sel.innerHTML=''; fil.innerHTML=''; let optAll=document.createElement('option'); optAll.text='ALL'; optAll.value=''; fil.appendChild(optAll); categories.forEach(c=>{ let o=document.createElement('option'); o.value=c; o.text=c; sel.appendChild(o); let f=document.createElement('option'); f.value=c; f.text=c; fil.appendChild(f); }); let add=document.createElement('option'); add.value='__ADD__'; add.text='Add new category...'; sel.appendChild(add); }
function populateLevels(){ const sel=$("level"), fil=$("filter-level"); if(!sel||!fil) return; sel.innerHTML=''; fil.innerHTML=''; let optAll=document.createElement('option'); optAll.text='ALL'; optAll.value=''; fil.appendChild(optAll); levels.forEach(c=>{ let o=document.createElement('option'); o.value=c; o.text=c; sel.appendChild(o); let f=document.createElement('option'); f.value=c; f.text=c; fil.appendChild(f); }); let add=document.createElement('option'); add.value='__ADD__'; add.text='Add new level...'; sel.appendChild(add); }
function populateIntensity(){ const sel=$("intensity"); if(!sel) return; sel.innerHTML=''; intensities.forEach(c=>{ let o=document.createElement('option'); o.value=c; o.text=c; sel.appendChild(o); }); let add=document.createElement('option'); add.value='__ADD__'; add.text='Add new intensity...'; sel.appendChild(add); }
function populatePlayers(){ const sel=$("players"); if(!sel) return; sel.innerHTML=''; players.forEach(c=>{ let o=document.createElement('option'); o.value=c; o.text=c; sel.appendChild(o); }); }

/* EVENTS */
function bindEvents(){
  $("admin-submit").addEventListener("click", ()=>{ if($("admin-password").value===ADMIN_PASSWORD){ localStorage.setItem("is_admin","1"); $("admin-modal").style.display="none"; updateBadges(); enforcePermissions(); alert('Admin enabled'); } else alert("Forkert kode"); });
  $("admin-cancel").addEventListener("click", ()=> $("admin-modal").style.display="none");
  $("btn-admin").addEventListener("click", ()=> $("admin-modal").style.display="flex");
  $("btn-logout-header").addEventListener("click", ()=>{ localStorage.removeItem("is_admin"); updateBadges(); enforcePermissions(); $("btn-logout-header").style.display="none"; alert('Logged out'); });

  $("btn-buy").addEventListener("click", ()=>{ if(isPaid()){ if(confirm("Deaktiver betalt adgang?")){ localStorage.removeItem("is_paid"); updateBadges(); enforcePermissions(); } } else { if(confirm("Simuler k√∏b?")){ localStorage.setItem("is_paid","1"); updateBadges(); enforcePermissions(); } }});
  $("save-btn").addEventListener("click", onSave);
  $("clear-btn").addEventListener("click", clearForm);
  $("delete-all-btn").addEventListener("click", ()=>{ if(!isAdmin()){ alert('Admin adgang kr√¶ves'); return; } const pass = prompt('Admin kode for at bekr√¶fte slet alle'); if(pass !== ADMIN_PASSWORD){ alert('Forkert kode'); return; } showConfirm('Slet ALLE √∏velser?', ()=>{ exercises = []; persistExerciseList(); renderList(); }); });

  $("search").addEventListener("input", renderList);
  $("filter-category").addEventListener("change", renderList);
  $("filter-level").addEventListener("change", renderList);
  $("select-all").addEventListener("click", ()=>{ document.querySelectorAll(".select-item").forEach(ch=>ch.checked=true); updateSelectedSet(); });
  $("add-selected").addEventListener("click", ()=>{ if(!isAdmin() && !isPaid()){ alert('Betalt adgang kr√¶ves.'); return; } addSelectedToSession(); });

  $("save-session").addEventListener("click", ()=>{ if(!isAdmin() && !isPaid()){ alert('Betalt adgang kr√¶ves.'); return; } saveSession(); });
  $("clear-session").addEventListener("click", ()=>{ if(!isAdmin() && !isPaid()){ alert('Betalt adgang kr√¶ves.'); return; } clearSessionBuilder(); });

  $("pf-y").addEventListener("click", ()=> togglePlatform('youtube', $("pf-y")));
  $("pf-i").addEventListener("click", ()=> togglePlatform('instagram', $("pf-i")));
  $("pf-f").addEventListener("click", ()=> togglePlatform('facebook', $("pf-f)));

  $("analyze-btn").addEventListener("click", (ev)=>{ ev.preventDefault(); const link = $("link").value.trim(); if(!link){ alert("Inds√¶t et videolink f√∏rst"); return; } alert('Analyse ikke aktiveret i demo'); });

  $("btn-backup").addEventListener("click", onBackup);
  $("file-restore").addEventListener("change", onRestoreFile);

  $("confirm-no").addEventListener("click", ()=> closeConfirm(false));
  $("confirm-yes").addEventListener("click", ()=> closeConfirm(true));
}

/* PLATFORM HELPERS */
function togglePlatform(name, btn){
  if(platformState.has(name)){ platformState.delete(name); btn.classList.remove('active'); } else { platformState.add(name); btn.classList.add('active'); }
  renderList();
}
function linkPlatform(link){
  if(!link) return null;
  try{ const u = new URL(link); const h = u.hostname.toLowerCase(); if(h.includes('youtube')||h.includes('youtu.be')) return 'youtube'; if(h.includes('instagram')) return 'instagram'; if(h.includes('facebook')) return 'facebook'; }catch(e){} return null;
}

/* SAVE EXERCISE */
function onSave(){
  const title = ($("title").value||"").trim();
  const link = ($("link").value||"").trim();
  if(!title){ alert("Indtast titel"); return; }

  const titleLC = title.toLowerCase();
  const dupByTitle = exercises.filter(e => (e.title||'').toLowerCase() === titleLC && e.id !== editingId);
  const dupByLink = link ? exercises.filter(e => (e.link||'') === link && e.id !== editingId) : [];
  document.querySelectorAll('.duplicate').forEach(n=>n.classList.remove('duplicate'));

  if(dupByTitle.length || dupByLink.length){
    const ids = new Set([...dupByTitle.map(x=>x.id), ...dupByLink.map(x=>x.id)]);
    ids.forEach(id => { const node = document.querySelector(`.exercise[data-id="${id}"]`); if(node){ node.classList.add('duplicate'); node.scrollIntoView({behavior:'smooth', block:'center'}); }});
    alert("Duplikat fundet: titel eller link findes allerede. De matchede elementer er markeret.");
    return;
  }

  const ex = { id: editingId || uid(), title, category: $("category").value, players: $("players").value, duration: Number($("duration").value||0), level: $("level").value, intensity: $("intensity").value, link, description: $("description").value||"", tags: ($("tags").value||"").trim(), createdAt: new Date().toISOString() };
  if(editingId){ const idx = exercises.findIndex(e=>e.id===editingId); if(idx>-1) exercises[idx] = ex; } else exercises.unshift(ex);
  persistExerciseList();
  clearForm(); renderList(); renderSavedLinks();
}

function clearForm(){ editingId=null; $("title").value=""; if($("category")) $("category").selectedIndex=0; if($("players")) $("players").selectedIndex=0; $("duration").value=""; if($("level")) $("level").selectedIndex=0; if($("intensity")) $("intensity").selectedIndex=0; $("link").value=""; $("description").value=""; $("tags").value=""; }

/* RENDER MAIN LIST */
function renderList(){
  document.querySelectorAll('.duplicate').forEach(n=>n.classList.remove('duplicate'));
  const q = ($("search").value||"").trim().toLowerCase();
  const fc = ($("filter-category").value||"");
  const fl = ($("filter-level").value||"");
  const list = $("list"); if(!list) return; list.innerHTML = "";
  let items = exercises.slice();

  if(platformState.size>0){
    items = items.filter(it => { const p = linkPlatform(it.link); return p && platformState.has(p); });
  }
  if(fc) items = items.filter(x=>x.category===fc);
  if(fl) items = items.filter(x=>x.level===fl);
  if(q) items = items.filter(x => (x.title||"").toLowerCase().includes(q) || (x.description||"").toLowerCase().includes(q) || (x.tags||"").toLowerCase().includes(q));
  if(items.length===0){ list.innerHTML = `<div style="color:var(--muted)">Ingen resultater</div>`; return; }

  items.forEach(ex=>{
    const row = document.createElement('div'); row.className='exercise'; row.dataset.id = ex.id;
    const cb = document.createElement('input'); cb.type='checkbox'; cb.className='select-item'; cb.addEventListener('change', updateSelectedSet); row.appendChild(cb);

    const left = document.createElement('div'); left.className='left';
    const ttitle = document.createElement('div'); ttitle.style.fontWeight='800'; ttitle.style.fontSize='15px'; ttitle.textContent = ex.title; left.appendChild(ttitle);
    const meta = document.createElement('div'); meta.className='meta'; meta.textContent = `${ex.category} ‚Ä¢ ${ex.level} ‚Ä¢ ${ex.players || ''} ‚Ä¢ ${ex.duration}m`; left.appendChild(meta);
    if(ex.link){
      const a = document.createElement('a'); a.href = ex.link; a.target = '_blank'; a.textContent = ex.link; a.style.display='block'; a.style.marginTop='6px';
      const p = linkPlatform(ex.link); if(p){ const sp = document.createElement('span'); sp.style.marginLeft='8px'; sp.style.color='var(--muted)'; sp.style.fontSize='12px'; sp.textContent = `(${p})`; a.appendChild(sp); }
      left.appendChild(a);
    }
    if(ex.tags){
      const tags = document.createElement('div'); tags.style.marginTop='8px'; ex.tags.split(',').forEach(tg=>{ const s=document.createElement('span'); s.className='tag'; s.textContent = tg.trim(); tags.appendChild(s); }); left.appendChild(tags);
    }
    row.appendChild(left);

    const right = document.createElement('div'); right.className='actions-small';

    // Add to session button (only admin or paid)
    if(isAdmin() || isPaid()){
      const addBtn = document.createElement('button'); addBtn.className='btn btn-primary btn-small'; addBtn.textContent = 'Tilf√∏j';
      addBtn.title = 'Tilf√∏j denne √∏velse til session';
      addBtn.addEventListener('click', ()=> addItemToSession(ex.id));
      right.appendChild(addBtn);
    }

    // Edit (admin/paid)
    if(isAdmin() || isPaid()){
      const edit = document.createElement('button'); edit.className='btn btn-ghost'; edit.textContent = 'Rediger';
      edit.addEventListener('click', ()=>{ if(!isAdmin() && !isPaid()){ alert('Betalt adgang kr√¶ves'); return; } editItem(ex.id); });
      right.appendChild(edit);
    }

    // Delete (admin/paid) with modal
    if(isAdmin() || isPaid()){
      const del = document.createElement('button'); del.className='btn btn-ghost'; del.style.color='var(--danger)'; del.textContent = 'Slet';
      del.addEventListener('click', ()=>{ if(!isAdmin() && !isPaid()){ alert('Admin eller betalt adgang kr√¶ves'); return; } showConfirm('Slet denne √∏velse?', ()=>{ exercises = exercises.filter(x=>x.id!==ex.id); persistExerciseList(); renderList(); renderSavedLinks(); }); });
      right.appendChild(del);
    }

    row.appendChild(right);
    list.appendChild(row);
  });

  updateSelectedSet();
}

/* EDIT */
function editItem(id){ const ex = exercises.find(e=>e.id===id); if(!ex) return; editingId=id; $("title").value=ex.title; $("category").value=ex.category; $("players").value=ex.players; $("duration").value=ex.duration; $("level").value=ex.level; $("intensity").value=ex.intensity; $("link").value=ex.link; $("description").value=ex.description; $("tags").value=ex.tags; window.scrollTo({top:0,behavior:'smooth'}); }

/* ADD single to session */
function addItemToSession(id){
  if(!isAdmin() && !isPaid()){ alert('Betalt adgang kr√¶ves'); return; }
  const box = $("session-items");
  if(box.querySelector(`[data-id="${id}"]`)) { alert('Redan tilf√∏jet'); return; }
  const ex = exercises.find(e=>e.id===id); if(!ex) return;
  const row = document.createElement('div'); row.className='exercise'; row.dataset.id=id; row.innerHTML = `<div style="flex:1"><div style="font-weight:700">${ex.title}</div><div style="color:var(--muted)">${ex.duration}m ‚Ä¢ ${ex.category}</div></div><button class="btn btn-ghost" style="color:var(--danger)">Fjern</button>`;
  row.querySelector('button').addEventListener('click', ()=>{ row.remove(); recalcSession(); });
  box.appendChild(row);
  recalcSession();
}

/* BULK -> session */
function updateSelectedSet(){ selectedIds.clear(); document.querySelectorAll(".select-item").forEach(cb=>{ if(cb.checked) selectedIds.add(cb.closest(".exercise").dataset.id); }); updateSelectedCount(); }
function updateSelectedCount(){ if($("selected-count")) $("selected-count").textContent = (selectedIds.size||0) + " valgt"; }
function addSelectedToSession(){ if(!isAdmin() && !isPaid()){ alert('Betalt adgang kr√¶ves'); return; } const box = $("session-items"); selectedIds.forEach(id=>{ if(box.querySelector(`[data-id="${id}"]`)) return; const ex = exercises.find(e=>e.id===id); if(!ex) return; const row = document.createElement('div'); row.className='exercise'; row.dataset.id=id; row.innerHTML = `<div style="flex:1"><div style="font-weight:700">${ex.title}</div><div style="color:var(--muted)">${ex.duration}m ‚Ä¢ ${ex.category}</div></div><button class="btn btn-ghost" style="color:var(--danger)">Fjern</button>`; row.querySelector('button').addEventListener('click', ()=>{ row.remove(); recalcSession(); }); box.appendChild(row); }); recalcSession(); }

function recalcSession(){ let total=0,count=0; document.querySelectorAll("#session-items .exercise").forEach(row=>{ const ex = exercises.find(e=>e.id===row.dataset.id); if(ex){ total += Number(ex.duration||0); count++; }}); if($("session-total")) $("session-total").textContent = total + " m"; if($("session-count")) $("session-count").textContent = count + " √∏velser"; }
function clearSessionBuilder(){ if(!isAdmin() && !isPaid()){ alert('Betalt adgang kr√¶ves'); return; } if($("session-items")) $("session-items").innerHTML=''; if($("session-name")) $("session-name").value=''; if($("session-desc")) $("session-desc").value=''; recalcSession(); }
function saveSession(){ if(!isAdmin() && !isPaid()){ alert('Betalt adgang kr√¶ves'); return; } const name = ($("session-name").value||"").trim(); if(!name){ alert('Tilf√∏j et sessionsnavn'); return; } const ids = []; document.querySelectorAll("#session-items .exercise").forEach(r=>ids.push(r.dataset.id)); const total = ids.reduce((a,id)=>{ const ex = exercises.find(e=>e.id===id); return a + (ex?Number(ex.duration||0):0); },0); const ses = { id: uid(), name, description: $("session-desc").value||"", items: ids, total, createdAt: new Date().toISOString() }; sessions.unshift(ses); persistSessions(); renderSessions(); clearSessionBuilder(); }

/* SESSIONS RENDER */
function renderSessions(){
  const box = $("sessions-list"); if(!box) return; box.innerHTML='';
  if(!sessions.length){ box.innerHTML = `<div style="color:var(--muted)">Ingen gemte sessioner</div>`; return; }
  sessions.forEach(s=>{
    const div = document.createElement('div'); div.className='exercise';
    div.innerHTML = `<div style="flex:1"><div style="font-weight:800">${s.name}</div><div style="color:var(--muted)">${(s.items||[]).length} √∏velser ‚Ä¢ ${s.total||0} m</div></div>`;
    const btnOpen = document.createElement('button'); btnOpen.className='btn btn-ghost'; btnOpen.textContent='√Öbn';
    btnOpen.addEventListener('click', ()=>{ if(!isAdmin() && !isPaid()){ alert('Admin eller betalt adgang kr√¶ves'); return; } openSavedSession(s.id); });
    const btnDelete = document.createElement('button'); btnDelete.className='btn btn-ghost'; btnDelete.style.color='var(--danger)'; btnDelete.textContent='Slet';
    btnDelete.addEventListener('click', ()=>{ if(!isAdmin() && !isPaid()){ alert('Admin eller betalt adgang kr√¶ves'); return; } showConfirm('Slet denne session?', ()=>{ sessions = sessions.filter(x=>x.id!==s.id); persistSessions(); renderSessions(); }); });
    div.appendChild(btnOpen);
    if(isAdmin() || isPaid()) div.appendChild(btnDelete);
    box.appendChild(div);
  });
}

/* SAVED LINKS (NY) - viser √∏velser med link under Saved sessions */
function renderSavedLinks(){
  const box = $("saved-links-list"); if(!box) return; box.innerHTML='';
  // find exercises with link
  const links = exercises.filter(e => e.link && e.link.trim() !== '');
  if(!links.length){ box.innerHTML = `<div style="color:var(--muted)">Ingen gemte links</div>`; return; }
  links.forEach(ex=>{
    const row = document.createElement('div'); row.className='link-row';
    const left = document.createElement('div'); left.style.flex='1';
    const title = document.createElement('div'); title.style.fontWeight='700'; title.textContent = ex.title;
    const meta = document.createElement('div'); meta.className='meta'; meta.textContent = ex.link;
    left.appendChild(title); left.appendChild(meta);
    const right = document.createElement('div'); right.style.display='flex'; right.style.gap='8px';
    // Add to session (admin/paid)
    if(isAdmin() || isPaid()){
      const btn = document.createElement('button'); btn.className='btn btn-primary btn-small'; btn.textContent='Tilf√∏j';
      btn.addEventListener('click', ()=> addItemToSession(ex.id));
      right.appendChild(btn);
    }
    // Restore / Delete of link as separate actions are handled in main list; in saved-links we only show add
    row.appendChild(left); row.appendChild(right); box.appendChild(row);
  });
}

/* CONFIRM modal */
let _confirmResolver = null;
function showConfirm(message, onYes){
  const modal = $("confirm-modal"); $("confirm-message").textContent = message; modal.style.display='flex';
  _confirmResolver = (ok) => { modal.style.display='none'; if(ok && typeof onYes === 'function') onYes(); _confirmResolver = null; };
}
function closeConfirm(result){ if(typeof _confirmResolver === 'function') _confirmResolver(result); }

/* BACKUP & RESTORE */
function onBackup(){
  if(!(isAdmin() || isPaid())){ alert('Admin eller betalt adgang kr√¶ves for backup'); return; }
  try {
    const payload = { meta: { createdAt: new Date().toISOString() }, data: { exercises, sessions, categories, levels, intensities, players } };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `lezgo-backup-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    const id = uid(); backups.unshift({ id, name: `backup-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`, timestamp: new Date().toISOString(), payload });
    persistBackups(); renderSavedFiles();
    alert('Backup gemt lokalt og downloadet.');
  } catch(e){ console.error(e); alert('Backup fejlede'); }
}
async function onRestoreFile(ev){
  if(!(isAdmin() || isPaid())){ alert('Admin eller betalt adgang kr√¶ves for restore'); ev.target.value=''; return; }
  const file = ev.target.files && ev.target.files[0]; if(!file) return;
  try{
    const text = await file.text(); const parsed = JSON.parse(text); if(!parsed || !parsed.data) throw new Error('Ugyldigt backup-format');
    const incomingExercises = Array.isArray(parsed.data.exercises)?parsed.data.exercises:[]; const exById = new Map((exercises||[]).map(e=>[e.id,e])); incomingExercises.forEach(e=>{ if(!e.id) e.id = uid(); exById.set(e.id,e); }); exercises = Array.from(exById.values());
    const incomingSessions = Array.isArray(parsed.data.sessions)?parsed.data.sessions:[]; const sesById = new Map((sessions||[]).map(s=>[s.id,s])); incomingSessions.forEach(s=>{ if(!s.id) s.id = uid(); sesById.set(s.id,s); }); sessions = Array.from(sesById.values());
    categories = Array.from(new Set([...(categories||[]), ...(parsed.data.categories||[])]));
    levels = Array.from(new Set([...(levels||[]), ...(parsed.data.levels||[])]));
    intensities = Array.from(new Set([...(intensities||[]), ...(parsed.data.intensities||[])]));
    players = Array.from(new Set([...(players||[]), ...(parsed.data.players||[])]));
    persistExerciseList(); persistSessions(); renderList(); renderSessions(); renderSavedLinks();
    alert('Restore gennemf√∏rt ‚Äî data er flettet.');
  } catch(err){ console.error(err); alert('Restore fejlede: ' + (err.message||err)); } finally { ev.target.value=''; }
}

/* SAVED FILES RENDER */
function renderSavedFiles(){
  const box = $("saved-files-list"); if(!box) return; box.innerHTML='';
  if(!backups.length){ box.innerHTML = `<div style="color:var(--muted)">Ingen backups gemt</div>`; return; }
  backups.forEach(b=>{
    const row = document.createElement('div'); row.className='file-row';
    const left = document.createElement('div'); left.style.flex='1';
    const name = document.createElement('div'); name.style.fontWeight='700'; name.textContent = b.name;
    const meta = document.createElement('div'); meta.className='meta'; meta.textContent = new Date(b.timestamp).toLocaleString();
    left.appendChild(name); left.appendChild(meta);
    const right = document.createElement('div'); right.style.display='flex'; right.style.gap='8px';
    if(isAdmin() || isPaid()){
      const rbtn = document.createElement('button'); rbtn.className='btn btn-ghost'; rbtn.textContent='Restore';
      rbtn.addEventListener('click', ()=> { if(!confirm('Genskab denne backup?')) return; try{ const parsed = b.payload; if(parsed && parsed.data){ const incomingExercises = Array.isArray(parsed.data.exercises)?parsed.data.exercises:[]; const exById = new Map((exercises||[]).map(e=>[e.id,e])); incomingExercises.forEach(e=>{ if(!e.id) e.id = uid(); exById.set(e.id,e); }); exercises = Array.from(exById.values()); const incomingSessions = Array.isArray(parsed.data.sessions)?parsed.data.sessions:[]; const sesById = new Map((sessions||[]).map(s=>[s.id,s])); incomingSessions.forEach(s=>{ if(!s.id) s.id = uid(); sesById.set(s.id,s); }); sessions = Array.from(sesById.values()); categories = Array.from(new Set([...(categories||[]), ...(parsed.data.categories||[])])); levels = Array.from(new Set([...(levels||[]), ...(parsed.data.levels||[])])); intensities = Array.from(new Set([...(intensities||[]), ...(parsed.data.intensities||[])])); players = Array.from(new Set([...(players||[]), ...(parsed.data.players||[])])); persistExerciseList(); persistSessions(); renderList(); renderSessions(); renderSavedLinks(); alert('Restore fra lokal backup gennemf√∏rt.'); } else alert('Backup-data mangler.'); }catch(e){ console.error(e); alert('Restore fejlede'); } });
      right.appendChild(rbtn);
    }
    if(isAdmin()){
      const dbtn = document.createElement('button'); dbtn.className='btn btn-ghost'; dbtn.style.color='var(--danger)'; dbtn.textContent='Slet';
      dbtn.addEventListener('click', ()=> { showConfirm('Slet denne backup-fil?', ()=>{ backups = backups.filter(x=>x.id!==b.id); persistBackups(); renderSavedFiles(); }); });
      right.appendChild(dbtn);
    }
    row.appendChild(left); row.appendChild(right); box.appendChild(row);
  });
}

/* BADGES & PERMISSIONS */
function updateBadges(){
  $("badges").innerHTML='';
  if(isAdmin()){ const d=document.createElement('div'); d.className='badge'; d.textContent='ADMIN'; $("badges").appendChild(d); $("btn-logout-header").style.display='inline-flex'; } else { $("btn-logout-header").style.display='none'; }
  if(isPaid()){ const d=document.createElement('div'); d.className='badge'; d.textContent='PAID'; $("badges").appendChild(d); }
}
function enforcePermissions(){
  const bb = $("lezgo-bottom-bar");
  if(bb){ if(isAdmin() || isPaid()){ bb.style.display='flex'; bb.setAttribute('aria-hidden','false'); } else { bb.style.display='none'; bb.setAttribute('aria-hidden','true'); } }
  if($("delete-all-btn")) $("delete-all-btn").style.display = isAdmin() ? 'inline-block' : 'none';
  if(isAdmin() || isPaid()){
    if($("save-session")) $("save-session").style.display='inline-block';
    if($("clear-session")) $("clear-session").style.display='inline-block';
  } else {
    if($("save-session")) $("save-session").style.display='none';
    if($("clear-session")) $("clear-session").style.display='none';
  }
  renderList(); renderSessions(); renderSavedLinks(); renderSavedFiles(); updateBadges();
}

/* START */
if(document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', ()=>{ init(); }); } else { init(); }
if('serviceWorker' in navigator){ window.addEventListener('load', ()=>{ navigator.serviceWorker.register('./service-worker.js').catch(()=>{}); }); }

</script>
</body>
</html>
