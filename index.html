<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>LezGo Padel ‚Äî Training Bank</title>
  <meta name="theme-color" content="#0f1720" id="meta-theme-color" />
  <style>
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%;margin:0;padding:0;overflow-x:hidden;font-family:Inter,system-ui,Arial,sans-serif;-webkit-font-smoothing:antialiased}
    :root{
      --bg-top:#0f1720;--bg-bottom:#071226;--panel:#12202a;--muted:#9aa7b3;--text:#e6eef6;
      --accent:#22c55e;--danger:#ef4444;--border-soft:rgba(255,255,255,.04);
      --base-font:14px; --small-font:12px; --tiny-font:11px;
    }
    body.light{--bg-top:#caced5;--bg-bottom:#bfc3cb;--panel:#d8dce3;--muted:#3c4652;--text:#0b1220;--accent:#16a34a;--danger:#dc2626}
    body{background:linear-gradient(180deg,var(--bg-top) 0%,var(--bg-bottom) 100%);color:var(--text);padding-bottom:140px;transition:background .2s,color .2s;font-size:var(--base-font)}

    .container{max-width:1100px;margin:10px auto;padding:8px;width:94%}

    header{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:8px;padding-top:env(safe-area-inset-top,12px);margin-bottom:8px;position:relative}
    #logo-line{grid-column:2/3;display:flex;justify-content:center;align-items:center;margin:0}
    #logo{height:50px;max-width:95%}

    #top-controls{grid-column:3/4;justify-self:end;display:flex;gap:8px;align-items:center;z-index:40;white-space:nowrap}
    #top-controls .theme-btn{display:inline-flex;align-items:center;justify-content:center;min-width:36px;height:36px;border-radius:9px;background:var(--panel);border:1px solid var(--border-soft);box-shadow:0 6px 14px rgba(0,0,0,.22);cursor:pointer;font-size:var(--small-font)}
    #top-controls select{padding:6px 8px;border-radius:9px;border:1px solid var(--border-soft);background:transparent;color:var(--text);min-width:54px;font-weight:700;font-size:var(--small-font)}

    .header-row{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-top:10px}
    .badge{background:rgba(255,255,255,.04);padding:6px 10px;border-radius:8px;font-weight:700;color:var(--muted);font-size:var(--small-font)}

    .btn{border:0;padding:8px 12px;border-radius:10px;font-weight:800;cursor:pointer;background:transparent;color:var(--text);display:inline-flex;align-items:center;gap:6px;font-size:var(--small-font)}
    .btn-primary{background:var(--accent);color:#05261a}
    .btn-ghost{background:transparent;border:1px solid var(--border-soft);color:var(--muted);padding:6px 10px;border-radius:10px}
    .btn-small{padding:6px 8px;border-radius:8px;font-weight:700}

    .platform-btn{border-radius:8px;padding:6px 8px;border:1px solid var(--border-soft);background:transparent;color:var(--muted);cursor:pointer;font-size:var(--small-font)}
    .platform-btn.active{background:var(--accent);color:#05261a;border-color:transparent;box-shadow:0 6px 18px rgba(0,0,0,.12)}

    .card{background:var(--panel);border-radius:12px;padding:12px;margin-bottom:12px;box-shadow:0 10px 28px rgba(2,6,23,.6)}
    label{display:block;font-size:var(--small-font);color:var(--muted);margin-bottom:6px}
    input[type=text],input[type=url],input[type=number],select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid var(--border-soft);background:transparent;color:var(--text);font-size:var(--small-font)}
    textarea{min-height:80px;resize:vertical}

    .two-col{display:grid;grid-template-columns:1fr 400px;gap:12px}
    @media(max-width:980px){.two-col{grid-template-columns:1fr}}

    .exercise{display:flex;gap:10px;padding:8px;border-radius:10px;border:1px solid var(--border-soft);align-items:flex-start;overflow:hidden}
    .exercise .left{flex:1 1 auto;min-width:0}
    .exercise .left .title{font-weight:800;font-size:14px;line-height:1.15}
    .exercise .left .meta{color:var(--muted);margin-top:6px;font-size:var(--tiny-font)}
    .exercise a.link-label{color:#2fa1ff;text-decoration:underline;font-size:var(--small-font);word-break:break-word;display:inline-block;margin-top:6px}

    .tag-wrap{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;align-items:center}
    .tag{display:inline-block;padding:5px 8px;border-radius:10px;background:rgba(255,255,255,0.03);font-size:11px;color:var(--text);white-space:nowrap;max-width:100%}
    @media(max-width:480px){ .tag{font-size:10px;padding:4px 6px} }

    .actions-small{flex:0 0 auto;display:flex;flex-direction:column;gap:8px;align-items:flex-end}
    .actions-small button{font-size:var(--tiny-font)}

    #list{max-height:560px;overflow:auto}
    #session-items{max-height:300px;overflow:auto}

    #sessions-list .exercise{padding:7px;border-radius:8px}
    #sessions-list .exercise .title{font-size:13px}
    #sessions-list .exercise .meta{font-size:var(--tiny-font);color:var(--muted)}

    #bottom-bar{position:fixed;bottom:12px;left:12px;right:12px;max-width:calc(1100px - 24px);margin:0 auto;display:flex;gap:12px;justify-content:center;align-items:center;padding:8px;border-radius:12px;z-index:9999;box-shadow:0 10px 28px rgba(0,0,0,0.16);background:linear-gradient(180deg,rgba(0,0,0,0.04),rgba(0,0,0,0.02))}
    .bottom-btn{padding:8px 12px;border-radius:10px;background:var(--accent);color:#05261a;font-weight:800;font-size:var(--small-font)}
    .bottom-btn.restore{background:transparent;border:1px solid var(--border-soft);color:var(--text)}

    .search-row{display:flex;gap:8px;align-items:center}
    .search-row input[type=text]{flex:1;min-width:0;padding:10px;border-radius:10px}

    @media(max-width:480px){
      :root{--base-font:13px;--small-font:11px;--tiny-font:10px}
      #logo{height:46px}
      #top-controls{gap:6px}
      #top-controls select{min-width:48px;padding:6px 6px;font-size:var(--small-font)}
      #top-controls .theme-btn {min-width:34px; height:34px; font-size:var(--small-font)}
      .exercise{padding:7px;gap:8px}
      .exercise .left .title{font-size:13px}
      .exercise .left .meta{font-size:var(--tiny-font)}
      #list{max-height:660px}
      #sessions-list{max-height:340px}
      .btn{padding:7px 10px;font-size:var(--small-font)}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div></div>

      <div id="logo-line">
        <img id="logo" src="lezgo-logo.svg" alt="LEZGO">
      </div>

      <div id="top-controls" aria-hidden="false">
        <button id="theme-toggle" class="theme-btn" title="Skift tema" aria-pressed="false">üåô</button>
        <select id="lang-select" aria-label="V√¶lg sprog (Dansk / English)">
          <option value="da">DA</option>
          <option value="en">EN</option>
        </select>
      </div>
    </header>

    <div class="header-row">
      <div id="badges" style="display:flex;gap:8px;align-items:center"></div>

      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button id="btn-buy" class="btn btn-primary" data-i18n="buy">K√∏b</button>
        <button id="btn-admin" class="btn btn-ghost" data-i18n="admin">Admin</button>
        <button id="btn-logout" class="btn btn-ghost" style="display:none;color:var(--danger)" data-i18n="logout">Log ud</button>
      </div>
    </div>

    <section class="card">
      <h3 id="form-title" style="margin:0 0 10px 0;color:var(--muted);font-size:var(--small-font)" data-i18n="formTitle">Tilf√∏j / Rediger √∏velse (Padel)</h3>
      <form id="exercise-form" onsubmit="return false;" style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div style="grid-column:1/-1">
          <label>Titel</label>
          <input id="title" type="text" placeholder="f.eks. Forehand topspin drill">
        </div>

        <div>
          <label>Kategori</label>
          <select id="category"></select>
        </div>

        <div>
          <label>Spillere</label>
          <select id="players"></select>
        </div>

        <div>
          <label>Varighed (min)</label>
          <input id="duration" type="number" min="0" placeholder="20">
        </div>

        <div>
          <label>Niveau</label>
          <select id="level"></select>
        </div>

        <div>
          <label>Intensitet</label>
          <select id="intensity"></select>
        </div>

        <div style="grid-column:1/-1">
          <label>Videolink (YouTube / Instagram / Facebook)</label>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="link" type="url" placeholder="https://..." style="flex:1">
            <button id="analyze-btn" class="btn btn-ghost">üîç</button>
          </div>
        </div>

        <div style="grid-column:1/-1">
          <label>Beskrivelse</label>
          <textarea id="description"></textarea>
        </div>

        <div style="grid-column:1/-1">
          <label>Tags (kommasepareret)</label>
          <input id="tags" type="text" placeholder="fx Cross, Chiquita, Vibora">
        </div>

        <div style="grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;margin-top:6px">
          <div style="display:flex;gap:8px;align-items:center">
            <button id="save-btn" class="btn btn-primary" data-i18n="save">Gem</button>
            <button id="clear-btn" class="btn btn-ghost" data-i18n="clear">Ryd</button>
            <!-- Cancel-edit button: hidden by default, shown only in edit mode -->
            <button id="cancel-edit-btn" class="btn btn-ghost" style="display:none" data-i18n="cancel">Annuller</button>
          </div>
          <button id="delete-all-btn" class="btn btn-ghost" style="display:none;color:var(--danger)" data-i18n="deleteAll">Slet alle</button>
        </div>
      </form>
    </section>

    <div class="two-col">
      <div class="card">
        <div style="display:flex;flex-direction:column;gap:10px">
          <div class="search-row">
            <input id="search" type="text" placeholder="S√∏g..." aria-label="S√∏g" data-i18n-placeholder="search">
            <div style="display:flex;gap:6px">
              <button type="button" id="pf-y" class="platform-btn" data-platform="youtube" aria-pressed="false">YT</button>
              <button type="button" id="pf-i" class="platform-btn" data-platform="instagram" aria-pressed="false">IG</button>
              <button type="button" id="pf-f" class="platform-btn" data-platform="facebook" aria-pressed="false">FB</button>
            </div>
          </div>

          <div style="display:flex;gap:8px">
            <select id="filter-category" style="flex:1;padding:10px;border-radius:10px;border:1px solid var(--border-soft);background:transparent;color:var(--text)"><option>ALL</option></select>
            <select id="filter-level" style="flex:1;padding:10px;border-radius:10px;border:1px solid var(--border-soft);background:transparent;color:var(--text)"><option>ALL</option></select>
          </div>

          <div style="color:var(--muted);font-size:var(--tiny-font)">Filtre er her ‚Äî Session Builder er til h√∏jre. P√• small sk√¶rme stables de lodret.</div>

          <div id="list" style="margin-top:6px"></div>
          <div style="display:flex;justify-content:center"><button id="load-more" class="btn btn-ghost" style="display:none">Vis flere</button></div>
        </div>
      </div>

      <aside class="card">
        <h4 style="margin:0 0 10px 0;font-size:var(--small-font)" data-i18n="sessionBuilderTitle">Training Session Builder</h4>

        <label data-i18n="sessionName">Sessionsnavn</label>
        <input id="session-name" type="text">

        <label style="margin-top:8px" data-i18n="sessionDesc">Sessionsbeskrivelse</label>
        <input id="session-desc" type="text">

        <label style="margin-top:8px" data-i18n="exercisesLabel">√òvelser</label>
        <div id="session-items" style="max-height:300px;overflow:auto"></div>

        <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
          <div style="font-size:var(--small-font)">Total:</div>
          <div id="session-total" style="font-weight:700">0 m</div>
          <div style="margin-left:auto;font-size:var(--small-font)" id="session-count">0 √∏velser</div>
        </div>

        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="save-session" class="btn btn-primary" data-i18n="saveSession">Gem</button>
          <button id="clear-session" class="btn btn-ghost" data-i18n="clearSession">Ryd</button>
          <!-- Cancel session edit (Fortryd) -->
          <button id="cancel-session-edit" class="btn btn-ghost" style="display:none">Fortryd</button>
        </div>

        <div id="session-lock-info" style="margin-top:12px;color:var(--muted);display:none;font-size:var(--tiny-font)">Gratis brugere kan ikke gemme eller bygge sessioner. K√∏b adgang for at l√•se op.</div>

        <hr style="border:none;border-top:1px solid var(--border-soft);margin:12px 0;">
        <h4 style="margin:0 0 8px 0;font-size:var(--small-font)" data-i18n="savedSessions">Gemte sessioner</h4>
        <div id="sessions-list" style="max-height:340px;overflow:auto"></div>
      </aside>
    </div>
  </div>

  <div id="admin-modal" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:999">
    <div style="background:var(--panel);padding:12px;border-radius:10px;max-width:420px;width:92%">
      <h3 style="margin-top:0">Admin login</h3>
      <input id="admin-password" type="password" placeholder="Password" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border-soft);margin-bottom:12px;font-size:var(--small-font)">
      <div style="display:flex;gap:12px;justify-content:flex-end">
        <button id="admin-cancel" class="btn btn-ghost">Annuller</button>
        <button id="admin-submit" class="btn btn-primary">Login</button>
      </div>
    </div>
  </div>

  <div id="confirm-modal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:1000">
    <div style="background:var(--panel);padding:14px;border-radius:12px;max-width:420px;width:92%">
      <h3 id="confirm-title">Bekr√¶ft</h3>
      <p id="confirm-message" style="color:var(--muted)">Er du sikker?</p>
      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button id="confirm-no" class="btn btn-ghost">Nej</button>
        <button id="confirm-yes" class="btn btn-ghost" style="color:var(--danger)">Ja</button>
      </div>
    </div>
  </div>

  <div id="bottom-bar" style="display:none">
    <button id="backup-btn" class="bottom-btn">Backup</button>
    <button id="restore-btn" class="bottom-btn restore">Restore</button>
    <input id="restore-file" type="file" accept="application/json" style="display:none">
  </div>

<script>
/* ---------- CONFIG ---------- */
const ADMIN_PASSWORD = "admin123";
const EX_KEY = "lezgo_exercises_v3";
const SES_KEY = "lezgo_sessions_v3";
const CAT_KEY = "lezgo_categories_v3";
const LVL_KEY = "lezgo_levels_v3";
const INT_KEY = "lezgo_intensities_v3";
const PLR_KEY = "lezgo_players_v3";
const THEME_KEY = 'lezgo_theme';
const LANG_KEY = 'lezgo_lang';

const DEFAULT_CATEGORIES = ["Back wall","Bandeja","Chiquita","Defense","Double wall","Groundstroke","Lob","Serve","Smash","Vibora","Volley"].sort();
const DEFAULT_LEVELS = ["Beginner","Intermediate","Advanced"];
const DEFAULT_INT = ["Low","Medium","High"];
const DEFAULT_PLAYERS = ["1","2","3","4","1-2","1-3","1-4","2-4","Any","Add new..."];

const $ = id => document.getElementById(id);
const uid = () => "id_" + Math.random().toString(36).slice(2,10);
const isAdmin = () => localStorage.getItem("is_admin") === "1";
const isPaid  = () => localStorage.getItem("is_paid") === "1";

/* ---------- i18n (simple) ---------- */
const I18 = {
  da: {
    buy: "K√∏b", admin: "Admin", logout: "Log ud", save: "Gem", clear: "Ryd", cancel: "Annuller", deleteAll: "Slet alle",
    formTitle: "Tilf√∏j / Rediger √∏velse (Padel)", sessionBuilderTitle: "Training Session Builder", sessionName: "Sessionsnavn",
    sessionDesc: "Sessionsbeskrivelse", exercisesLabel: "√òvelser", saveSession: "Gem", clearSession: "Ryd", savedSessions: "Gemte sessioner",
    search: "S√∏g..."
  },
  en: {
    buy: "Buy", admin: "Admin", logout: "Sign out", save: "Save", clear: "Clear", cancel: "Cancel", deleteAll: "Delete all",
    formTitle: "Add / Edit exercise (Padel)", sessionBuilderTitle: "Training Session Builder", sessionName: "Session name",
    sessionDesc: "Session description", exercisesLabel: "Exercises", saveSession: "Save", clearSession: "Clear", savedSessions: "Saved sessions",
    search: "Search..."
  }
};

function applyLanguage(lang){
  const map = I18[lang] || I18.da;
  $('form-title').textContent = map.formTitle;
  $('save-btn').textContent = map.save;
  $('clear-btn').textContent = map.clear;
  $('cancel-edit-btn').textContent = map.cancel;
  $('delete-all-btn').textContent = map.deleteAll;
  $('btn-buy').textContent = map.buy;
  $('btn-admin').textContent = map.admin;
  $('btn-logout').textContent = map.logout;
  $('save-session').textContent = map.saveSession;
  $('clear-session').textContent = map.clearSession;
  if($('search')) $('search').placeholder = map.search;
  localStorage.setItem(LANG_KEY, lang);
}

/* ---------- STATE ---------- */
let exercises = [], sessions = [], categories = [], levels = [], intensities = [], players = [];
let editingId = null;
let editingSessionId = null;
let originalSessionSnapshot = null; // store original copy when editing a session so we can "fortryd"
let renderIndex = 0;
const BATCH = 100;
const platformState = new Set();

/* ---------- STORAGE ---------- */
function loadAll(){
  exercises = JSON.parse(localStorage.getItem(EX_KEY) || "[]");
  sessions = JSON.parse(localStorage.getItem(SES_KEY) || "[]");
  categories = JSON.parse(localStorage.getItem(CAT_KEY) || "null") || DEFAULT_CATEGORIES;
  levels = JSON.parse(localStorage.getItem(LVL_KEY) || "null") || DEFAULT_LEVELS;
  intensities = JSON.parse(localStorage.getItem(INT_KEY) || "null") || DEFAULT_INT;
  players = JSON.parse(localStorage.getItem(PLR_KEY) || "null") || DEFAULT_PLAYERS;
}
function persistAll(){ localStorage.setItem(EX_KEY, JSON.stringify(exercises)); localStorage.setItem(SES_KEY, JSON.stringify(sessions)); localStorage.setItem(CAT_KEY, JSON.stringify(categories)); localStorage.setItem(LVL_KEY, JSON.stringify(levels)); localStorage.setItem(INT_KEY, JSON.stringify(intensities)); localStorage.setItem(PLR_KEY, JSON.stringify(players)); }

/* ---------- INIT ---------- */
function init(){
  applyTheme(localStorage.getItem(THEME_KEY) || 'dark');
  const lang = localStorage.getItem(LANG_KEY) || 'da';
  $("lang-select").value = lang;
  applyLanguage(lang);
  loadAll(); populateSelects(); bindEvents(); refreshUI();
}

/* ---------- UI helpers ---------- */
function populateSelects(){
  const cat = $("category"), lvl = $("level"), intSel = $("intensity"), pl = $("players"), fcat = $("filter-category"), flvl = $("filter-level");
  if(cat){ cat.innerHTML=''; categories.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; cat.appendChild(o); }); const add = document.createElement('option'); add.value='__ADD__'; add.textContent='Add new...'; cat.appendChild(add); }
  if(fcat){ fcat.innerHTML=''; const optAll=document.createElement('option'); optAll.value=''; optAll.text='ALL'; fcat.appendChild(optAll); categories.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.text=c; fcat.appendChild(o); }); }
  if(lvl){ lvl.innerHTML=''; levels.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.text=c; lvl.appendChild(o); }); const addL=document.createElement('option'); addL.value='__ADD__'; addL.text='Add new...'; lvl.appendChild(addL); }
  if(flvl){ flvl.innerHTML=''; const optAll2=document.createElement('option'); optAll2.value=''; optAll2.text='ALL'; flvl.appendChild(optAll2); levels.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.text=c; flvl.appendChild(o); }); }
  if(intSel){ intSel.innerHTML=''; intensities.forEach(i=>{ const o=document.createElement('option'); o.value=i; o.text=i; intSel.appendChild(o); }); const addI=document.createElement('option'); addI.value='__ADD__'; addI.text='Add new...'; intSel.appendChild(addI); }
  if(pl){ pl.innerHTML=''; players.forEach(p=>{ const o=document.createElement('option'); o.value=p; o.text=p; pl.appendChild(o); }); const addP=document.createElement('option'); addP.value='__ADD__'; addP.text='Add new...'; pl.appendChild(addP); }
}

function bindEvents(){
  $("theme-toggle").addEventListener('click', ()=> applyTheme(localStorage.getItem(THEME_KEY) === 'light' ? 'dark' : 'light'));
  $("lang-select").addEventListener('change', e => { applyLanguage(e.target.value); });

  $("category").addEventListener('change', e => { if(e.target.value==='__ADD__'){ const n = prompt('Ny kategori:'); if(n){ categories.push(n.trim()); persistAll(); populateSelects(); } }});
  $("level").addEventListener('change', e => { if(e.target.value==='__ADD__'){ const n = prompt('Nyt niveau:'); if(n){ levels.push(n.trim()); persistAll(); populateSelects(); } }});
  $("intensity").addEventListener('change', e => { if(e.target.value==='__ADD__'){ const n = prompt('Ny intensitet:'); if(n){ intensities.push(n.trim()); persistAll(); populateSelects(); } }});
  $("players").addEventListener('change', e => { if(e.target.value==='__ADD__' || e.target.value==='Add new...'){ const n = prompt('Tilf√∏j ny spiller-range:'); if(n){ players.push(n.trim()); persistAll(); populateSelects(); } }});

  $("save-btn").addEventListener('click', onSaveExercise);
  $("clear-btn").addEventListener('click', clearForm);
  $("cancel-edit-btn").addEventListener('click', (e)=>{ e.preventDefault(); cancelEditMode(); });

  $("delete-all-btn").addEventListener('click', ()=> {
    if(!isAdmin()){ alert('Admin kr√¶ves'); return; }
    const pass = prompt('Admin kode:'); if(pass !== ADMIN_PASSWORD){ alert('Forkert kode'); return; }
    if(confirm('Slet ALLE √∏velser?')){ exercises=[]; persistAll(); refreshUI(); }
  });

  $("search").addEventListener('input', ()=> { renderIndex=0; renderList(true); });
  $("filter-category").addEventListener('change', ()=> { renderIndex=0; renderList(true); });
  $("filter-level").addEventListener('change', ()=> { renderIndex=0; renderList(true); });

  document.querySelectorAll('.platform-btn').forEach(btn => {
    btn.addEventListener('click', (e)=>{
      const platform = btn.getAttribute('data-platform');
      if(!platform) return;
      if(platformState.has(platform)){ platformState.delete(platform); btn.classList.remove('active'); btn.setAttribute('aria-pressed','false'); }
      else { platformState.add(platform); btn.classList.add('active'); btn.setAttribute('aria-pressed','true'); }
      renderIndex=0; renderList(true);
    });
  });

  $("btn-admin").addEventListener('click', ()=> $("admin-modal").style.display='flex');
  $("admin-cancel").addEventListener('click', ()=> $("admin-modal").style.display='none');
  $("admin-submit").addEventListener('click', ()=> {
    if($("admin-password").value === ADMIN_PASSWORD){ localStorage.setItem('is_admin','1'); $("admin-modal").style.display='none'; applyPermissions(); alert('Admin aktiveret'); } else alert('Forkert kode');
  });
  $("btn-logout").addEventListener('click', ()=> { localStorage.removeItem('is_admin'); applyPermissions(); });

  $("btn-buy").addEventListener('click', ()=> {
    if(isPaid()){ if(confirm('Deaktiver paid mode?')){ localStorage.removeItem('is_paid'); applyPermissions(); } }
    else { if(confirm('Aktiver paid mode?')){ localStorage.setItem('is_paid','1'); applyPermissions(); } }
  });

  $("load-more").addEventListener('click', ()=> renderList(false));
  $("save-session").addEventListener('click', saveSession);
  $("clear-session").addEventListener('click', clearSessionBuilder);
  $("cancel-session-edit").addEventListener('click', (e)=>{ e.preventDefault(); cancelSessionEdit(); });

  $("analyze-btn").addEventListener('click', (ev)=>{ ev.preventDefault(); analyzeLinkAction(); });

  $("backup-btn").addEventListener('click', doBackup);
  $("restore-btn").addEventListener('click', ()=> $("restore-file").click());
  $("restore-file").addEventListener('change', handleRestoreFile);

  $("confirm-no").addEventListener('click', ()=> closeConfirm(false));
  $("confirm-yes").addEventListener('click', ()=> closeConfirm(true));
}

/* ---------- LINKS LABEL ---------- */
function getLinkLabel(link){
  try{
    const host = new URL(link).hostname.toLowerCase();
    if(host.includes('youtube') || host.includes('youtu.be')) return 'Video';
    if(host.includes('instagram') || host.includes('cdninstagram')) return 'Video';
    if(host.includes('facebook') || host.includes('fb.watch') || host.includes('fbcdn')) return 'Video';
    return 'Link';
  }catch(e){ return 'Link'; }
}

/* ---------- RENDER LIST ---------- */
function renderList(reset = true){
  const list = $("list");
  if(!list) return;
  if(reset){ renderIndex=0; list.innerHTML=''; }
  const q = ($("search").value||"").trim().toLowerCase();
  const fc = ($("filter-category").value||"");
  const fl = ($("filter-level").value||"");
  let items = exercises.slice();

  if(platformState.size > 0){
    items = items.filter(it => {
      if(!it.link) return false;
      try{
        const host = new URL(it.link).hostname.toLowerCase();
        const isY = host.includes('youtube') || host.includes('youtu.be') || host.includes('youtube.googleapis.com');
        const isI = host.includes('instagram') || host.includes('cdninstagram');
        const isF = host.includes('facebook') || host.includes('fb.watch') || host.includes('fbcdn');
        if(platformState.has('youtube') && isY) return true;
        if(platformState.has('instagram') && isI) return true;
        if(platformState.has('facebook') && isF) return true;
        return false;
      }catch(e){ return false; }
    });
  }

  if(fc) items = items.filter(x => x.category === fc);
  if(fl) items = items.filter(x => x.level === fl);
  if(q) items = items.filter(x => (x.title||"").toLowerCase().includes(q) || (x.description||"").toLowerCase().includes(q) || (x.tags||"").toLowerCase().includes(q));

  const total = items.length;
  const start = renderIndex;
  const end = Math.min(start + BATCH, total);
  const slice = items.slice(start, end);

  const frag = document.createDocumentFragment();
  slice.forEach(ex => {
    const row = document.createElement('div'); row.className='exercise'; row.dataset.id = ex.id;

    const cb = document.createElement('input'); cb.type='checkbox'; cb.style.marginRight='8px';
    if($("session-items").querySelector(`[data-id="${ex.id}"]`)) cb.checked = true;
    cb.addEventListener('change', ev => {
      if(ev.target.checked) addToSessionBuilder(ex.id);
      else removeFromSessionBuilder(ex.id);
    });
    row.appendChild(cb);

    const left = document.createElement('div'); left.className='left';
    const title = document.createElement('div'); title.className='title'; title.textContent = ex.title || "(no title)"; left.appendChild(title);
    const meta = document.createElement('div'); meta.className='meta'; meta.textContent = `${ex.category || ''} ‚Ä¢ ${ex.level || ''} ‚Ä¢ ${ex.players || ''} ‚Ä¢ ${ex.duration || 0}m`; left.appendChild(meta);

    if(ex.link){
      const a = document.createElement('a'); a.href = ex.link; a.target = '_blank'; a.rel = 'noopener noreferrer'; a.className = 'link-label';
      a.textContent = getLinkLabel(ex.link); a.title = ex.link;
      left.appendChild(a);
    }

    if(ex.tags){
      const tagWrap = document.createElement('div'); tagWrap.className='tag-wrap';
      ex.tags.split(',').slice(0,20).forEach(tg => {
        const s = document.createElement('span'); s.className='tag'; s.textContent = tg.trim();
        tagWrap.appendChild(s);
      });
      left.appendChild(tagWrap);
    }

    row.appendChild(left);

    const right = document.createElement('div'); right.className='actions-small';
    if(isAdmin() || isPaid()){
      const editBtn = document.createElement('button'); editBtn.className='btn btn-ghost'; editBtn.textContent = 'Rediger';
      // CALL populateFormForEdit (now defined below)
      editBtn.addEventListener('click', ()=> { editingId = ex.id; populateFormForEdit(ex); enterEditMode(); window.scrollTo({top:0,behavior:'smooth'}); });
      right.appendChild(editBtn);

      const delBtn = document.createElement('button'); delBtn.className='btn btn-ghost'; delBtn.style.color='var(--danger)'; delBtn.textContent='Slet';
      delBtn.addEventListener('click', ()=> showConfirm('Er du sikker?', ()=>{ exercises = exercises.filter(x => x.id !== ex.id); persistAll(); refreshUI(); removeFromSessionBuilder(ex.id); }));
      right.appendChild(delBtn);
    }
    row.appendChild(right);
    frag.appendChild(row);
  });

  list.appendChild(frag);
  renderIndex = end;
  const loadMore = $("load-more");
  if(renderIndex < total){ loadMore.style.display = 'block'; loadMore.textContent = `Vis flere (${total - renderIndex})`; } else loadMore.style.display = 'none';
  if(total === 0 && start === 0){ list.innerHTML = `<div style="color:var(--muted);font-size:var(--small-font)">Ingen resultater</div>`; }
}

/* ---------- FORM EDIT MODE ---------- */
function enterEditMode(){
  $("cancel-edit-btn").style.display = 'inline-flex';
  $("save-btn").textContent = (localStorage.getItem(LANG_KEY) === 'en' ? 'Update' : 'Opdater') || 'Opdater';
  document.querySelector('.card').style.boxShadow = '0 10px 28px rgba(34,197,94,0.06)';
}
function cancelEditMode(){
  editingId = null;
  clearForm();
  $("cancel-edit-btn").style.display = 'none';
  applyLanguage(localStorage.getItem(LANG_KEY) || 'da');
  document.querySelector('.card').style.boxShadow = '0 10px 28px rgba(2,6,23,.6)';
}

/* ---------- populateFormForEdit (fix) ---------- */
function populateFormForEdit(ex){
  if(!ex) return;
  $("title").value = ex.title||'';
  $("link").value = ex.link||'';
  if($("category")) $("category").value = ex.category||'';
  if($("players")) $("players").value = ex.players||'';
  $("duration").value = ex.duration||'';
  if($("level")) $("level").value = ex.level||'';
  if($("intensity")) $("intensity").value= ex.intensity||'';
  $("description").value = ex.description||'';
  $("tags").value = ex.tags||'';
  // editingId set by caller
  enterEditMode();
}

/* ---------- FORM HANDLERS ---------- */
function onSaveExercise(){
  const title = ($("title").value || "").trim();
  if(!title){ alert((localStorage.getItem(LANG_KEY)==='en') ? 'Enter a title' : 'Indtast titel'); return; }
  const link = ($("link").value || "").trim();
  const dupTitle = exercises.some(e => e.title && e.title.toLowerCase() === title.toLowerCase() && e.id !== editingId);
  const dupLink = link ? exercises.some(e => e.link === link && e.id !== editingId) : false;
  if(dupTitle || dupLink){ alert((localStorage.getItem(LANG_KEY)==='en') ? 'Duplicate found: title or link exists' : 'Duplikat fundet: titel eller link findes allerede'); return; }
  const item = { id: editingId || uid(), title, link, category: $("category").value, players: $("players").value, duration: Number($("duration").value||0), level: $("level").value, intensity: $("intensity").value, description: $("description").value||"", tags: ($("tags").value||"").trim(), createdAt: new Date().toISOString() };
  if(editingId){ const idx = exercises.findIndex(x => x.id === editingId); if(idx>-1) exercises[idx] = item; } else exercises.unshift(item);
  persistAll(); editingId = null; clearForm(); refreshUI();
  $("cancel-edit-btn").style.display = 'none';
  applyLanguage(localStorage.getItem(LANG_KEY) || 'da');
  document.querySelector('.card').style.boxShadow = '0 10px 28px rgba(2,6,23,.6)';
}
function clearForm(){ editingId=null; $("title").value=''; $("link").value=''; if($("category")) $("category").selectedIndex=0; if($("players")) $("players").selectedIndex=0; $("duration").value=''; if($("level")) $("level").selectedIndex=0; if($("intensity")) $("intensity").selectedIndex=0; $("description").value=''; $("tags").value=''; $("cancel-edit-btn").style.display='none'; }

/* ---------- SESSION BUILDER ---------- */
function addToSessionBuilder(id){
  if(!isAdmin() && !isPaid()){ alert('Betalt adgang kr√¶ves.'); const cb = document.querySelector(`#list [data-id="${id}"] input[type="checkbox"]`); if(cb) cb.checked=false; return; }
  const box = $("session-items");
  if(box.querySelector(`[data-id="${id}"]`)) return;
  const ex = exercises.find(e => e.id === id); if(!ex) return;
  const row = document.createElement('div'); row.className='exercise'; row.dataset.id = id; row.style.marginBottom='6px';
  row.innerHTML = `<div style="flex:1"><div style="font-weight:700">${escapeHtml(ex.title)}</div><div style="color:var(--muted);font-size:var(--tiny-font)">${ex.duration}m ‚Ä¢ ${escapeHtml(ex.category)}</div></div><button class="btn btn-ghost" style="color:var(--danger);font-size:var(--small-font)">Fjern</button>`;
  row.querySelector('button').addEventListener('click', ()=>{ row.remove(); const cb = document.querySelector(`#list [data-id="${id}"] input[type="checkbox"]`); if(cb) cb.checked=false; recalcSession(); });
  box.appendChild(row); recalcSession();
}
function removeFromSessionBuilder(id){ const box = $("session-items"); const node = box.querySelector(`[data-id="${id}"]`); if(node) node.remove(); recalcSession(); }
function recalcSession(){ let total=0,count=0; document.querySelectorAll("#session-items .exercise").forEach(r => { const ex = exercises.find(e => e.id === r.dataset.id); if(ex){ total += Number(ex.duration||0); count++; }}); $("session-total").textContent = total + " m"; $("session-count").textContent = count + " √∏velser"; }
function clearSessionBuilder(){ if($("session-items")) $("session-items").innerHTML=''; if($("session-name")) $("session-name").value=''; if($("session-desc")) $("session-desc").value=''; recalcSession(); editingSessionId = null; originalSessionSnapshot = null; $("cancel-session-edit").style.display='none'; }
function saveSession(){
  if(!isAdmin() && !isPaid()){ alert('Betalt adgang kr√¶ves.'); return; }
  const name = ($("session-name").value||'').trim(); if(!name){ alert('Tilf√∏j et sessionsnavn'); return; }
  const ids = Array.from(document.querySelectorAll('#session-items .exercise')).map(r=>r.dataset.id);
  const total = ids.reduce((a,id)=>{ const ex = exercises.find(e=>e.id===id); return a + (ex?Number(ex.duration||0):0); },0);
  if(editingSessionId){
    const idx = sessions.findIndex(s=>s.id===editingSessionId);
    if(idx>-1){ sessions[idx].name = name; sessions[idx].description = $("session-desc").value||''; sessions[idx].items = ids; sessions[idx].total = total; }
  } else {
    const s = { id: uid(), name, description: $("session-desc").value||'', items: ids, total, createdAt: new Date().toISOString() };
    sessions.unshift(s);
  }
  persistAll(); renderSessions(); alert('Session gemt'); editingSessionId = null; originalSessionSnapshot = null; $("cancel-session-edit").style.display='none';
}

/* ---------- SESSION EDIT / FORTRYD ---------- */
function cancelSessionEdit(){
  if(!editingSessionId || !originalSessionSnapshot) { clearSessionBuilder(); return; }
  // restore the original session in sessions[] (do not overwrite if user had already saved other changes)
  const idx = sessions.findIndex(s=>s.id===editingSessionId);
  if(idx>-1){
    sessions[idx] = JSON.parse(JSON.stringify(originalSessionSnapshot));
    persistAll();
  }
  // load original back to builder
  loadSessionToBuilder(originalSessionSnapshot.id);
  editingSessionId = null;
  originalSessionSnapshot = null;
  $("cancel-session-edit").style.display='none';
  alert('Redigering annulleret ‚Äî session gendannet.');
}

/* ---------- RENDER SESSIONS (with Rediger + √Öbn) ---------- */
function renderSessions(){
  const box = $("sessions-list"); box.innerHTML=''; if(!sessions.length){ box.innerHTML = `<div style="color:var(--muted);font-size:var(--small-font)">Ingen gemte sessioner</div>`; return; }
  sessions.forEach(s => {
    const div = document.createElement('div'); div.className='exercise'; div.style.marginBottom='8px';
    div.innerHTML = `<div style="flex:1"><div style="font-weight:800">${escapeHtml(s.name)}</div><div style="color:var(--muted);font-size:var(--tiny-font)">${(s.items||[]).length} √∏velser ‚Ä¢ ${s.total||0} m</div></div>`;
    const editBtn = document.createElement('button'); editBtn.className='btn btn-ghost'; editBtn.textContent='Rediger';
    editBtn.addEventListener('click', ()=> { editingSessionId = s.id; originalSessionSnapshot = JSON.parse(JSON.stringify(s)); loadSessionToBuilder(s.id); $("cancel-session-edit").style.display='inline-flex'; window.scrollTo({top:0,behavior:'smooth'}); });
    const openBtn = document.createElement('button'); openBtn.className='btn btn-ghost'; openBtn.textContent='√Öbn';
    openBtn.addEventListener('click', ()=> openSessionInNewWindow(s.id));
    const delBtn = document.createElement('button'); delBtn.className='btn btn-ghost'; delBtn.style.color='var(--danger)'; delBtn.textContent='Slet';
    delBtn.addEventListener('click', ()=> showConfirm('Slet session?', ()=>{ sessions = sessions.filter(x=>x.id!==s.id); persistAll(); renderSessions(); }));
    div.appendChild(editBtn); div.appendChild(openBtn); if(isAdmin()||isPaid()) div.appendChild(delBtn);
    box.appendChild(div);
  });
}

function loadSessionToBuilder(id){
  const s = sessions.find(x=>x.id===id); if(!s) return;
  const box = $("session-items"); box.innerHTML='';
  s.items.forEach(iid => {
    const ex = exercises.find(e=>e.id===iid); if(!ex) return;
    const r = document.createElement('div'); r.className='exercise'; r.dataset.id=iid; r.style.marginBottom='6px';
    r.innerHTML = `<div style="flex:1"><div style="font-weight:700">${escapeHtml(ex.title)}</div><div style="color:var(--muted);font-size:var(--tiny-font)">${ex.duration}m ‚Ä¢ ${escapeHtml(ex.category)}</div></div><button class="btn btn-ghost" style="color:var(--danger);font-size:var(--small-font)">Fjern</button>`;
    r.querySelector('button').addEventListener('click', ()=>{ r.remove(); recalcSession(); const cb = document.querySelector(`#list [data-id="${iid}"] input[type="checkbox"]`); if(cb) cb.checked=false; });
    box.appendChild(r);
  });
  $("session-name").value = s.name||'';
  $("session-desc").value = s.description||'';
  recalcSession();
  document.querySelectorAll('#list .exercise').forEach(row => {
    const cb = row.querySelector('input[type="checkbox"]');
    if(!cb) return;
    const id = row.dataset.id;
    cb.checked = !!s.items.find(i => i === id);
  });
}

/* ---------- OPEN SESSION IN NEW WINDOW ---------- */
function openSessionInNewWindow(id){
  const s = sessions.find(x=>x.id===id); if(!s) return alert('Session not found');
  let html = `<!doctype html><html><head><meta charset="utf-8"><title>${escapeHtml(s.name)}</title><meta name="viewport" content="width=device-width,initial-scale=1"></head><body style="font-family:sans-serif;padding:18px;background:#071226;color:#e6eef6">`;
  html += `<h2 style="color:#fff">${escapeHtml(s.name)}</h2>`;
  if(s.description) html += `<p style="color:#9aa7b3">${escapeHtml(s.description)}</p>`;
  html += "<ul>";
  (s.items||[]).forEach(id=>{
    const ex = exercises.find(e=>e.id===id);
    if(!ex) return;
    const label = ex.link ? getLinkLabel(ex.link) : 'No link';
    const href = ex.link ? ex.link : '#';
    html += `<li style="margin:10px 0;padding:8px;border-radius:8px;background:rgba(255,255,255,0.03)"><strong>${escapeHtml(ex.title)}</strong><div style="margin-top:6px"><a href="${href}" target="_blank" rel="noopener noreferrer" style="color:#7dd3fc;text-decoration:underline">${label}</a></div></li>`;
  });
  html += "</ul></body></html>";
  const w = window.open();
  if(!w) return alert('Pop-up blokeret ‚Äî tillad popups for dette site for at √•bne session i nyt vindue.');
  w.document.open();
  w.document.write(html);
  w.document.close();
}

/* ---------- CONFIRM, BACKUP, RESTORE, ANALYZE, UTILS ---------- */
let _confirmCb = null;
function showConfirm(message, cb){ _confirmCb = cb; $("confirm-message").textContent = message; $("confirm-modal").style.display='flex'; }
function closeConfirm(answer){ $("confirm-modal").style.display='none'; if(answer && typeof _confirmCb === 'function') _confirmCb(); _confirmCb = null; }

function doBackup(){ if(!isAdmin() && !isPaid()){ alert('Admin eller Paid kr√¶ves'); return; } const payload = { exercises, sessions, categories, levels, intensities, players, exportedAt: new Date().toISOString() }; const blob = new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`lezgo_backup_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'_')}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
function handleRestoreFile(ev){ if(!isAdmin() && !isPaid()){ alert('Admin eller Paid kr√¶ves'); return; } const file = ev.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = function(e){ try{ const data = JSON.parse(e.target.result); const mode = confirm("Tryk OK for MERGE (tilf√∏j), Annuller for ERSTATTE (erstat alt)"); if(mode){ const addedE = mergeExercises(data.exercises||[]); const addedS = mergeSessions(data.sessions||[]); persistAll(); refreshUI(); alert(`Importeret. √òvelser: ${addedE}, sessioner: ${addedS}`); } else { exercises = data.exercises || []; sessions = data.sessions || []; categories = data.categories || DEFAULT_CATEGORIES; levels = data.levels || DEFAULT_LEVELS; intensities = data.intensities || DEFAULT_INT; players = data.players || DEFAULT_PLAYERS; persistAll(); populateSelects(); refreshUI(); alert('Data erstattet.'); } }catch(err){ alert('Kunne ikke l√¶se fil: ' + err.message); } }; reader.readAsText(file); ev.target.value=''; }
function mergeExercises(imported){ let added=0; (imported||[]).forEach(im=>{ const dup = exercises.some(e => (im.link && e.link === im.link) || (im.title && e.title && e.title.toLowerCase() === im.title.toLowerCase())); if(!dup){ exercises.push(im); added++; } }); return added; }
function mergeSessions(imported){ let added=0; (imported||[]).forEach(im=>{ const dup = sessions.some(s => s.name && im.name && s.name.toLowerCase() === im.name.toLowerCase()); if(!dup){ sessions.push(im); added++; } }); return added; }

async function fetchVideoMetadata(link){
  try{
    const oUrl = `https://noembed.com/embed?url=${encodeURIComponent(link)}`;
    const r = await fetch(oUrl);
    if(r.ok){ const j = await r.json(); if(j && (j.title || j.author_name)) return { title:j.title||'', description:j.author_name||'' }; }
  }catch(e){ console.warn('fetchVideoMetadata error', e); }
  return null;
}
async function analyzeLinkAction(){
  const link = ($("link").value || "").trim();
  if(!link){ alert('Inds√¶t et videolink f√∏rst'); return; }
  $("analyze-btn").textContent = 'Analyserer‚Ä¶'; $("analyze-btn").disabled = true;
  try{
    const meta = await fetchVideoMetadata(link);
    if(meta){
      if(meta.title) $("title").value = meta.title;
      if(meta.description) $("description").value = meta.description;
      alert('Analyse f√¶rdig ‚Äî felter opdateret hvis metadata fundet.');
    } else {
      alert('Kunne ikke hente metadata. Pr√∏v et YouTube-link eller tjek CORS.');
    }
  }catch(err){ console.error(err); alert('Fejl under analyse'); }
  finally{ $("analyze-btn").textContent = 'üîç'; $("analyze-btn").disabled = false; }
}

function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function applyTheme(theme){ if(theme==='light'){ document.body.classList.add('light'); $("theme-toggle").textContent='üåû'; } else { document.body.classList.remove('light'); $("theme-toggle").textContent='üåô'; } localStorage.setItem(THEME_KEY, theme); }
function applyPermissions(){
  $("bottom-bar").style.display = (isAdmin()||isPaid()) ? 'flex' : 'none';
  $("delete-all-btn").style.display = isAdmin() ? 'inline-flex' : 'none';
  $("save-session").style.display = (isAdmin()||isPaid()) ? 'inline-flex' : 'none';
  $("clear-session").style.display = (isAdmin()||isPaid()) ? 'inline-flex' : 'none';
  const badges = $("badges"); badges.innerHTML='';
  if(isAdmin()){ const d=document.createElement('div'); d.className='badge'; d.textContent='ADMIN'; badges.appendChild(d); $("btn-logout").style.display='inline-flex'; } else $("btn-logout").style.display='none';
  if(isPaid()){ const d=document.createElement('div'); d.className='badge'; d.textContent='PAID'; badges.appendChild(d); }
  renderList(true); renderSessions();
}
function refreshUI(){ populateSelects(); applyPermissions(); renderIndex=0; renderList(true); renderSessions(); }

document.addEventListener('DOMContentLoaded', ()=>{ init(); });
</script>
</body>
</html>
