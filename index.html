<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>LezGo Padel ‚Äî Training Bank</title>

  <!-- Important for PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#0f1720" id="meta-theme-color" />
  <link rel="icon" href="ICON-192x192.png" sizes="192x192">

  <style>
    /* Minimal styles (kept compact) */
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%;margin:0;padding:0;overflow-x:hidden}
    body{font-family:Inter,system-ui,Arial,sans-serif;-webkit-font-smoothing:antialiased;transition:background .25s,color .25s}
    a{color:inherit}
    :root{
      --bg-top:#0f1720;--bg-bottom:#071226;--panel:#0b1a25;--muted:#9aa7b3;--text:#e6eef6;--accent:#22c55e;--danger:#ef4444;--card-shadow:0 10px 28px rgba(2,6,23,.6);--border-soft:rgba(255,255,255,.04);
    }
    body.light{--bg-top:#caced5;--bg-bottom:#bfc3cb;--panel:#d8dce3;--muted:#3c4652;--text:#0b1220;--accent:#16a34a;--danger:#dc2626;--card-shadow:0 6px 14px rgba(0,0,0,.12);--border-soft:rgba(0,0,0,.14);}
    .app-bg{background:linear-gradient(180deg,var(--bg-top) 0%,var(--bg-bottom) 100%);color:var(--text);min-height:100vh;padding-bottom:40px;}
    .container{max-width:1100px;margin:14px auto;padding:12px;width:94%}
    header{display:flex;flex-direction:column;align-items:center;gap:12px;margin-bottom:12px;padding-top:8px}
    #logo{width:min(62vw,520px);max-height:20vh;height:auto;display:block;margin:0 auto;object-fit:contain;transition:filter .18s,opacity .18s}
    .controls{display:flex;gap:12px;align-items:center;width:100%;justify-content:flex-end;flex-wrap:wrap;padding:0 6px;max-width:1100px;}
    .controls-left { margin-right:auto; display:flex; gap:8px; align-items:center; }
    .badge{background:rgba(255,255,255,.04);padding:6px 10px;border-radius:8px;font-weight:700;color:var(--muted)}
    .btn{border:0;padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer;background:transparent;color:var(--text);display:inline-flex;align-items:center;gap:8px}
    .btn-primary{background:var(--accent);color:#05261a;box-shadow:0 6px 14px rgba(0,0,0,.08)}
    .btn-ghost{background:transparent;border:1px solid var(--border-soft);color:var(--muted);padding:10px 12px}
    .theme-toggle{height:48px;min-width:48px;display:inline-grid;place-items:center;border-radius:12px;border:1px solid var(--border-soft);background:transparent;cursor:pointer;padding:6px;}
    .card{background:var(--panel);border-radius:12px;padding:14px;margin-bottom:14px;box-shadow:var(--card-shadow);transition:background .2s,box-shadow .2s}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=text],input[type=url],input[type=number],select,textarea{width:100%;padding:12px;border-radius:10px;border:1px solid var(--border-soft);background:transparent;color:var(--text);font-size:15px}
    textarea{min-height:84px;resize:vertical}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:680px){.grid{grid-template-columns:1fr}}
    .actions-row{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .two-column{display:grid;grid-template-columns:1fr 380px;gap:12px}
    @media(max-width:980px){.two-column{grid-template-columns:1fr}}
    .exercise{display:flex;gap:10px;padding:10px;border-radius:10px;border:1px solid var(--border-soft);align-items:flex-start}
    .tag{background:rgba(255,255,255,.03);padding:6px 8px;border-radius:8px;margin-right:8px;font-size:13px;display:inline-block}
    .actions-small{display:flex;flex-direction:column;gap:6px}
    .hidden{display:none!important}
    /* long link wrapping */
    a,div,span{word-break:break-word;overflow-wrap:anywhere;white-space:normal}
  </style>
</head>

<body class="app-bg">
  <div class="container">
    <header>
      <img id="logo" src="lezgo-logo.svg" alt="LezGo logo">
      <div class="controls">
        <div class="controls-left">
          <select id="lang-select" aria-label="Language select" style="padding:8px;border-radius:8px;border:1px solid var(--border-soft);background:transparent;color:var(--text)">
            <option value="en">English</option>
            <option value="da">Dansk</option>
          </select>
        </div>

        <div style="display:flex;gap:10px;align-items:center">
          <button id="btn-buy" class="btn btn-primary">Buy access</button>
          <button id="btn-admin" class="btn btn-ghost">Admin login</button>

          <button id="btn-export" class="btn btn-ghost hidden" title="Download backup">Download backup</button>
          <button id="btn-import" class="btn btn-ghost hidden" title="Restore backup">Restore backup</button>
          <input id="backup-file" type="file" accept="application/json" style="display:none">

          <button id="theme-toggle" class="theme-toggle" title="Toggle theme" aria-label="Toggle theme">
            <svg id="theme-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"></svg>
          </button>
        </div>
      </div>
    </header>

    <!-- FORM -->
    <section class="card">
      <h3 style="margin:0 0 10px 0;color:var(--muted)">Add / Edit exercise (Padel)</h3>

      <form id="exercise-form" class="grid" onsubmit="return false;">
        <div style="grid-column:1/-1;">
          <label>Title</label>
          <input id="title" type="text" placeholder="e.g. Forehand topspin drill">
        </div>

        <div>
          <label>Category</label>
          <select id="category"></select>
        </div>

        <div>
          <label>Players</label>
          <select id="players"></select>
        </div>

        <div>
          <label>Duration (minutes)</label>
          <input id="duration" type="number" min="0" placeholder="20">
        </div>

        <div>
          <label>Level</label>
          <select id="level"></select>
        </div>

        <div>
          <label>Intensity</label>
          <select id="intensity"></select>
        </div>

        <div style="grid-column:1/-1;">
          <label>Video link (YouTube / Instagram / Facebook)</label>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="link" type="url" placeholder="https://..." style="flex:1" />
            <button id="analyze-btn" class="btn btn-ghost">üîç Analyze</button>
          </div>
        </div>

        <div style="grid-column:1/-1;">
          <label>Description</label>
          <textarea id="description"></textarea>
        </div>

        <div style="grid-column:1/-1;">
          <label>Tags (comma separated)</label>
          <input id="tags" type="text" placeholder="e.g. Cross, Chiquita, Vibora">
        </div>

        <div id="share-preview" style="grid-column:1/-1;"></div>

        <div class="actions-row" style="grid-column:1/-1;margin-top:4px;">
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button id="save-btn" class="btn btn-primary">‚ûï Save exercise</button>
            <button id="clear-btn" class="btn btn-ghost">Clear form</button>
          </div>

          <button id="delete-all-btn" class="btn btn-danger hidden">üóëÔ∏è Delete all</button>
        </div>
      </form>
    </section>

    <!-- LIST + SESSION -->
    <section class="card">
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
        <input id="search" type="text" placeholder="Search..." style="flex:1;padding:10px;border-radius:10px;border:1px solid var(--border-soft);background:transparent;color:var(--text)">
        <select id="filter-category" style="padding:10px;border-radius:10px;border:1px solid var(--border-soft);background:transparent;color:var(--text)"><option>ALL</option></select>
        <select id="filter-level" style="padding:10px;border-radius:10px;border:1px solid var(--border-soft);background:transparent;color:var(--text)"><option>ALL</option></select>
        <button id="show-favorites" class="btn btn-ghost">Show favorites</button>
      </div>

      <div class="two-column">
        <div>
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap">
            <button id="select-all" class="btn btn-ghost">Select all</button>
            <button id="add-selected" class="btn btn-primary">Add to session</button>
            <div style="margin-left:auto" id="selected-count">0 selected</div>
          </div>

          <div id="list"></div>
        </div>

        <aside class="card" id="session-aside">
          <h4 style="margin:0">Training Session Builder</h4>

          <label>Session name</label>
          <input id="session-name" type="text">

          <label style="margin-top:8px">Session description</label>
          <input id="session-desc" type="text">

          <label style="margin-top:8px">Exercises</label>
          <div id="session-items" style="max-height:240px;overflow:auto"></div>

          <div style="display:flex;gap:10px;align-items:center;margin-top:10px;">
            <div>Total:</div>
            <div id="session-total" style="font-weight:700">0 m</div>
            <div style="margin-left:auto" id="session-count">0 exercises</div>
          </div>

          <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
            <button id="save-session" class="btn btn-primary">Save session</button>
            <button id="clear-session" class="btn btn-ghost">Clear</button>
          </div>

          <div id="session-lock-info" style="margin-top:14px;color:var(--muted);display:none;">
            Free users cannot save or build sessions. Buy access to unlock.
          </div>

          <hr style="border:none;border-top:1px solid var(--border-soft);margin:14px 0">

          <h4 style="margin:0 0 6px 0;">Saved sessions</h4>
          <div id="sessions-list" style="max-height:200px;overflow:auto"></div>
        </aside>
      </div>
    </section>
  </div>

  <!-- ADMIN MODAL -->
  <div id="admin-modal" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:999">
    <div style="background:var(--panel);padding:14px;border-radius:10px;max-width:420px;width:92%">
      <h3 style="margin-top:0">Admin login</h3>
      <input id="admin-password" type="password" placeholder="Password" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border-soft);margin-bottom:12px">
      <div style="display:flex;gap:12px;justify-content:flex-end">
        <button id="admin-cancel" class="btn btn-ghost">Cancel</button>
        <button id="admin-submit" class="btn btn-primary">Login</button>
      </div>
    </div>
  </div>

<script>
/* ------------- CONFIG & STATE ------------- */
const ADMIN_PASSWORD = "admin123";
const EX_KEY = "lezgo_exercises_v1";
const SES_KEY = "lezgo_sessions_v1";
const CAT_KEY = "lezgo_categories_v1";
const LVL_KEY = "lezgo_levels_v1";
const INT_KEY = "lezgo_intensities_v1";
const PLR_KEY = "lezgo_players_v1";
const THEME_KEY = "lezgo_theme";
const LANG_KEY = "lezgo_lang";

const DEFAULT_CATEGORIES = ["Back wall","Bandeja","Chiquita","Defense","Double wall","Groundstroke","Lob","Serve","Smash","Vibora","Volley"].sort();
const DEFAULT_LEVELS = ["Beginner","Intermediate","Advanced"];
const DEFAULT_INT = ["Low","Medium","High"];
const DEFAULT_PLAYERS = ["1","2","3","4","1-2","1-3","1-4","2-4","Any","Add new..."];

let exercises = [], sessions = [], categories = [], levels = [], intensities = [], players = [];
let editingId = null, selectedIds = new Set();

/* Helpers */
const $ = id => document.getElementById(id);
const uid = ()=> "id_" + Math.random().toString(36).slice(2,10);
const isAdmin = ()=> localStorage.getItem("is_admin")==="1";
const isPaid = ()=> localStorage.getItem("is_paid")==="1";

/* simple i18n (kept minimal) */
const translations = {
  en: { buyAccess:"Buy access", adminLogin:"Admin login", saveBtn:"‚ûï Save exercise", saveSession:"Save session", openBtn:"Open", deleteBtn:"Delete", noMatches:"No matches", noSessions:"No sessions saved", freeInfo:"Free users cannot save or build sessions. Buy access to unlock." },
  da: { buyAccess:"K√∏b adgang", adminLogin:"Admin login", saveBtn:"‚ûï Gem √∏velse", saveSession:"Gem session", openBtn:"√Öbn", deleteBtn:"Slet", noMatches:"Ingen resultater", noSessions:"Ingen gemte sessioner", freeInfo:"Gratis brugere kan ikke gemme eller bygge sessioner. K√∏b adgang for at l√•se op." }
};

function t(key){ const lang=localStorage.getItem(LANG_KEY)||'en'; return (translations[lang] && translations[lang][key]) || translations['en'][key] || key; }

/* ---------- Theme ---------- */
function applyTheme(theme){
  if(theme==='light'){ document.body.classList.add('light'); document.querySelector('#meta-theme-color').setAttribute('content','#eceff1'); setThemeIcon('light'); }
  else { document.body.classList.remove('light'); document.querySelector('#meta-theme-color').setAttribute('content','#0f1720'); setThemeIcon('dark'); }
  localStorage.setItem(THEME_KEY, theme);
}
function toggleTheme(){ const cur = localStorage.getItem(THEME_KEY) || 'dark'; applyTheme(cur==='dark'?'light':'dark'); }
function setThemeIcon(mode){
  const svg = document.getElementById('theme-icon'); if(!svg) return;
  svg.innerHTML = mode==='light' ? '<path d="M12 3v2M12 19v2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M1 12h2M21 12h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4M12 7a5 5 0 100 10 5 5 0 000-10z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>' : '<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>';
}

/* ---------- Storage load/save ---------- */
function loadAll(){
  exercises = JSON.parse(localStorage.getItem(EX_KEY) || "[]");
  sessions = JSON.parse(localStorage.getItem(SES_KEY) || "[]");
  categories = JSON.parse(localStorage.getItem(CAT_KEY) || "null") || DEFAULT_CATEGORIES;
  levels = JSON.parse(localStorage.getItem(LVL_KEY) || "null") || DEFAULT_LEVELS;
  intensities = JSON.parse(localStorage.getItem(INT_KEY) || "null") || DEFAULT_INT;
  players = JSON.parse(localStorage.getItem(PLR_KEY) || "null") || DEFAULT_PLAYERS;
  saveBase();
}
function saveBase(){ localStorage.setItem(CAT_KEY, JSON.stringify(categories)); localStorage.setItem(LVL_KEY, JSON.stringify(levels)); localStorage.setItem(INT_KEY, JSON.stringify(intensities)); localStorage.setItem(PLR_KEY, JSON.stringify(players)); }

/* ---------- UI populate ---------- */
function populateCategories(){ const sel=$("category"), fil=$("filter-category"); sel.innerHTML=""; fil.innerHTML=""; let allOpt=document.createElement('option'); allOpt.textContent='ALL'; allOpt.value=''; fil.appendChild(allOpt); categories.forEach(c=>{ let o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); let f=document.createElement('option'); f.value=c; f.textContent=c; fil.appendChild(f); }); let add=document.createElement('option'); add.value="__ADD__"; add.textContent="Add new category..."; sel.appendChild(add); }
function populateLevels(){ const sel=$("level"), fil=$("filter-level"); sel.innerHTML=""; fil.innerHTML=""; let allOpt=document.createElement('option'); allOpt.textContent='ALL'; allOpt.value=''; fil.appendChild(allOpt); levels.forEach(c=>{ let o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); let f=document.createElement('option'); f.value=c; f.textContent=c; fil.appendChild(f); }); let add=document.createElement('option'); add.value="__ADD__"; add.textContent="Add new level..."; sel.appendChild(add); }
function populateIntensity(){ const sel=$("intensity"); sel.innerHTML=""; intensities.forEach(c=>{ let o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); }); let add=document.createElement('option'); add.value="__ADD__"; add.textContent="Add new intensity..."; sel.appendChild(add); }
function populatePlayers(){ const sel=$("players"); sel.innerHTML=""; players.forEach(c=>{ let o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); }); }

/* ---------- Init ---------- */
function init(){
  const savedTheme = localStorage.getItem(THEME_KEY) || 'dark'; applyTheme(savedTheme);
  const savedLang = localStorage.getItem(LANG_KEY) || 'en'; $("lang-select").value = savedLang;

  loadAll();
  populateCategories(); populateLevels(); populateIntensity(); populatePlayers();
  bindEvents();
  renderList(); renderSessions();
  updateBadges(); toggleAdminUI(); updateSessionLock();
  // register service worker with proper scope for GitHub Pages site path:
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('service-worker.js', {scope: '/lezgopadel/'}).then(reg=>console.log('ServiceWorker registered with scope:', reg.scope)).catch(e=>console.warn('SW reg failed', e));
    navigator.serviceWorker.addEventListener('message', (e)=> {
      if(!e.data) return;
      if(e.data.type === 'share-target'){
        // prefer url, then text, then title
        const url = e.data.url || e.data.text || e.data.title || '';
        if(url){
          $("link").value = url;
          // optional: auto-trigger analyze ‚Äî comment out if undesired
          setTimeout(()=> $("analyze-btn").click(), 500);
        }
      }
    });
  }
}

/* ---------- Events ---------- */
function bindEvents(){
  $("theme-toggle").addEventListener('click', toggleTheme);
  $("btn-admin").addEventListener('click', ()=> $("admin-modal").style.display="flex");
  $("admin-cancel").addEventListener('click', ()=> $("admin-modal").style.display="none");
  $("admin-submit").addEventListener('click', ()=>{ if($("admin-password").value===ADMIN_PASSWORD){ localStorage.setItem("is_admin","1"); $("admin-modal").style.display="none"; updateBadges(); toggleAdminUI(); updateSessionLock(); alert('Admin enabled'); } else alert("Wrong password"); });

  $("btn-buy").addEventListener('click', ()=>{ if(isPaid()){ if(confirm("Disable paid access?")){ localStorage.removeItem("is_paid"); updateBadges(); updateSessionLock(); toggleAdminUI(); } } else { if(confirm("Simulate purchase?")){ localStorage.setItem("is_paid","1"); updateBadges(); updateSessionLock(); toggleAdminUI(); } } });

  $("category").addEventListener("change", e=>{ if(e.target.value==="__ADD__"){ let n=prompt("New category:"); if(n){ categories.push(n.trim()); saveBase(); populateCategories(); } }});
  $("level").addEventListener("change", e=>{ if(e.target.value==="__ADD__"){ let n=prompt("New level:"); if(n){ levels.push(n.trim()); saveBase(); populateLevels(); } }});
  $("intensity").addEventListener("change", e=>{ if(e.target.value==="__ADD__"){ let n=prompt("New intensity:"); if(n){ intensities.push(n.trim()); saveBase(); populateIntensity(); } }});
  $("players").addEventListener("change", e=>{ if(e.target.value==="Add new..."||e.target.value==="__ADD__"){ let n=prompt("Add new players range:"); if(n){ players.push(n.trim()); saveBase(); populatePlayers(); } }});

  $("save-btn").addEventListener("click", onSave);
  $("clear-btn").addEventListener("click", clearForm);
  $("delete-all-btn").addEventListener("click", ()=>{ if(!isAdmin()) return; if(confirm("Delete ALL exercises?")){ exercises=[]; localStorage.setItem(EX_KEY,"[]"); renderList(); }});

  $("search").addEventListener("input", renderList);
  $("filter-category").addEventListener("change", renderList);
  $("filter-level").addEventListener("change", renderList);

  $("select-all").addEventListener("click", ()=>{ document.querySelectorAll(".select-item").forEach(ch=>ch.checked=true); updateSelectedSet(); });
  $("add-selected").addEventListener("click", addSelectedToSession);
  $("save-session").addEventListener("click", saveSession);
  $("clear-session").addEventListener("click", clearSessionBuilder);

  $("lang-select").addEventListener("change", (e)=>{ const lang = e.target.value || 'en'; localStorage.setItem(LANG_KEY, lang); });

  $("analyze-btn").addEventListener('click', async (ev)=>{ ev.preventDefault(); const link = $("link").value.trim(); if(!link){ alert("Please paste a video link first"); return; } const btn = ev.currentTarget; const prev = btn.textContent; btn.textContent = "Analysing..."; btn.disabled=true;
    try{ const meta = await fetchVideoMetadata(link); if(meta){ if(meta.title) $("title").value = meta.title; if(meta.description) $("description").value = meta.description; const suggestions = analyzeTextToFields(meta.title||'', meta.description||''); if(!$("category").value) $("category").value = suggestions.category||$("category").options[0].value; if(!$("players").value) $("players").value = suggestions.players||$("players").options[0].value; if(!$("level").value) $("level").value = suggestions.level||$("level").options[0].value; if(!$("intensity").value) $("intensity").value = suggestions.intensity||$("intensity").options[0].value; if(!$("tags").value) $("tags").value = suggestions.tags||''; } else { alert("Could not fetch video metadata."); } }catch(err){ console.error(err); alert("Error during analysis"); } finally{ btn.textContent = prev; btn.disabled=false; } });

  $("btn-export").addEventListener('click', exportData);
  $("btn-import").addEventListener('click', ()=> $("backup-file").click());
  $("backup-file").addEventListener('change', (e)=>{ if(e.target.files && e.target.files[0]) importDataFile(e.target.files[0]); });
}

/* ---------- Save exercise ---------- */
function onSave(){
  const title = $("title").value.trim(); if(!title){ alert("Enter title"); return; }
  const ex = { id: editingId || uid(), title, category:$("category").value, players:$("players").value, duration:Number($("duration").value||0), level:$("level").value, intensity:$("intensity").value, link:$("link").value.trim(), description:$("description").value.trim(), tags:normalizeTags($("tags").value.trim()), favorite:false };
  // regular users and paid users can add; delete is restricted
  if(editingId){ const idx = exercises.findIndex(x=>x.id===editingId); if(idx>-1) exercises[idx] = ex; } else exercises.unshift(ex);
  localStorage.setItem(EX_KEY, JSON.stringify(exercises));
  clearForm(); renderList();
}
function normalizeTags(str){ if(!str) return ""; return str.split(",").map(t=>t.replace(/^#+/,"").trim()).filter(Boolean).join(", "); }
function clearForm(){ editingId=null; $("title").value=""; $("category").selectedIndex=0; $("players").selectedIndex=0; $("duration").value=""; $("level").selectedIndex=0; $("intensity").selectedIndex=0; $("link").value=""; $("description").value=""; $("tags").value=""; $("save-btn").textContent=t('saveBtn'); }

/* ---------- Render list (delete only visible for admin) ---------- */
function renderList(){
  const q = ($("search").value||"").trim().toLowerCase();
  const fc = $("filter-category").value; const fl = $("filter-level").value;
  const list = $("list"); list.innerHTML="";
  let items = exercises.slice();
  if(fc) items = items.filter(x=>x.category===fc);
  if(fl) items = items.filter(x=>x.level===fl);
  if(q) items = items.filter(x=>x.title.toLowerCase().includes(q) || (x.description||"").toLowerCase().includes(q) || (x.tags||"").toLowerCase().includes(q));
  if(items.length===0){ list.innerHTML = `<div style="color:var(--muted)">${t('noMatches')}</div>`; return; }
  items.forEach(ex=>{
    const row = document.createElement('div'); row.className='exercise'; row.dataset.id=ex.id;
    const cb = document.createElement('input'); cb.type='checkbox'; cb.className='select-item'; cb.addEventListener('change', updateSelectedSet); row.appendChild(cb);
    const left = document.createElement('div'); left.style.flex='1';
    const title = document.createElement('div'); title.style.fontWeight='800'; title.style.fontSize='15px'; title.textContent = ex.title; left.appendChild(title);
    const meta = document.createElement('div'); meta.style.color='var(--muted)'; meta.style.marginTop='6px'; meta.textContent = `${ex.category} ‚Ä¢ ${ex.level} ‚Ä¢ ${ex.players} ‚Ä¢ ${ex.duration}m`; left.appendChild(meta);
    if(ex.link){ const a = document.createElement('a'); a.href = ex.link; a.target = '_blank'; a.rel='noopener'; a.textContent = ex.link; a.style.display='block'; a.style.marginTop='6px'; left.appendChild(a); }
    if(ex.tags){ const tagDiv = document.createElement('div'); tagDiv.style.marginTop='8px'; ex.tags.split(',').forEach(tg=>{ const s=document.createElement('span'); s.className='tag'; s.textContent = tg.trim(); tagDiv.appendChild(s); }); left.appendChild(tagDiv); }
    row.appendChild(left);

    const right = document.createElement('div'); right.className='actions-small';
    const edit = document.createElement('button'); edit.className='btn btn-ghost'; edit.textContent='Edit'; edit.addEventListener('click', ()=> editItem(ex.id)); right.appendChild(edit);

    if(isAdmin()){
      const del = document.createElement('button'); del.className='btn btn-ghost'; del.style.color='var(--danger)'; del.textContent='Delete';
      del.addEventListener('click', ()=>{ if(confirm('Delete item?')){ exercises = exercises.filter(x=>x.id!==ex.id); localStorage.setItem(EX_KEY, JSON.stringify(exercises)); renderList(); }});
      right.appendChild(del);
    }
    row.appendChild(right);
    list.appendChild(row);
  });
  updateSelectedSet();
}

function editItem(id){
  const ex = exercises.find(x=>x.id===id); if(!ex) return;
  editingId = id; $("title").value=ex.title; $("category").value=ex.category; $("players").value=ex.players; $("duration").value=ex.duration; $("level").value=ex.level; $("intensity").value=ex.intensity; $("link").value=ex.link; $("description").value=ex.description; $("tags").value=ex.tags; $("save-btn").textContent = t('saveBtn'); window.scrollTo({top:0,behavior:'smooth'});
}

/* ---------- Session builder ---------- */
function updateSelectedSet(){ selectedIds.clear(); document.querySelectorAll(".select-item").forEach(cb=>{ if(cb.checked) selectedIds.add(cb.closest('.exercise').dataset.id); }); updateSelectedCount(); }
function updateSelectedCount(){ $("selected-count").textContent = (selectedIds.size||0) + " selected"; }

function addSelectedToSession(){
  if(!isPaid() && !isAdmin()){ alert("Paid access required."); return; }
  const box = $("session-items");
  selectedIds.forEach(id=>{ if(box.querySelector(`[data-id="${id}"]`)) return; const ex = exercises.find(x=>x.id===id); if(!ex) return;
    const row = document.createElement('div'); row.className='exercise'; row.dataset.id = id;
    row.innerHTML = `<div style="flex:1"><div style="font-weight:700">${ex.title}</div><div style="color:var(--muted)">${ex.duration}m ‚Ä¢ ${ex.category}</div></div><button class="btn btn-ghost remove-from-session" style="color:var(--danger)">Remove</button>`;
    row.querySelector('button').addEventListener('click', ()=>{ row.remove(); recalcSession(); });
    box.appendChild(row);
  });
  recalcSession();
}

function recalcSession(){ let total=0,count=0; document.querySelectorAll("#session-items .exercise").forEach(row=>{ const ex=exercises.find(x=>x.id===row.dataset.id); if(ex){ total+=Number(ex.duration||0); count++; }}); $("session-total").textContent = total + " m"; $("session-count").textContent = count + " exercises"; }
function clearSessionBuilder(){ $("session-items").innerHTML=''; $("session-name").value=''; $("session-desc").value=''; recalcSession(); }

function saveSession(){
  if(!isPaid() && !isAdmin()){ alert("Paid access required."); return; }
  const name = $("session-name").value.trim(); if(!name){ alert("Add a session name"); return; }
  const ids=[]; document.querySelectorAll("#session-items .exercise").forEach(r=>ids.push(r.dataset.id));
  const total = ids.reduce((a,id)=>{ const e = exercises.find(x=>x.id===id); return a + (e?Number(e.duration||0):0); }, 0);
  const ses = { id: uid(), name, description: $("session-desc").value, items: ids, total, owner: isAdmin()? 'admin' : (isPaid()? 'paid' : 'free'), created: Date.now() };
  sessions.unshift(ses); localStorage.setItem(SES_KEY, JSON.stringify(sessions));
  renderSessions(); clearSessionBuilder();
}

function renderSessions(){
  const box = $("sessions-list"); box.innerHTML='';
  if(sessions.length===0){ box.innerHTML = `<div style="color:var(--muted)">${t('noSessions')}</div>`; return; }
  sessions.forEach(s=>{
    const div = document.createElement('div'); div.className='exercise';
    div.innerHTML = `<div style="flex:1"><div style="font-weight:800">${s.name}</div><div style="color:var(--muted)">${s.items.length} exercises ‚Ä¢ ${s.total} m</div></div><button class="btn btn-ghost open-session">Open</button>`;
    const btn = div.querySelector('.open-session'); btn.addEventListener('click', ()=> openSessionDetail(s.id));
    // delete for paid owners and admin
    if(isAdmin() || (isPaid() && s.owner==='paid')){
      const del = document.createElement('button'); del.className='btn btn-ghost'; del.style.color='var(--danger)'; del.textContent='Delete';
      del.addEventListener('click', ()=>{ if(confirm('Delete session?')){ sessions = sessions.filter(x=>x.id!==s.id); localStorage.setItem(SES_KEY, JSON.stringify(sessions)); renderSessions(); }});
      div.appendChild(del);
    }
    box.appendChild(div);
  });
}

/* Open session: show detailed read-only modal (option A) */
function openSessionDetail(id){
  const s = sessions.find(x=>x.id===id); if(!s){ alert("Session not found"); return; }
  let html = `<div style="padding:12px;color:var(--text);"><h3>${s.name}</h3><p style="color:var(--muted)">${s.description||''}</p><ul>`;
  s.items.forEach(iid=>{ const ex = exercises.find(x=>x.id===iid); if(ex) html += `<li><strong>${ex.title}</strong> ‚Äî ${ex.category} ‚Ä¢ ${ex.level} ‚Ä¢ ${ex.players} ‚Ä¢ ${ex.duration}m<br><small style="color:var(--muted)">${ex.tags||''}</small><div><a href="${ex.link}" target="_blank" rel="noopener">${ex.link}</a></div></li><hr/>`; });
  html += `</ul></div>`;
  // simple modal using alert replacement:
  const w = window.open("", "_blank", "width=420,height=640"); if(!w) { // fallback: alert
    alert("Open blocked by popup blocker; allow popups for details.");
    return;
  }
  w.document.body.style.background = '#0b1a25';
  w.document.title = s.name + " ‚Äî LezGo Session";
  w.document.body.innerHTML = html;
}

/* ---------- Badges and admin UI ---------- */
function updateBadges(){
  // show small badges in header
  const left = document.querySelector('.controls-left');
  // remove previous badge nodes if any
  const existing = left.querySelectorAll('.badge'); existing.forEach(n=>n.remove());
  if(isAdmin()){ const d=document.createElement('div'); d.className='badge'; d.textContent='ADMIN'; left.appendChild(d); }
  if(isPaid()){ const d=document.createElement('div'); d.className='badge'; d.textContent='PAID'; left.appendChild(d); }
}

function toggleAdminUI(){
  if(isAdmin()){
    $("btn-export").classList.remove('hidden'); $("btn-import").classList.remove('hidden'); $("delete-all-btn").classList.remove('hidden');
    $("session-aside").classList.remove('hidden');
  } else {
    $("btn-export").classList.add('hidden'); $("btn-import").classList.add('hidden'); $("delete-all-btn").classList.add('hidden');
    // normal users cannot use session builder ‚Äî only paid or admin
    if(isPaid()) $("session-aside").classList.remove('hidden'); else $("session-aside").classList.add('hidden');
  }
  renderList(); renderSessions(); updateSessionLock();
}
function updateSessionLock(){ const locked = (!isPaid() && !isAdmin()); $("save-session").disabled = locked; $("add-selected").disabled = locked; $("session-lock-info").style.display = locked ? "block" : "none"; }

/* ---------- Video metadata & analysis helpers ---------- */
async function fetchVideoMetadata(link){
  try{
    const yt = extractYouTubeId(link);
    if(yt){
      const r = await fetch(`https://www.youtube.com/oembed?url=${encodeURIComponent(link)}&format=json`);
      if(r.ok){ const j = await r.json(); return { title: j.title||'', description: j.author_name||'' }; }
    }
    const r2 = await fetch(`https://noembed.com/embed?url=${encodeURIComponent(link)}`);
    if(r2.ok){ const j2 = await r2.json(); return { title: j2.title||'', description: j2.author_name||'' }; }
  }catch(e){ console.warn('meta fetch fail', e); }
  return null;
}
function extractYouTubeId(url){ try{ const u = new URL(url); if(u.hostname.includes('youtu.be')) return u.pathname.slice(1); if(u.hostname.includes('youtube.com')){ const p = u.searchParams.get('v'); if(p) return p; const parts = u.pathname.split('/'); const idx = parts.indexOf('embed'); if(idx>-1 && parts[idx+1]) return parts[idx+1]; } }catch(e){} return null; }

function analyzeTextToFields(title, description){
  const text = (title + " " + description).toLowerCase();
  const suggestions = {};
  const catMap = { "Bandeja":["bandeja"], "Chiquita":["chiquita"], "Vibora":["vibora"], "Serve":["serve"], "Smash":["smash"], "Lob":["lob"], "Defense":["defend","defense"], "Volley":["volley"], "Groundstroke":["forehand","backhand"] };
  for(const c in catMap){ for(const k of catMap[c]) if(text.includes(k)){ suggestions.category = c; break; } if(suggestions.category) break; }
  if(text.match(/\bbeginner|begynder\b/)) suggestions.level='Beginner';
  else if(text.match(/\bintermediate|mellem|√∏vet\b/)) suggestions.level='Intermediate';
  else if(text.match(/\badvanced|avanceret|pro\b/)) suggestions.level='Advanced';
  const pm = text.match(/\b(1|2|3|4|1-2|1-3|1-4|2-4)\b/); if(pm) suggestions.players = pm[0];
  if(text.match(/\b(high|intense|intensiv|h√•rd)\b/)) suggestions.intensity='High'; else if(text.match(/\b(medium|moderat)\b/)) suggestions.intensity='Medium'; else suggestions.intensity='Low';
  const words = text.replace(/[^\w√¶√∏√•√Ü√ò√Ö]/g," ").split(/\s+/).filter(w=>w.length>3);
  const stop = new Set(["video","padel","drill","exercise","howto","tutorial","padelvideo","learn"]);
  const tags=[]; for(const w of words){ if(!stop.has(w) && !tags.includes(w)) tags.push(w); if(tags.length>=6) break; }
  suggestions.tags = tags.slice(0,6).join(", ");
  if(!suggestions.category && tags.length) suggestions.category = tags[0].charAt(0).toUpperCase()+tags[0].slice(1);
  return suggestions;
}

/* ---------- Backup (admin only) ---------- */
function exportData(){
  if(!isAdmin()){ alert('Only admin can export backups'); return; }
  const payload = { exercises: JSON.parse(localStorage.getItem(EX_KEY) || "[]"), sessions: JSON.parse(localStorage.getItem(SES_KEY) || "[]"), categories: JSON.parse(localStorage.getItem(CAT_KEY) || "null") || [], levels: JSON.parse(localStorage.getItem(LVL_KEY) || "null") || [], intensities: JSON.parse(localStorage.getItem(INT_KEY) || "null") || [], players: JSON.parse(localStorage.getItem(PLR_KEY) || "null") || [] };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `lezgo-backup-${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function importDataFile(file){
  if(!isAdmin()){ alert('Only admin can import backups'); return; }
  const reader = new FileReader(); reader.onload = (e)=>{ try{ const data = JSON.parse(e.target.result); if(!confirm('Restore backup? This will overwrite local data.')) return; if(data.exercises) localStorage.setItem(EX_KEY, JSON.stringify(data.exercises)); if(data.sessions) localStorage.setItem(SES_KEY, JSON.stringify(data.sessions)); if(data.categories) localStorage.setItem(CAT_KEY, JSON.stringify(data.categories)); if(data.levels) localStorage.setItem(LVL_KEY, JSON.stringify(data.levels)); if(data.intensities) localStorage.setItem(INT_KEY, JSON.stringify(data.intensities)); if(data.players) localStorage.setItem(PLR_KEY, JSON.stringify(data.players)); alert('Imported - reloading app'); location.reload(); }catch(err){ alert('Import failed: invalid JSON'); } }; reader.readAsText(file);
}

/* ---------- Start ---------- */
init();

/* ---------- Debug console ---------- */
console.log('LezGo loaded. Admin?', isAdmin(), 'Paid?', isPaid());
</script>
</body>
</html>
